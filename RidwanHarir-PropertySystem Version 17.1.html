<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ridwan Harir's Property Management System</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%238E1616;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%236b0f0f;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='32' fill='url(%23grad)'/%3E%3Cg fill='%23F8EEDF'%3E%3Cpath d='M 32 16 L 48 28 L 16 28 Z'/%3E%3Crect x='20' y='28' width='24' height='20' rx='1'/%3E%3Crect x='28' y='36' width='8' height='12' fill='%238E1616'/%3E%3Crect x='38' y='32' width='4' height='4' fill='%236b0f0f'/%3E%3Crect x='22' y='32' width='4' height='4' fill='%236b0f0f'/%3E%3C/g%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* NEW COLOR SCHEME - CREAM PRIMARY / RED SECONDARY */
            --primary-black: #000000;         /* Pure black */
            --primary-red: #8E1616;           /* Dark red rgb(142, 22, 22) */
            --primary-tan: #E8C999;           /* Tan rgb(232, 201, 153) */
            --primary-cream: #F8EEDF;         /* Light cream rgb(248, 238, 223) */
            
            /* Variations for depth */
            --dark-red: #6b0f0f;              /* Darker red */
            --light-red: #b31d1d;             /* Lighter red */
            --dark-tan: #d4b485;              /* Darker tan */
            --light-tan: #f0d6ae;             /* Lighter tan */
            --dark-cream: #e8dcc8;            /* Darker cream */
            --light-cream: #fffbf5;           /* Lighter cream */
            
            /* NEW LIGHT BACKGROUNDS - Cream based */
            --dark-bg: #F8EEDF;               /* Primary cream */
            --medium-bg: #f0e4d1;             /* Slightly darker cream */
            --light-bg: #fffbf5;              /* Lighter cream */
            --card-bg: #ffffff;               /* White cards */
            
            /* Text colors - Dark for light backgrounds */
            --text-white: #ffffff;            /* Pure white */
            --text-light: #2d1515;            /* Dark brown text */
            --text-grey: #6b5544;             /* Muted brown-grey */
            --text-dark: #1a0a0a;             /* Very dark text */
            
            /* Borders and accents */
            --border-grey: #d4b485;           /* Tan border */
            --hover-bg: #e8dcc8;              /* Hover - darker cream */
            
            /* Status colors */
            --success-green: #10b981;         /* Success green */
            --warning-yellow: #f59e0b;        /* Warning yellow */
            --danger-red: #8E1616;            /* Danger red (from palette) */
            
            /* Legacy mappings for compatibility */
            --primary-orange: var(--primary-red);
            --secondary-orange: var(--dark-red);
            --secondary-red: var(--dark-red);
            --primary-blue: var(--primary-red);
            --secondary-blue: var(--dark-red);
            --dark-blue: var(--dark-red);
            --light-blue: var(--primary-tan);
            --dark-navy: var(--dark-bg);
            --medium-navy: var(--medium-bg);
            --light-navy: var(--light-bg);
            --rose-red: var(--light-red);
            --burgundy: var(--dark-red);
            --sky-blue: var(--primary-tan);
            --royal-blue: var(--primary-red);
            --text-muted: var(--text-grey);
            --border-color: var(--border-grey);
            --primary-color: var(--primary-cream);
            --secondary-color: var(--primary-red);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        #login-screen.hidden {
            display: none;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 420px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }
        
        .login-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            font-size: 14px;
            color: #666;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }
        
        .input-with-icon input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .input-with-icon input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.5);
        }
        
        .login-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
            border-left: 4px solid #c33;
        }
        
        .login-error.show {
            display: block;
        }
        
        /* User Menu Styles */
        .user-menu {
            position: relative;
            display: inline-block;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-red);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            border: 2px solid var(--dark-red);
        }
        
        .user-avatar:hover {
            background: var(--dark-red);
            border-color: var(--primary-red);
        }
        
        .user-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 220px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .user-dropdown.show {
            display: block;
            animation: dropdownSlide 0.3s ease;
        }
        
        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-dropdown-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-dropdown-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .user-dropdown-role {
            font-size: 12px;
            color: var(--primary-orange);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }
        
        .user-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-size: 14px;
        }
        
        .user-dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .user-dropdown-item i {
            color: var(--primary-orange);
            width: 20px;
        }
        
        .user-dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 5px 0;
        }
        
        .user-dropdown-item.danger {
            color: #e74c3c;
        }
        
        .user-dropdown-item.danger i {
            color: #e74c3c;
        }
        
        /* Staff Management Modal */
        .staff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .staff-modal.show {
            display: flex;
        }
        
        .staff-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .staff-modal-header {
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }
        
        .staff-modal-header h2 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .staff-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .staff-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .staff-modal-body {
            padding: 30px;
        }
        
        .staff-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .staff-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .staff-tab.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
        }
        
        .staff-tab-content {
            display: none;
        }
        
        .staff-tab-content.active {
            display: block;
        }
        
        .staff-list {
            display: grid;
            gap: 15px;
        }
        
        .staff-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .staff-card:hover {
            border-color: var(--primary-orange);
            transform: translateX(5px);
        }
        
        .staff-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .staff-info {
            flex: 1;
        }
        
        .staff-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .staff-email {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .staff-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #999;
        }
        
        .staff-role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .staff-role-badge.admin {
            background: #fee;
            color: #c33;
        }
        
        .staff-role-badge.manager {
            background: #fef3e0;
            color: #d97706;
        }
        
        .staff-role-badge.staff {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .staff-actions {
            display: flex;
            gap: 8px;
        }
        
        .staff-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .staff-action-btn.edit {
            background: var(--primary-orange);
            color: white;
        }
        
        .staff-action-btn.delete {
            background: #fee;
            color: #c33;
        }
        
        .staff-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .create-account-form {
            display: grid;
            gap: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--primary-cream);
            color: var(--text-dark);
            overflow: hidden;
        }
        
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        body.fullscreen-mode .right-panel {
            grid-column: 1 / -1;
        }
        body.left-fullscreen-mode {
            grid-template-columns: 1fr 0px 0px;
        }
        body.left-fullscreen-mode #header {
            display: none;
        }
        body.left-fullscreen-mode .right-panel,
        body.left-fullscreen-mode #map-container {
            display: none;
        }
        body.left-fullscreen-mode .left-panel {
            grid-column: 1 / -1;
        }
        #header {
            grid-column: 1 / -1;
            background: var(--primary-cream);
            border-bottom: 3px solid var(--primary-red);
            color: var(--text-dark);
            padding: 15px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
            overflow: hidden;
        }
        
        /* Animated decorative elements for header */
        #header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 10% 50%, rgba(142, 22, 22, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 90% 50%, rgba(142, 22, 22, 0.08) 0%, transparent 25%);
            pointer-events: none;
        }
        
        /* Animated pulse effect */
        @keyframes headerPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* Animated accent dots */
        .header-accent {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--primary-red);
            border-radius: 50%;
            opacity: 0.3;
            animation: headerPulse 3s ease-in-out infinite;
        }
        
        .header-accent:nth-child(1) { top: 15%; left: 5%; animation-delay: 0s; }
        .header-accent:nth-child(2) { top: 70%; left: 8%; animation-delay: 0.5s; }
        .header-accent:nth-child(3) { top: 30%; left: 15%; animation-delay: 1s; width: 6px; height: 6px; }
        .header-accent:nth-child(4) { top: 60%; right: 5%; animation-delay: 1.5s; }
        .header-accent:nth-child(5) { top: 20%; right: 10%; animation-delay: 2s; width: 10px; height: 10px; }
        .header-accent:nth-child(6) { top: 75%; right: 15%; animation-delay: 2.5s; width: 5px; height: 5px; }
        
        /* Animated logo icon */
        #header .logo-icon {
            animation: floatAnimation 3s ease-in-out infinite;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 i { font-size: 26px; }
        #legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .legend-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .sidebar {
            background: var(--primary-cream);
            overflow-y: auto;
            overflow-x: hidden;
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 15px rgba(0,0,0,0.08);
            position: relative;
            transition: all 0.3s ease;
            min-width: 280px;
            max-width: 800px;
            flex-shrink: 0;
        }
        
        #left-sidebar {
            flex-basis: 380px;
            width: 380px;
        }
        
        #right-sidebar {
            flex-basis: 450px;
            width: 450px;
            border-right: none;
            border-left: 1px solid var(--border-color);
        }
        
        .sidebar.collapsed {
            flex-basis: 0 !important;
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
            border: none;
        }
        
        /* Resize handles for sidebars */
        .resize-handle-vertical {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: ew-resize;
            z-index: 10;
            transition: background 0.2s;
        }
        
        .resize-handle-vertical:hover {
            background: rgba(37, 99, 235, 0.3);
        }
        
        .resize-handle-vertical::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 50px;
            background: var(--primary-red);
            border-radius: 2px;
            left: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .resize-handle-vertical:hover::before {
            opacity: 1;
        }
        
        #left-sidebar .resize-handle-vertical {
            right: -3px;
        }
        
        #right-sidebar .resize-handle-vertical {
            left: -3px;
        }
        
        #map-container {
            flex: 1;
            min-width: 100%;
            width: 100%;
            position: relative;
            background: var(--dark-cream);
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: var(--dark-cream);
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 4px;
        }
        /* OLD SIDEBAR TOGGLES - HIDDEN */
        .sidebar-toggle {
            display: none !important;
        }
        
        /* ==================== FIXED MODAL TRIGGER BUTTONS ==================== */
        .fixed-panel-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 120px;
            background: var(--primary-red);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(142, 22, 22, 0.5);
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        .fixed-panel-btn:hover {
            width: 60px;
            background: var(--dark-red);
            box-shadow: 0 6px 25px rgba(142, 22, 22, 0.7);
        }
        
        .fixed-panel-btn i {
            font-size: 18px;
            writing-mode: horizontal-tb;
        }
        
        .fixed-panel-btn.left {
            left: 0;
            border-radius: 0 12px 12px 0;
        }
        
        .fixed-panel-btn.right {
            right: 0;
            border-radius: 12px 0 0 12px;
            writing-mode: vertical-lr;
        }
        
        /* ==================== MODAL OVERLAY ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ==================== MODAL SLIDE PANELS ==================== */
        .modal-panel {
            position: fixed;
            top: 0;
            height: 100%;
            width: 550px;
            max-width: 95vw;
            background: var(--primary-cream);
            z-index: 10000;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 50px rgba(0,0,0,0.2);
            resize: horizontal;
            min-width: 350px;
        }
        
        .modal-panel.left {
            left: 0;
            transform: translateX(-100%);
            border-right: 3px solid var(--primary-red);
        }
        
        .modal-panel.left.active {
            transform: translateX(0);
        }
        
        .modal-panel.right {
            right: 0;
            transform: translateX(100%);
            border-left: 3px solid var(--primary-red);
        }
        
        .modal-panel.right.active {
            transform: translateX(0);
        }
        
        /* Resize handle indicator */
        .modal-panel.left::after {
            content: '⋮';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--primary-red);
            opacity: 0.5;
            pointer-events: none;
        }
        
        .modal-panel.right::before {
            content: '⋮';
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--primary-red);
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* ==================== MODAL PANEL HEADER ==================== */
        .modal-panel-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .modal-panel-header h2 {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            color: white !important;
        }
        
        .modal-panel-header h2 i {
            font-size: 22px;
            color: var(--primary-tan) !important;
        }
        
        .modal-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .modal-expand-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white !important;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-expand-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
        }
        
        .modal-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            color: white !important;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.5);
            transform: rotate(90deg);
        }
        
        /* Expanded panel state */
        .modal-panel.expanded {
            width: 80vw !important;
            max-width: 1200px !important;
        }
        
        /* ==================== MODAL PANEL CONTENT ==================== */
        .modal-panel-content {
            padding: 0;
            background: var(--primary-cream);
        }
        
        /* FORCE ALL TEXT IN MODAL TO BE DARK */
        .modal-panel-content,
        .modal-panel-content * {
            color: var(--text-dark) !important;
        }
        
        /* ====== VIEWING CARDS EXCEPTION - WHITE TEXT ON RED ====== */
        .modal-panel-content .viewing-card,
        .modal-panel-content .viewing-card *,
        .modal-panel-content [style*="linear-gradient"][style*="8E1616"],
        .modal-panel-content [style*="linear-gradient"][style*="8E1616"] * {
            color: white !important;
        }
        
        .modal-panel-content .viewing-card {
            background: linear-gradient(135deg, #8E1616 0%, #6b0f0f 100%) !important;
        }
        
        .modal-panel-content .viewing-card h4,
        .modal-panel-content .viewing-card span,
        .modal-panel-content .viewing-card p,
        .modal-panel-content .viewing-card div,
        .modal-panel-content .viewing-card label {
            color: white !important;
        }
        
        .modal-panel-content .viewing-card strong {
            color: #E8C999 !important;
        }
        
        /* Except for active buttons which need white */
        .modal-panel-content .tab-btn.active,
        .modal-panel-content .sidebar-tab.active,
        .modal-panel-content .filter-chip.active,
        .modal-panel-content .amenity-btn.active {
            color: white !important;
        }
        
        /* Fix inputs */
        .modal-panel-content input,
        .modal-panel-content select,
        .modal-panel-content textarea {
            background: white !important;
            color: var(--text-dark) !important;
            border: 2px solid var(--border-grey) !important;
        }
        
        .modal-panel-content input::placeholder {
            color: var(--text-grey) !important;
        }
        
        /* Fix section backgrounds */
        .modal-panel-content .eligibility-section,
        .modal-panel-content .tab-pane,
        .modal-panel-content .sidebar-content {
            background: var(--primary-cream) !important;
        }
        
        .modal-panel-content .eligibility-form,
        .modal-panel-content .section-card {
            background: white !important;
            border: 1px solid var(--border-grey) !important;
        }
        
        /* Fix property items */
        .modal-panel-content .property-item,
        .modal-panel-content .property-card {
            background: white !important;
            border: 1px solid var(--border-grey) !important;
        }
        
        .modal-panel-content .property-item:hover {
            background: var(--light-cream) !important;
        }
        
        /* Badges need colored backgrounds */
        .modal-panel-content .viewing-badge,
        .modal-panel-content .virtual-badge,
        .modal-panel-content .gender-badge,
        .modal-panel-content [class*="badge"] {
            color: white !important;
        }
        
        /* Fix stats cards */
        .modal-panel-content .big-stat-card,
        .modal-panel-content .stat-card {
            background: white !important;
            border: 1px solid var(--border-grey) !important;
        }
        
        .modal-panel-content .stat-icon {
            color: var(--primary-red) !important;
        }
        
        /* Ensure cloned sidebar-tabs look good in modal */
        .modal-panel-content .sidebar-tabs {
            display: flex;
            background: white !important;
            border-bottom: 2px solid var(--primary-red);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .modal-panel-content .sidebar-tab {
            flex: 1;
            padding: 15px 10px;
            background: transparent !important;
            border: none;
            color: var(--text-grey) !important;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .modal-panel-content .sidebar-tab:hover {
            background: var(--light-cream) !important;
            color: var(--primary-red) !important;
        }
        
        .modal-panel-content .sidebar-tab.active {
            background: var(--primary-red) !important;
            color: white !important;
        }
        
        .modal-panel-content .sidebar-tab.active i {
            color: white !important;
        }
        
        .modal-panel-content .sidebar-tab i {
            font-size: 18px;
        }
        
        /* Ensure cloned sidebar-content looks good */
        .modal-panel-content .sidebar-content {
            padding: 0;
        }
        
        .modal-panel-content .tab-pane {
            display: none;
            padding: 20px;
        }
        
        .modal-panel-content .tab-pane.active {
            display: block;
        }
        
        /* Fix tab buttons in clients panel */
        .modal-panel-content .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .modal-panel-content .tab-btn {
            flex: 1 1 calc(33.333% - 6px);
            min-width: 80px;
            padding: 10px 8px;
            font-size: 11px;
            background: white !important;
            color: var(--primary-red) !important;
            border: 2px solid var(--primary-red) !important;
        }
        
        .modal-panel-content .tab-btn.active {
            background: var(--primary-red) !important;
            color: white !important;
        }
        
        /* Ensure eligibility-section takes full width */
        .modal-panel-content .eligibility-section {
            padding: 15px;
        }
        
        .modal-panel-content .eligibility-form {
            margin-bottom: 15px;
        }
        
        /* Form section headers */
        .modal-panel-content .form-section h3 {
            color: var(--text-dark) !important;
            border-bottom-color: var(--primary-red) !important;
        }
        
        .modal-panel-content .form-section h3 i {
            color: var(--primary-red) !important;
        }
        
        /* Filter chips */
        .modal-panel-content .filter-chip {
            background: white !important;
            color: var(--text-dark) !important;
            border: 2px solid var(--border-grey) !important;
        }
        
        .modal-panel-content .filter-chip.active {
            background: var(--primary-red) !important;
            color: white !important;
            border-color: var(--primary-red) !important;
        }
        
        /* Search box */
        .modal-panel-content .search-box input {
            background: white !important;
            color: var(--text-dark) !important;
        }
        
        /* Available/Taken badges in property cards */
        .modal-panel-content .status-available {
            background: #10b981 !important;
            color: white !important;
        }
        
        .modal-panel-content .status-taken {
            background: #ef4444 !important;
            color: white !important;
        }
        
        /* Hide original sidebars visually - content will be cloned to modals */
        #left-sidebar,
        #right-sidebar {
            position: absolute !important;
            left: -9999px !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Modal Panel Scrollbar Styles */
        .modal-panel::-webkit-scrollbar {
            width: 8px;
        }
        .modal-panel::-webkit-scrollbar-track {
            background: var(--dark-cream);
        }
        .modal-panel::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 4px;
        }
        .modal-panel::-webkit-scrollbar-thumb:hover {
            background: var(--light-red);
        }
        
        /* Responsive Modal Panels */
        @media (max-width: 500px) {
            .modal-panel {
                width: 100%;
                max-width: 100%;
            }
            
            .fixed-panel-btn {
                width: 45px;
                height: 100px;
                font-size: 10px;
            }
            
            .fixed-panel-btn i {
                font-size: 16px;
            }
        }
        
        /* Floating Menu System - REMOVED GIANT BAR */
        /* This was the massive blue bar at the bottom - now disabled */
        .floating-menu.old-bar {
            display: none !important;
        }
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
            transform: translateX(-50%) translateY(-2px);
        }
        .menu-btn-OLD-DISABLED {
            display: none;
        }
        .menu-divider-OLD-DISABLED {
            display: none;
        }
        .menu-label-OLD-DISABLED {
            display: none;
        }
        .resize-toggle {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            z-index: 101;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .resize-toggle:hover {
            background: #5568d3;
        }
        #map { width: 100%; height: 100%; z-index: 1; position: relative; }
        
        .map-style-btn {
            padding: 12px 16px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-dark);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .map-style-btn:hover {
            background: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
            transform: scale(1.05);
        }
        
        .map-style-btn.active {
            border-color: var(--primary-red);
            background: rgba(142, 22, 22, 0.1);
            color: var(--primary-red);
        }
        
        /* Enhanced Leaflet Popup Styles - BLUE THEME */
        .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red) 100%) !important;
            border: 3px solid var(--primary-tan) !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4) !important;
            padding: 0 !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            color: white !important;
            font-weight: 500 !important;
        }
        
        .leaflet-popup-content button {
            transition: all 0.3s ease !important;
        }
        
        .leaflet-popup-content button:hover {
            background: var(--primary-tan) !important;
            color: white !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }
        
        .leaflet-popup-tip {
            background: var(--primary-red) !important;
            border: 3px solid var(--primary-tan) !important;
            border-top: none !important;
            border-right: none !important;
        }
        
        .leaflet-container a.leaflet-popup-close-button {
            color: white !important;
            font-size: 24px !important;
            padding: 8px 12px !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
        }
        
        .leaflet-container a.leaflet-popup-close-button:hover {
            color: var(--primary-tan) !important;
            transform: scale(1.2) !important;
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--card-bg);
            border-bottom: 2px solid var(--primary-red);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        .sidebar-header h2 i {
            color: var(--primary-red);
        }
        .tab-buttons { display: flex; gap: 8px; margin-top: 10px; }
        .tab-btn {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--primary-red);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            background: white;
            color: var(--primary-red);
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .tab-btn:hover { 
            background: var(--primary-tan); 
            color: var(--text-dark);
            border-color: var(--primary-tan);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 22, 22, 0.2);
        }
        .tab-btn.active { 
            background: var(--primary-red); 
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 12px rgba(142, 22, 22, 0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .filter-buttons { display: flex; gap: 8px; margin-top: 10px; }
        .filter-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: var(--primary-orange);
            color: white;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #5568d3; transform: translateY(-1px); }
        .filter-btn.active { background: var(--secondary-orange); }
        .borough-group { margin-bottom: 0; }
        .borough-header {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .borough-header:hover { background: #f8f9fa; }
        .borough-header .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s ease;
            font-size: 12px;
            color: var(--primary-orange);
        }
        .borough-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .borough-properties {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .borough-properties.collapsed {
            max-height: 0;
        }
        .borough-count {
            margin-left: auto;
            font-size: 12px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .property-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid transparent;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .property-item:hover {
            background: var(--light-cream);
            border-left-color: var(--primary-red);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .property-item.taken { opacity: 0.5; background: var(--dark-cream); }
        .property-item.has-viewing { border-left: 4px solid #2ecc71; }
        .property-item.women-only {
            border-left: 4px solid #ff69b4;
        }
        
        /* Fix text contrast for dark backgrounds */
        .property-item .property-name,
        .property-item .property-address,
        .property-item .property-details {
            color: var(--text-dark) !important;
        }
        
        /* Viewing cards with dark red background need white text */
        .viewing-card,
        [style*="background: var(--primary-red)"],
        [style*="background: linear-gradient(135deg, var(--primary-red)"] {
            color: white !important;
        }
        
        .viewing-card * {
            color: white !important;
        }
        
        .viewing-card .viewing-label {
            color: rgba(255,255,255,0.8) !important;
        }
        .checkbox-wrapper { margin-top: 2px; }
        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-orange);
        }
        .property-details { flex: 1; padding-right: 60px; }
        .property-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 6px;
        }
        .property-name-link {
            font-size: 12px;
            color: var(--primary-orange);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }
        .property-name-link:hover {
            color: #5568d3;
            text-decoration: underline;
        }
        .property-address { font-size: 12px; color: #666; }
        .property-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 11px;
            color: var(--primary-orange);
            text-decoration: none;
        }
        .property-link:hover { text-decoration: underline; }
        .viewing-badge {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 6px;
            font-weight: 500;
        }
        .virtual-badge {
            display: inline-block;
            background: #8E1616;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 6px;
            margin-left: 5px;
            font-weight: 500;
        }
        .gender-badge {
            display: inline-block;
            background: #ff69b4;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 6px;
            font-weight: 500;
            margin-left: 5px;
        }
        .book-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .book-btn:hover { background: #5568d3; }
        .eligibility-section { 
            padding: 20px;
            background: var(--primary-cream);
        }
        .eligibility-form {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid var(--border-grey);
        }
        .form-section { margin-bottom: 25px; }
        .form-section h3 {
            font-size: 17px;
            color: var(--text-dark) !important;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-red);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        .form-section h3 i {
            color: var(--primary-red);
            font-size: 19px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-dark) !important;
            background: transparent;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-grey);
            border-radius: 8px;
            font-size: 14px;
            background: var(--light-cream);
            color: var(--text-dark);
        }
        .form-group input::placeholder,
        .form-group select option {
            color: var(--text-grey);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(142, 22, 22, 0.15);
            background: white;
        }
        
        /* Amenity Buttons */
        .amenity-btn {
            padding: 12px 10px;
            background: var(--light-cream);
            color: var(--text-dark);
            border: 2px solid var(--border-grey);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .amenity-btn:hover {
            background: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(142, 22, 22, 0.3);
        }
        
        .amenity-btn.active {
            background: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
        }
        
        .amenity-btn i {
            font-size: 16px;
        }
            background: var(--medium-bg);
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark) !important;
            font-weight: 500;
        }
        .radio-label input { width: auto; cursor: pointer; }
        .benefit-checkboxes { display: grid; gap: 10px; margin-top: 8px; }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--dark-bg);
            border: 2px solid var(--border-grey);
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }
        .checkbox-label:hover {
            background: var(--medium-bg);
            border-color: var(--primary-red);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .checkbox-label:hover { background: #e9ecef; }
        .checkbox-label input { width: auto; cursor: pointer; }
        .check-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .check-btn:hover { background: #5568d3; }
        .result-card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result-card.eligible { border-left: 4px solid #2ecc71; }
        .result-card.ineligible { border-left: 4px solid #e74c3c; }
        .result-card.review { border-left: 4px solid #f39c12; }
        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .result-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .result-icon.eligible { background: #d4edda; color: #2ecc71; }
        .result-icon.ineligible { background: #f8d7da; color: #e74c3c; }
        .result-icon.review { background: #fff3cd; color: #f39c12; }
        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .result-subtitle { font-size: 13px; color: #666; }
        .result-details { margin-top: 15px; }
        .detail-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .upfront-costs-card {
            margin-top: 10px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            color: white;
            border-radius: 8px;
        }
        .upfront-costs-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
        }
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .cost-row:last-child { border-bottom: none; font-weight: 600; font-size: 16px; }
        .requirements-list {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .requirements-list h4 {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
        }
        .requirements-list ul { list-style: none; padding: 0; }
        .requirements-list li {
            padding: 6px 0;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: start;
            gap: 8px;
        }
        .requirements-list li:before {
            content: "•";
            color: var(--primary-orange);
            font-weight: bold;
            font-size: 16px;
        }
        .calendar-section {
            padding: 20px;
            background: linear-gradient(135deg, var(--medium-bg) 0%, var(--card-bg) 100%);
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid var(--border-grey);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-header h3 { 
            font-size: 18px; 
            color: white;
            font-weight: 700;
        }
        .nav-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .nav-btn:hover { 
            background: var(--primary-tan);
            transform: scale(1.05);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-tan);
            padding: 8px;
        }
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--dark-bg);
            color: white;
            position: relative;
            border: 2px solid var(--border-grey);
        }
        .day-cell:hover { 
            background: var(--medium-bg);
            border-color: var(--primary-red);
            transform: scale(1.05);
        }
        .day-cell.selected {
            background: var(--primary-red);
            color: white;
            font-weight: 700;
            border-color: var(--primary-tan);
        }
        .day-cell.has-viewings {
            background: var(--success-green);
            border: 2px solid var(--primary-tan);
        }
        .day-cell.other-month { 
            color: var(--text-grey);
            opacity: 0.5;
        }
        .day-cell.today { 
            border: 3px solid var(--warning-yellow);
            font-weight: 700;
        }
        .viewing-count {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--warning-yellow);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 16px;
            height: 14px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .time-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-height: 350px;
            overflow-y: auto;
            padding: 10px;
        }
        .time-slot {
            padding: 10px;
            background: var(--dark-bg);
            border: 2px solid var(--border-grey);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 600;
            color: white;
        }
        .time-slot:hover { 
            background: var(--medium-bg);
            border-color: var(--primary-red);
            transform: scale(1.05);
        }
        .time-slot.selected {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-tan);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
        .time-slot.booked {
            background: var(--danger-red);
            color: white;
            cursor: not-allowed;
            border-color: var(--danger-red);
            opacity: 0.6;
        }
        .booking-form {
            padding: 20px;
            background: var(--dark-bg);
            border-radius: 10px;
            border: 2px solid var(--border-grey);
        }
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--success-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .submit-btn:hover { 
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        .submit-btn:disabled { 
            background: var(--text-grey);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .viewings-list { 
            padding: 20px;
            background: var(--primary-cream);
        }
        .viewing-card {
            background: linear-gradient(135deg, #8E1616 0%, #6b0f0f 100%) !important;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success-green);
            box-shadow: 0 4px 12px rgba(142, 22, 22, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        .viewing-card,
        .viewing-card *,
        .viewing-card h4,
        .viewing-card span,
        .viewing-card p,
        .viewing-card div,
        .viewing-card label {
            color: white !important;
        }
        .viewing-card.virtual {
            border-left-color: var(--primary-tan);
        }
        .viewing-card:hover {
            box-shadow: 0 6px 20px rgba(142, 22, 22, 0.5);
            transform: translateY(-3px);
            border-left-width: 6px;
        }
        .viewing-card h4 {
            font-size: 16px;
            color: white !important;
            margin-bottom: 12px;
            font-weight: 700;
        }
        .viewing-info {
            font-size: 14px;
            color: white !important;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .viewing-info strong,
        .viewing-card strong { 
            color: #E8C999 !important;
            font-weight: 700;
        }
        .viewing-card button {
            color: white !important;
        }
        .cancel-btn {
            margin-top: 10px;
            padding: 5px 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        .cancel-btn:hover { background: #c0392b; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .stats-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            flex: 1;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .info-tooltip {
            display: inline-block;
            margin-left: 5px;
            color: #ddd;
            cursor: help;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
        }
        .suggested-properties {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .suggested-properties h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggestion-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        .suggestion-item:hover {
            background: #e9ecef;
            border-color: var(--primary-orange);
        }
        .suggestion-item.perfect {
            border-left: 4px solid #2ecc71;
            background: #f0fdf4;
        }
        .suggestion-item.low-shortfall {
            border-left: 4px solid #fbbf24;
            background: #fffbeb;
        }
        .suggestion-item.high-shortfall {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .suggestion-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        .suggestion-rent {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-orange);
        }
        .suggestion-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .suggestion-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
        }
        .suggestion-actions {
            display: flex;
            gap: 8px;
        }
        .quick-book-btn {
            flex: 1;
            padding: 6px 10px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-book-btn:hover { background: #27ae60; }
        .view-details-btn {
            flex: 1;
            padding: 6px 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-details-btn:hover { background: #5568d3; }
        .suggestion-badge {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .suggestion-badge.perfect { background: #2ecc71; }
        .suggestion-badge.low-shortfall {
            background: #fbbf24;
            color: #78350f;
        }
        .suggestion-badge.high-shortfall { background: #ef4444; }
        .toast-notification {
            position: fixed;
            top: 90px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            z-index: 10001;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid #2ecc71;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-notification.error { border-left-color: #e74c3c; }
        .toast-notification .toast-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        .toast-notification .toast-body {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        .toast-icon { font-size: 20px; }
        .toast-icon.success { color: #2ecc71; }
        .toast-icon.error { color: #e74c3c; }
        .viewings-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .sort-btn {
            flex: 1;
            padding: 6px 10px;
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sort-btn:hover { background: #5568d3; }
        .sort-btn.active { background: var(--secondary-orange); }
        .action-btn-group {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .export-btn {
            background: #8E1616;
            color: white;
        }
        .export-btn:hover { background: #6b0f0f; }
        .flush-btn {
            background: #f39c12;
            color: white;
        }
        .flush-btn:hover { background: #e67e22; }
        .clear-btn {
            background: #e74c3c;
            color: white;
        }
        .clear-btn:hover { background: #c0392b; }
    
        /* Property Management Styles */
        .property-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .property-item:hover .property-actions {
            opacity: 1;
        }
        .property-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }
        .edit-btn {
            background: #8E1616;
            color: white;
        }
        .edit-btn:hover {
            background: #6b0f0f;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .add-property-btn {
            width: 100%;
            padding: 10px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .add-property-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
            position: relative;
            z-index: 100000;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .modal-header h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 25px;
        }
        
        /* Modal form overrides - dark text on white background */
        .modal-body .form-group label,
        .modal-body label {
            color: #333 !important;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        
        .modal-body .form-group input,
        .modal-body .form-group select,
        .modal-body .form-group textarea {
            background: white !important;
            color: #333 !important;
            border: 2px solid #e0e0e0 !important;
        }
        
        .modal-body .form-group input:focus,
        .modal-body .form-group select:focus,
        .modal-body .form-group textarea:focus {
            border-color: var(--primary-red) !important;
            background: #f8f9fa !important;
        }
        
        .modal-body small {
            color: #666 !important;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #2ecc71;
            color: white;
        }
        .btn-primary:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        /* Property Status Badges */
        .status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .status-badge.available {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        .status-badge.viewing {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-orange));
            color: white;
        }
        .status-badge.taken {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        .status-badge.maintenance {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        /* History Button */
        .history-btn {
            position: relative;
            background: #8E1616 !important;
        }
        .history-btn:hover {
            background: #6b0f0f !important;
        }
        .history-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        /* Property Item Enhanced */
        .property-item.prop-taken {
            opacity: 0.7;
            border-left: 4px solid #e74c3c;
        }
        
        /* Property Details Modal */
        .property-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        .property-detail-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        .property-detail-header {
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .property-detail-body {
            padding: 30px;
        }
        .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .detail-section:last-child {
            border-bottom: none;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        .detail-value {
            color: #333;
            font-weight: 600;
            text-align: right;
        }
        
        /* History Timeline */
        .history-timeline {
            position: relative;
            padding-left: 30px;
        }
        .history-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary-orange), #e0e0e0);
        }
        .history-item {
            position: relative;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-orange);
        }
        .history-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-orange);
        }
        .history-item.outcome-taken::before {
            border-color: #e74c3c;
            background: #e74c3c;
        }
        .history-item.outcome-completed::before {
            border-color: #2ecc71;
        }
        .history-item.outcome-cancelled::before {
            border-color: #95a5a6;
        }
        
        /* NEW TABBED SIDEBAR STYLES */
        .sidebar-tabs {
            display: flex;
            background: var(--light-navy);
            border-bottom: 2px solid var(--border-color);
            padding: 0;
            gap: 0;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 15px 10px;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        
        .sidebar-tab i {
            font-size: 18px;
        }
        
        .sidebar-tab:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-red);
        }
        
        .sidebar-tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .sidebar-content {
            height: calc(100vh - 64px);
            overflow-y: auto;
        }
        
        .tab-pane {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-pane-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .tab-pane-header i {
            font-size: 24px;
            color: var(--primary-red);
        }
        
        .tab-pane-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--text-light);
        }
        
        /* Big Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .big-stat-card {
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }
        
        .big-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .big-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .big-stat-card.total .stat-icon {
            background: rgba(52, 152, 219, 0.2);
            color: #8E1616;
        }
        
        .big-stat-card.available .stat-icon {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .big-stat-card.taken .stat-icon {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .big-stat-card.viewings .stat-icon {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }
        
        .big-stat-card .stat-info {
            flex: 1;
        }
        
        .big-stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-light);
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .big-stat-card .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-action-btn {
            padding: 12px;
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            background: var(--secondary-blue);
        }
        
        /* Section Card */
        .section-card {
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--text-dark);
            font-size: 13px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header i {
            color: var(--primary-red);
        }
        
        .borough-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 11px;
        }
        
        /* Add Property Form */
        .add-property-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group label i {
            color: var(--primary-red);
            width: 16px;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-red);
            background: var(--dark-navy);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .form-submit-btn {
            padding: 15px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .form-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
            background: #27ae60;
        }
        
        /* Browse Controls */
        .browse-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            color: var(--text-muted);
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 38px;
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        
        .filter-chips {
            display: flex;
            gap: 8px;
        }
        
        .filter-chip {
            flex: 1;
            padding: 10px;
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .filter-chip span {
            background: var(--dark-navy);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .filter-chip:hover {
            border-color: var(--primary-red);
            color: var(--text-light);
        }
        
        .filter-chip.active {
            background: var(--primary-red);
            border-color: var(--primary-red);
            color: white;
        }
        
        .filter-chip.active span {
            background: rgba(255,255,255,0.2);
        }
        
        .sort-select {
            width: 100%;
            padding: 12px;
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Properties Browse List */
        .properties-browse-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .property-browse-card {
            background: var(--light-navy);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .property-browse-card:hover {
            border-color: var(--primary-red);
            transform: translateX(5px);
        }
        
        .property-browse-card.taken {
            opacity: 0.6;
            border-left: 4px solid var(--danger-red);
        }
        
        .property-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .property-card-title {
            font-weight: 700;
            color: #e8e8e8;
            font-size: 15px;
            line-height: 1.3;
            flex: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .property-card-rent {
            font-weight: 700;
            color: var(--primary-red);
            font-size: 16px;
            white-space: nowrap;
            margin-left: 10px;
        }
        
        .property-card-address {
            font-size: 12px;
            color: #bbb;
            margin-bottom: 10px;
        }
        
        .property-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .property-meta-tag {
            padding: 4px 8px;
            background: var(--dark-navy);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .property-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .property-action-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }
        
        .property-action-btn.toggle {
            background: #e74c3c;
            color: white;
        }
        
        .property-action-btn.toggle.available {
            background: #2ecc71;
        }
        
        .property-action-btn.toggle:hover {
            background: #c0392b;
        }
        
        .property-action-btn.toggle.available:hover {
            background: #27ae60;
        }
        
        .property-action-btn.edit {
            background: var(--dark-navy);
            color: var(--text-light);
            border: 2px solid var(--border-color);
        }
        
        .property-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Age Legend Grid */
        .age-legend-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .age-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--dark-navy);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-light);
        }
        
        .age-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            flex-shrink: 0;
        }
        
        /* Custom Marker Animations */
        @keyframes pulse-green {
            0%, 100% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
        
        @keyframes pulse-yellow {
            0%, 100% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            50% {
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 10px rgba(245, 158, 11, 0);
            }
        }
        
        @keyframes pulse-red {
            0%, 100% {
                filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)) drop-shadow(0 0 0 0 rgba(239, 68, 68, 0.7));
            }
            50% {
                filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)) drop-shadow(0 0 0 10px rgba(239, 68, 68, 0));
            }
        }
        
        /* Marker hover effects */
        .custom-marker {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .custom-marker:hover {
            transform: scale(1.15);
            z-index: 1000 !important;
        }
        
    </style>
</head>

<body>
    <!-- Login Screen (Disabled) -->
    <div id="login-screen" class="hidden" style="display: none;">
    </div>
    
    <!-- Staff Management Modal -->
    <div class="staff-modal" id="staff-modal">
        <div class="staff-modal-content">
            <div class="staff-modal-header">
                <h2><i class="fas fa-users-cog"></i> Staff Management</h2>
                <button class="staff-close-btn" onclick="closeStaffModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="staff-modal-body">
                <div class="staff-tabs">
                    <button class="staff-tab active" onclick="switchStaffTab('view')">
                        <i class="fas fa-users"></i> All Staff
                    </button>
                    <button class="staff-tab" onclick="switchStaffTab('create')">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                    <button class="staff-tab" onclick="switchStaffTab('activity')">
                        <i class="fas fa-chart-line"></i> Activity Log
                    </button>
                </div>
                
                <!-- View Staff Tab -->
                <div class="staff-tab-content active" id="staff-view-tab">
                    <div class="staff-list" id="staff-list">
                        <!-- Staff cards will be rendered here -->
                    </div>
                </div>
                
                <!-- Create Account Tab -->
                <div class="staff-tab-content" id="staff-create-tab">
                    <form class="create-account-form" onsubmit="handleCreateAccount(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name *</label>
                                <input type="text" id="new-first-name" required placeholder="Enter first name">
                            </div>
                            <div class="form-group">
                                <label>Last Name *</label>
                                <input type="text" id="new-last-name" required placeholder="Enter last name">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" id="new-email" required placeholder="Enter email address">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Password *</label>
                                <input type="password" id="new-password" required placeholder="Minimum 8 characters" minlength="8">
                            </div>
                            <div class="form-group">
                                <label>Confirm Password *</label>
                                <input type="password" id="new-password-confirm" required placeholder="Re-enter password">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Role *</label>
                            <select id="new-role" required style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="">Select role...</option>
                                <option value="staff">Staff - View and manage properties</option>
                                <option value="manager">Manager - Staff + manage viewings</option>
                                <option value="admin">Admin - Full system access</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="new-phone" placeholder="Enter phone number (optional)">
                        </div>
                        
                        <button type="submit" class="login-btn">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </form>
                </div>
                
                <!-- Activity Log Tab -->
                <div class="staff-tab-content" id="staff-activity-tab">
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line"></i> Recent Activity
                        </h3>
                        <div id="activity-log-list" style="display: grid; gap: 10px;">
                            <!-- Activity items will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Account Settings Modal -->
    <div class="staff-modal" id="settings-modal">
        <div class="staff-modal-content" style="max-width: 700px;">
            <div class="staff-modal-header">
                <h2><i class="fas fa-user-cog"></i> Account Settings</h2>
                <button class="staff-close-btn" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="staff-modal-body">
                <div class="staff-tabs">
                    <button class="staff-tab active" onclick="switchSettingsTab('profile')">
                        <i class="fas fa-user"></i> My Profile
                    </button>
                    <button class="staff-tab" onclick="switchSettingsTab('password')">
                        <i class="fas fa-lock"></i> Change Password
                    </button>
                    <button class="staff-tab" onclick="switchSettingsTab('preferences')">
                        <i class="fas fa-sliders-h"></i> Preferences
                    </button>
                </div>
                
                <!-- Profile Tab -->
                <div class="staff-tab-content active" id="settings-profile-tab">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%); display: inline-flex; align-items: center; justify-content: center; font-size: 40px; color: white; font-weight: 600; margin-bottom: 15px;">
                            <span id="settings-avatar-initials">U</span>
                        </div>
                        <h3 id="settings-user-name" style="margin-bottom: 5px;">User Name</h3>
                        <div style="display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;" id="settings-user-role-badge">
                            STAFF
                        </div>
                    </div>
                    
                    <form class="create-account-form" onsubmit="updateProfile(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name *</label>
                                <input type="text" id="settings-first-name" required>
                            </div>
                            <div class="form-group">
                                <label>Last Name *</label>
                                <input type="text" id="settings-last-name" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" id="settings-email" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="settings-phone" placeholder="Optional">
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <h4 style="font-size: 14px; margin-bottom: 10px; color: #333;">
                                <i class="fas fa-info-circle"></i> Account Information
                            </h4>
                            <div style="display: grid; gap: 8px; font-size: 13px; color: #666;">
                                <div><strong>Role:</strong> <span id="settings-role-text">Staff</span></div>
                                <div><strong>Account Created:</strong> <span id="settings-created-date">-</span></div>
                                <div><strong>Last Login:</strong> <span id="settings-last-login">-</span></div>
                            </div>
                        </div>
                        
                        <button type="submit" class="login-btn" style="margin-top: 20px;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>
                
                <!-- Change Password Tab -->
                <div class="staff-tab-content" id="settings-password-tab">
                    <form class="create-account-form" onsubmit="changePassword(event)">
                        <div class="form-group">
                            <label>Current Password *</label>
                            <input type="password" id="current-password" required placeholder="Enter current password" minlength="8">
                        </div>
                        
                        <div class="form-group">
                            <label>New Password *</label>
                            <input type="password" id="new-password-change" required placeholder="Minimum 8 characters" minlength="8">
                            <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                                <i class="fas fa-info-circle"></i> Password must be at least 8 characters long
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm New Password *</label>
                            <input type="password" id="new-password-confirm-change" required placeholder="Re-enter new password">
                        </div>
                        
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <div style="display: flex; align-items: start; gap: 10px;">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-top: 2px;"></i>
                                <div style="font-size: 13px; color: #856404;">
                                    <strong>Password Security Tips:</strong>
                                    <ul style="margin: 8px 0 0 15px; line-height: 1.6;">
                                        <li>Use a mix of letters, numbers, and symbols</li>
                                        <li>Don't reuse passwords from other accounts</li>
                                        <li>Change your password regularly</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="login-btn" style="margin-top: 20px;">
                            <i class="fas fa-key"></i> Update Password
                        </button>
                    </form>
                </div>
                
                <!-- Preferences Tab -->
                <div class="staff-tab-content" id="settings-preferences-tab">
                    <form class="create-account-form" onsubmit="updatePreferences(event)">
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #333;">
                            <i class="fas fa-bell"></i> Notifications
                        </h4>
                        
                        <div style="display: grid; gap: 12px; margin-bottom: 30px;">
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="pref-property-alerts" checked>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 2px;">Property Alerts</div>
                                    <div style="font-size: 12px; color: #666;">Get notified when new properties are added</div>
                                </div>
                            </label>
                            
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="pref-viewing-reminders" checked>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 2px;">Viewing Reminders</div>
                                    <div style="font-size: 12px; color: #666;">Receive reminders for upcoming viewings</div>
                                </div>
                            </label>
                            
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" id="pref-system-updates">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 2px;">System Updates</div>
                                    <div style="font-size: 12px; color: #666;">Get notified about new features and updates</div>
                                </div>
                            </label>
                        </div>
                        
                        <h4 style="font-size: 16px; margin-bottom: 15px; color: #333;">
                            <i class="fas fa-palette"></i> Display Options
                        </h4>
                        
                        <div class="form-group">
                            <label>Properties per page</label>
                            <select id="pref-items-per-page" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="10">10 properties</option>
                                <option value="25" selected>25 properties</option>
                                <option value="50">50 properties</option>
                                <option value="100">100 properties</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Default view</label>
                            <select id="pref-default-view" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <option value="list" selected>List View</option>
                                <option value="map">Map View</option>
                                <option value="split">Split View</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="login-btn" style="margin-top: 20px;">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== FIXED MODAL TRIGGER BUTTONS (OUTSIDE ALL CONTAINERS) ==================== -->
    <button class="fixed-panel-btn left" id="menu-trigger-btn" onclick="openMenuPanel()">
        <i class="fas fa-bars"></i>
        <span>MENU</span>
    </button>
    
    <button class="fixed-panel-btn right" id="clients-trigger-btn" onclick="openClientsPanel()">
        <i class="fas fa-users"></i>
        <span>CLIENTS</span>
    </button>
    
    <!-- ==================== MODAL OVERLAY ==================== -->
    <div class="modal-overlay" id="panel-overlay" onclick="closeAllPanels()"></div>
    
    <!-- ==================== LEFT MODAL PANEL (MENU) ==================== -->
    <div class="modal-panel left" id="menu-panel">
        <div class="modal-panel-header">
            <h2><i class="fas fa-bars"></i> Menu</h2>
            <div class="modal-header-buttons">
                <button class="modal-expand-btn" onclick="togglePanelSize('menu-panel')" title="Expand/Collapse">
                    <i class="fas fa-expand-alt" id="menu-panel-expand-icon"></i>
                </button>
                <button class="modal-close-btn" onclick="closeMenuPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="modal-panel-content" id="menu-panel-content">
            <!-- Content will be cloned from left-sidebar -->
        </div>
    </div>
    
    <!-- ==================== RIGHT MODAL PANEL (CLIENTS) ==================== -->
    <div class="modal-panel right" id="clients-panel">
        <div class="modal-panel-header">
            <h2><i class="fas fa-users"></i> Client Management</h2>
            <div class="modal-header-buttons">
                <button class="modal-expand-btn" onclick="togglePanelSize('clients-panel')" title="Expand/Collapse">
                    <i class="fas fa-expand-alt" id="clients-panel-expand-icon"></i>
                </button>
                <button class="modal-close-btn" onclick="closeClientsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="modal-panel-content" id="clients-panel-content">
            <!-- Content will be cloned from right-sidebar -->
        </div>
    </div>
    
    <div id="header">
        <!-- Animated accent dots -->
        <span class="header-accent"></span>
        <span class="header-accent"></span>
        <span class="header-accent"></span>
        <span class="header-accent"></span>
        <span class="header-accent"></span>
        <span class="header-accent"></span>
        
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative; z-index: 1;">
            <!-- Ridwan Harir Logo -->
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="logo-icon" style="width: 50px; height: 50px; background: var(--primary-red); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 4px 12px rgba(142, 22, 22, 0.3);">
                    <i class="fas fa-building"></i>
                </div>
                <div>
                    <h1 style="font-size: 22px; margin: 0; font-weight: 700; line-height: 1.2;">
                        <span style="color: var(--text-dark);">Ridwan Harir's</span>
                    </h1>
                    <div style="font-size: 11px; color: var(--text-grey); font-weight: 500; letter-spacing: 1px;">
                        PROPERTY MANAGEMENT SYSTEM
                    </div>
                </div>
            </div>
            
            <!-- Stats & User Menu -->
            <div style="display: flex; gap: 25px; align-items: center;">
                
                <div style="padding: 8px 16px; background: rgba(142, 22, 22, 0.1); border: 2px solid var(--primary-red); border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--text-dark);">
                    <span style="color: var(--primary-red); font-size: 18px; margin-right: 5px;" id="available-count">38</span>
                    <span>Available</span>
                </div>
                

            
                <!-- User Menu -->
                <div class="user-menu" id="user-menu">
                    <div class="user-avatar" onclick="toggleUserDropdown()" id="user-avatar" style="border: 3px solid var(--border-color);">
                        <span id="user-initials">U</span>
                    </div>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="dropdown-user-name">User Name</div>
                            <div class="user-dropdown-role" id="dropdown-user-role">Staff</div>
                        </div>
                        <div class="user-dropdown-item" onclick="openProfileModal()">
                            <i class="fas fa-user"></i>
                            <span>My Profile</span>
                        </div>
                        <div class="user-dropdown-item" onclick="openStaffManagement()" id="staff-management-menu" style="display: none;">
                            <i class="fas fa-users-cog"></i>
                            <span>Staff Management</span>
                        </div>
                        <div class="user-dropdown-item" onclick="openActivityLog()">
                            <i class="fas fa-history"></i>
                            <span>Activity Log</span>
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <div class="user-dropdown-item danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Container with Resizable Panels -->
    <div id="main-container">
        
        <div class="sidebar" id="left-sidebar">
            <!-- Resize Handle -->
            <div class="resize-handle-vertical" id="left-resize-handle"></div>
        <!-- Tab Navigation -->
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" onclick="switchSidebarTab('overview')" data-tab="overview">
                <i class="fas fa-chart-pie"></i>
                <span>Overview</span>
            </button>
            <button class="sidebar-tab" onclick="switchSidebarTab('add')" data-tab="add">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </button>
            <button class="sidebar-tab" onclick="switchSidebarTab('browse')" data-tab="browse">
                <i class="fas fa-building"></i>
                <span>Browse</span>
            </button>
            <button class="sidebar-tab" onclick="switchSidebarTab('map')" data-tab="map">
                <i class="fas fa-map-marked-alt"></i>
                <span>Legends</span>
            </button>
        </div>
        
        <!-- Tab Content Container -->
        <div class="sidebar-content">
            
            <!-- OVERVIEW TAB -->
            <div class="tab-pane active" id="tab-overview">
                <div class="tab-pane-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-pie"></i>
                        <h3>Dashboard Overview</h3>
                    </div>
                    <!-- Fullscreen button removed - use floating menu -->
                    </button>
                </div>
                
                <!-- Big Stats Cards -->
                <div class="stats-grid">
                    <div class="big-stat-card total">
                        <div class="stat-icon"><i class="fas fa-home"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="total-properties-sidebar">58</div>
                            <div class="stat-label">Total Properties</div>
                        </div>
                    </div>
                    <div class="big-stat-card available">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="available-properties-sidebar">38</div>
                            <div class="stat-label">Available</div>
                        </div>
                    </div>
                    <div class="big-stat-card taken">
                        <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="taken-properties-sidebar">0</div>
                            <div class="stat-label">Taken</div>
                        </div>
                    </div>
                    <div class="big-stat-card viewings">
                        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                        <div class="stat-info">
                            <div class="stat-value" id="viewings-count-sidebar">0</div>
                            <div class="stat-label">Viewings</div>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Totals -->
                <div class="section-card" style="margin-top: 15px;">
                    <div class="section-header">
                        <i class="fas fa-pound-sign"></i>
                        <span>Financial Overview</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                        <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 10px 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-money-bill-wave" style="font-size: 18px; color: white; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 14px; font-weight: 700; color: white;" id="total-monthly-income">£0</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px;">Total Monthly</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, var(--primary-red), var(--dark-red)); padding: 10px 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line" style="font-size: 18px; color: white; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 14px; font-weight: 700; color: white;" id="available-monthly-income">£0</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px;">Available</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 10px 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-hand-holding-usd" style="font-size: 18px; color: white; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 14px; font-weight: 700; color: white;" id="occupied-monthly-income">£0</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px;">Occupied</div>
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #8E1616, #8E1616); padding: 10px 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-calendar-alt" style="font-size: 18px; color: white; opacity: 0.9;"></i>
                            <div>
                                <div style="font-size: 14px; font-weight: 700; color: white;" id="annual-income">£0</div>
                                <div style="font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px;">Annual</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="switchSidebarTab('add')">
                        <i class="fas fa-plus"></i> Add Property
                    </button>
                    <button class="quick-action-btn" onclick="switchSidebarTab('browse')">
                        <i class="fas fa-eye"></i> Browse All
                    </button>
                </div>
                
                <!-- Borough Summary -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>By Borough</span>
                    </div>
                    <div id="legend" class="borough-summary"></div>
                </div>
            </div>
            
            <!-- ADD PROPERTY TAB -->
            <div class="tab-pane" id="tab-add">
                <div class="tab-pane-header">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add New Property</h3>
                </div>
                
                <div class="add-property-form">
                    <div class="form-group">
                        <label><i class="fas fa-building"></i> Property Name *</label>
                        <input type="text" id="new-prop-name" placeholder="e.g., Studio 1, 34 Playgreen Way" />
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Address *</label>
                        <input type="text" id="new-prop-address" placeholder="Full address with postcode" />
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map"></i> Borough *</label>
                            <select id="new-prop-borough">
                                <option value="">Select...</option>
                                <option value="Lewisham">Lewisham</option>
                                <option value="Brent">Brent</option>
                                <option value="Camden">Camden</option>
                                <option value="Ealing">Ealing</option>
                                <option value="Epsom">Epsom</option>
                                <option value="Hertsmere">Hertsmere</option>
                                <option value="Kingston upon Thames">Kingston upon Thames</option>
                                <option value="Harrow">Harrow</option>
                                <option value="Lambeth">Lambeth</option>
                                <option value="Hertfordshire">Hertfordshire</option>
                                <option value="Enfield">Enfield</option>
                                <option value="Islington">Islington</option>
                                <option value="Potters Bar">Potters Bar</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-pound-sign"></i> Rent *</label>
                            <input type="number" id="new-prop-rent" placeholder="1291.98" step="0.01" min="0" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-layer-group"></i> Floor</label>
                            <input type="text" id="new-prop-floor" placeholder="GF, 1st, etc." />
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-elevator"></i> Lift</label>
                            <select id="new-prop-lift">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-venus-mars"></i> Gender Preference</label>
                        <select id="new-prop-gender">
                            <option value="any">Any</option>
                            <option value="male">Male Only</option>
                            <option value="female">Female Only</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-link"></i> Property Link</label>
                        <input type="url" id="new-prop-link" placeholder="https://..." />
                    </div>
                    
                    <button class="form-submit-btn" onclick="addPropertyFromTab()">
                        <i class="fas fa-plus-circle"></i> Add Property
                    </button>
                </div>
            </div>
            
            <!-- BROWSE PROPERTIES TAB -->
            <div class="tab-pane" id="tab-browse">
                <div class="tab-pane-header">
                    <i class="fas fa-building"></i>
                    <h3>Browse Properties</h3>
                </div>
                
                <!-- Search & Filter -->
                <div class="browse-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="property-search" placeholder="Search properties..." onkeyup="filterPropertiesList()" />
                    </div>
                    
                    <div class="filter-chips">
                        <button class="filter-chip active" onclick="setPropertyFilter('all')" data-filter="all">
                            All <span id="filter-all-count">58</span>
                        </button>
                        <button class="filter-chip" onclick="setPropertyFilter('available')" data-filter="available">
                            Available <span id="filter-available-count">38</span>
                        </button>
                        <button class="filter-chip" onclick="setPropertyFilter('taken')" data-filter="taken">
                            Taken <span id="filter-taken-count">0</span>
                        </button>
                    </div>
                    
                    <select id="property-sort-browse" onchange="sortPropertiesBrowse(this.value)" class="sort-select">
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest First</option>
                        <option value="alpha-asc">A → Z</option>
                        <option value="price-high">Price High → Low</option>
                        <option value="borough">By Borough</option>
                    </select>
                </div>
                
                <!-- Properties List -->
                <div id="properties-browse-list" class="properties-browse-list"></div>
            </div>
            
            <!-- MAP LEGENDS TAB -->
            <div class="tab-pane" id="tab-map">
                <div class="tab-pane-header">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>Map Legends</h3>
                </div>
                
                <!-- Borough Legend -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>London Boroughs</span>
                    </div>
                    <div id="legend-map-tab" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div>
                </div>
                
                <!-- Property Age & Marker Shapes -->
                <div class="section-card">
                    <div class="section-header">
                        <i class="fas fa-shapes"></i>
                        <span>Marker Shapes & Age</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px; padding: 10px;">
                        <!-- Green Circle -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.15); flex-shrink: 0;"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 13px;">Circle - New Properties</div>
                                <div style="font-size: 11px; color: var(--text-grey);">0-28 days old</div>
                            </div>
                        </div>
                        
                        <!-- Yellow Diamond -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <div style="width: 28px; height: 28px; background: linear-gradient(135deg, #f59e0b, #d97706); transform: rotate(45deg); border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.15);"></div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 13px;">Diamond - Medium Age</div>
                                <div style="font-size: 11px; color: var(--text-grey);">29-60 days old</div>
                            </div>
                        </div>
                        
                        <!-- Red Triangle -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="32" height="28" viewBox="0 0 32 28" style="filter: drop-shadow(0 3px 8px rgba(0,0,0,0.15));">
                                    <polygon points="16,2 30,26 2,26" fill="url(#legendRedGrad)" stroke="white" stroke-width="3"/>
                                    <defs>
                                        <linearGradient id="legendRedGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 13px;">Triangle - Old Properties</div>
                                <div style="font-size: 11px; color: var(--text-grey);">61-90 days old</div>
                            </div>
                        </div>
                        
                        <!-- Grey Circle - Very Old -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 4px solid #9ca3af;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #9ca3af, #6b7280); border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.15); flex-shrink: 0;"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-dark); font-size: 13px;">Grey - Very Old Properties</div>
                                <div style="font-size: 11px; color: var(--text-grey);">90+ days old (Review!)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <div id="map-container">
        <div id="map" style="position: relative; width: 100%; height: 100%;">
        <!-- Floating Marker Legend -->
        <div style="position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: var(--card-bg); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 12px; border: 2px solid var(--primary-red); box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
            <div style="font-weight: 700; font-size: 13px; margin-bottom: 12px; color: var(--text-light);">
                <i class="fas fa-info-circle"></i> Property Age Markers
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-light);">
                    <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; border: 2px solid white; flex-shrink: 0;"></div>
                    <span>0-28 days (New)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-light);">
                    <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #f59e0b, #d97706); transform: rotate(45deg); border: 2px solid white;"></div>
                    </div>
                    <span>29-60 days (Medium)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-light);">
                    <div style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="24" height="20" viewBox="0 0 24 20">
                            <polygon points="12,2 22,18 2,18" fill="#ef4444" stroke="white" stroke-width="2"/>
                        </svg>
                    </div>
                    <span>61-90 days (Old)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text-light);">
                    <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #9ca3af, #6b7280); border-radius: 50%; border: 2px solid white; flex-shrink: 0;"></div>
                    <span>90+ days (Very Old)</span>
                </div>
            </div>
        </div>
        
        <!-- Map Style Controls Overlay -->
        <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
            <button class="map-style-btn active" onclick="changeMapStyle('streets')" style="padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--primary-red); border-radius: 10px; color: var(--text-dark); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <i class="fas fa-map"></i>
                <span>Streets</span>
            </button>
            <button class="map-style-btn" onclick="changeMapStyle('satellite')" style="padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; color: var(--text-dark); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <i class="fas fa-satellite"></i>
                <span>Satellite</span>
            </button>
            <button class="map-style-btn" onclick="changeMapStyle('dark')" style="padding: 12px 16px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; color: var(--text-dark); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <i class="fas fa-moon"></i>
                <span>Dark</span>
            </button>
        </div>
        </div>
    </div>
    
    <div class="sidebar" id="right-sidebar">
        <!-- Resize Handle -->
        <div class="resize-handle-vertical" id="right-resize-handle"></div>
        <button class="resize-toggle" onclick="toggleRightSidebarSize()">
            <i class="fas fa-expand-alt" id="resize-icon"></i>
            <span id="resize-text">Expand</span>
        </button>
        <div class="sidebar-header" style="padding-top: 50px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-users"></i> Client Management</h2>
                <!-- Fullscreen button removed - use floating menu -->
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('location')"><i class="fas fa-map-marked-alt"></i> Location Intel</button>
                <button class="tab-btn" onclick="switchTab('eligibility')"><i class="fas fa-clipboard-check"></i> Eligibility</button>
                <button class="tab-btn" onclick="switchTab('booking')"><i class="fas fa-calendar-alt"></i> Booking</button>
                <button class="tab-btn" onclick="switchTab('viewings')"><i class="fas fa-eye"></i> Viewings <span id="viewings-badge" style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; display: none;">0</span></button>
                <button class="tab-btn" onclick="switchTab('pipeline')"><i class="fas fa-chart-line"></i> Pipeline</button>
                <button class="tab-btn" onclick="switchTab('referrals')"><i class="fas fa-user-friends"></i> Referrals</button>
            </div>
        </div>
        
        <!-- LOCATION INTELLIGENCE TAB -->
        <div id="location-tab" class="tab-content active">
            <div class="eligibility-section">
                
                <!-- Property Selector -->
                <div class="eligibility-form" style="margin-bottom: 20px;">
                    <div class="form-section">
                        <h3><i class="fas fa-building"></i> Select Property</h3>
                        <div class="form-group">
                            <label>Property *</label>
                            <select id="location-property-select" onchange="loadLocationIntelligence(this.value)">
                                <option value="">Choose property to analyze...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Commute Calculator -->
                <div class="eligibility-form" style="margin-bottom: 20px;">
                    <div class="form-section">
                        <h3><i class="fas fa-route"></i> Commute Calculator</h3>
                        <div id="commute-destinations" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Destination</label>
                                <input type="text" id="commute-dest-1" placeholder="e.g., Oxford Circus" value="Oxford Circus Station">
                            </div>
                            <div class="form-group">
                                <label>Destination 2 (Optional)</label>
                                <input type="text" id="commute-dest-2" placeholder="e.g., Liverpool Street">
                            </div>
                            <div class="form-group">
                                <label>Destination 3 (Optional)</label>
                                <input type="text" id="commute-dest-3" placeholder="e.g., King's Cross">
                            </div>
                        </div>
                        <button type="button" onclick="calculateCommutes()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary-red), var(--dark-red)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-calculator"></i> Calculate Travel Times
                        </button>
                        <div id="commute-results" style="margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Nearby Amenities -->
                <div class="eligibility-form" style="margin-bottom: 20px;">
                    <div class="form-section">
                        <h3><i class="fas fa-map-pin"></i> Nearby Amenities</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                            <button onclick="searchNearby('supermarket')" class="amenity-btn" data-type="supermarket">
                                <i class="fas fa-shopping-cart"></i> Supermarkets
                            </button>
                            <button onclick="searchNearby('gym')" class="amenity-btn" data-type="gym">
                                <i class="fas fa-dumbbell"></i> Gyms
                            </button>
                            <button onclick="searchNearby('school')" class="amenity-btn" data-type="school">
                                <i class="fas fa-school"></i> Schools
                            </button>
                            <button onclick="searchNearby('restaurant')" class="amenity-btn" data-type="restaurant">
                                <i class="fas fa-utensils"></i> Restaurants
                            </button>
                            <button onclick="searchNearby('pharmacy')" class="amenity-btn" data-type="pharmacy">
                                <i class="fas fa-pills"></i> Pharmacies
                            </button>
                            <button onclick="searchNearby('park')" class="amenity-btn" data-type="park">
                                <i class="fas fa-tree"></i> Parks
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Walk Distance</label>
                            <select id="walk-distance" onchange="updateAmenities()">
                                <option value="5">5 minute walk</option>
                                <option value="10" selected>10 minute walk</option>
                                <option value="15">15 minute walk</option>
                                <option value="20">20 minute walk</option>
                            </select>
                        </div>
                        <div id="amenities-results" style="margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Street View -->
                <div class="eligibility-form" style="margin-bottom: 20px;">
                    <div class="form-section">
                        <h3><i class="fas fa-street-view"></i> Street View</h3>
                        <button type="button" onclick="openStreetView()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                            <i class="fas fa-eye"></i> View Property on Street
                        </button>
                        <div id="streetview-container" style="width: 100%; height: 300px; border-radius: 8px; display: none; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <!-- Export Report -->
                <div class="eligibility-form">
                    <div class="form-section">
                        <h3><i class="fas fa-file-export"></i> Export Report</h3>
                        <button type="button" onclick="exportLocationReport()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8E1616, #8E1616); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 8px;">
                            <i class="fas fa-download"></i> Download PDF Report
                        </button>
                        <button type="button" onclick="printLocationReport()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
        
        <div id="eligibility-tab" class="tab-content">
            <div class="eligibility-section">
                <!-- UPFRONT COSTS CALCULATOR -->
                <div class="eligibility-form">
                    <div class="form-section">
                        <h3><i class="fas fa-calculator"></i> Upfront Costs Calculator</h3>
                        <div class="form-group">
                            <label>Select Property *</label>
                            <select id="upfront-calc-property" onchange="calculatePropertyUpfrontCosts()">
                                <option value="">Choose a property to see costs...</option>
                            </select>
                        </div>
                        <div id="upfront-costs-display"></div>
                    </div>
                </div>

                <form class="eligibility-form" id="eligibility-form" onsubmit="checkEligibility(event); return false;">
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Personal Information</h3>
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="client-name" required>
                        </div>
                        <div class="form-group">
                            <label>Gender *</label>
                            <select id="client-gender" required>
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other/Prefer not to say</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Age * <span class="info-tooltip" title="Age affects benefit entitlement and room type eligibility">ℹ</span></label>
                            <input type="number" id="client-age" required min="18" max="120" onchange="checkAgeRestrictions()">
                        </div>
                        <div class="form-group" id="under-35-exemption" style="display: none;">
                            <label style="color: #e67e22; font-weight: 600;">
                                <i class="fas fa-exclamation-triangle"></i> Under 35 - SAR Exemption Available?
                            </label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="sar-exemption" value="yes">
                                    Yes - I have an exemption
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="sar-exemption" value="no">
                                    No exemption
                                </label>
                            </div>
                            <small style="color: #e67e22; font-size: 11px; margin-top: 5px; display: block;">
                                ⚠️ Under 35s are usually only eligible for shared accommodation rate (SAR). Exemptions include: disability benefits (PIP, ESA, LCWRA), care leavers, homeless, domestic abuse survivors, ex-offenders in approved premises
                            </small>
                        </div>
                        <div class="form-group">
                            <label>Employment Status *</label>
                            <select id="employment-status" required onchange="toggleSalarySection()">
                                <option value="">Select...</option>
                                <option value="unemployed">Unemployed</option>
                                <option value="part-time">Part-time Employed</option>
                                <option value="full-time">Full-time Employed</option>
                                <option value="self-employed">Self-employed</option>
                                <option value="student">Student</option>
                                <option value="disabled">Unable to Work (Disabled)</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="salary-section" style="display: none;">
                            <label>Annual Salary (£) *</label>
                            <input type="number" id="annual-salary" placeholder="e.g. 30000" step="1000" min="0">
                            <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                                💡 Recommended: Rent should be max 30% of monthly income
                            </small>
                            <div id="salary-calculation" style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 4px; font-size: 11px; display: none;">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-money-bill-wave"></i> Benefits Information</h3>
                        <div class="form-group">
                            <label>Are you currently receiving benefits? *</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="receiving-benefits" value="yes" required onchange="toggleBenefitsSection(true)">
                                    Yes
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="receiving-benefits" value="no" required onchange="toggleBenefitsSection(false)">
                                    No
                                </label>
                            </div>
                        </div>

                        <div id="benefits-details" style="display: none;">
                            <div class="form-group">
                                <label>Benefit Type *</label>
                                <select id="benefit-type">
                                    <option value="">Select...</option>
                                    <option value="universal-credit">Universal Credit</option>
                                    <option value="housing-benefit">Housing Benefit</option>
                                    <option value="pip">Personal Independence Payment (PIP)</option>
                                    <option value="esa">Employment Support Allowance (ESA)</option>
                                    <option value="lcwra">Limited Capability for Work Related Activity (LCWRA)</option>
                                    <option value="jsa">Jobseeker's Allowance (JSA)</option>
                                    <option value="child-benefit">Child Benefit</option>
                                    <option value="pension-credit">Pension Credit</option>
                                    <option value="carers-allowance">Carer's Allowance</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Do you know if your benefit is capped? *</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="benefit-capped" value="yes" onchange="handleBenefitCapChange()">
                                        Yes (Capped at £1,050/month)
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="benefit-capped" value="no" onchange="handleBenefitCapChange()">
                                        No (Uncapped)
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="benefit-capped" value="unsure" onchange="handleBenefitCapChange()">
                                        Not Sure
                                    </label>
                                </div>
                                <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                                    <i class="fas fa-lightbulb"></i> PIP, ESA, LCWRA, Carer's Allowance, or Part-Time Employed on UC = Usually UNCAPPED (no upper limit)
                                </small>
                            </div>

                            <div class="form-group" id="benefit-amount-group">
                                <label>Monthly Benefit Amount (£) <span id="benefit-amount-required">*</span> <span class="info-tooltip" title="Enter your HOUSING ELEMENT amount">ℹ</span></label>
                                <input type="number" id="benefit-amount" min="0" step="0.01" placeholder="e.g. 1200">
                                <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;" id="benefit-amount-hint">
                                    💡 Enter your <strong>housing element</strong> amount - if you're unsure whether it's capped or not, just enter the amount and we'll help determine it
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Additional Benefits</label>
                                <div class="benefit-checkboxes">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="additional-benefits" value="housing-element">
                                        Housing Element in UC
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="additional-benefits" value="disability">
                                        Disability Benefits <span class="highlight">Removes Cap</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-home"></i> Housing Requirements</h3>
                        <div class="form-group">
                            <label>Household Size *</label>
                            <input type="number" id="household-size" required min="1">
                        </div>
                        <div class="form-group">
                            <label>Number of Children</label>
                            <input type="number" id="children-count" min="0" value="0">
                        </div>
                        <div class="form-group" id="property-select-group">
                            <label>Select Property to Check * <span class="info-tooltip" title="Choose a property to see if you can afford it">ℹ</span></label>
                            <select id="eligibility-property-select" onchange="updateEligibilityPropertyCosts()">
                                <option value="">Choose a property...</option>
                            </select>
                            <div id="property-cost-preview" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                        </div>
                        <div class="form-group" id="additional-funds-group" style="display: none;">
                            <label>Additional Monthly Funds Available (£) <span class="info-tooltip" title="Any extra money you can contribute towards rent beyond your benefit">ℹ</span></label>
                            <input type="number" id="additional-funds" min="0" step="0.01" value="0" placeholder="e.g. 100">
                            <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                                💡 Optional - any additional money you can add to your benefit to cover rent
                            </small>
                        </div>
                    </div>

                    <button type="submit" class="check-btn"><i class="fas fa-calculator"></i> Check Eligibility & Find Properties</button>
                </form>
                    <div id="eligibility-result"></div>
                    <div id="suggested-properties"></div>
            </div>
        </div>

        <div id="booking-tab" class="tab-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <button class="nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year"></h3>
                    <button class="nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar"></div>
                <div id="time-slots-container"></div>
                <div id="booking-form-container"></div>
            </div>
        </div>

        <div id="viewings-tab" class="tab-content">
            <div class="viewings-list" id="viewings-list"></div>
        </div>
        
        <!-- PIPELINE TRACKER TAB -->
        <div id="pipeline-tab" class="tab-content">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;"><i class="fas fa-chart-line"></i> Viewing Pipeline Tracker</h3>
                    <div style="display: flex; gap: 10px;">
                        <!-- Expand button removed - use floating menu -->
                        <button onclick="addPipelineRow()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-plus"></i> Add Viewing
                        </button>
                        <button onclick="exportPipelineCSV()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                
                <!-- Metrics Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="pipeline-total">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Total Viewings</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="pipeline-signed">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Signed Up</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #dc3545;" id="pipeline-noshow">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">No Shows</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #ffc107;" id="pipeline-conversion">0%</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Conversion Rate</div>
                    </div>
                </div>
                
                <!-- Pipeline Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; min-width: 1200px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); table-layout: fixed;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 110px;">Date</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 80px;">Time</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 200px;">Property</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 120px;">Visitor</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 130px;">Phone</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 100px;">Type</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 130px;">Status</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 200px;">Notes</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pipeline-table-body">
                            <!-- Rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- REFERRALS TAB -->
        <div id="referrals-tab" class="tab-content">
            <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;"><i class="fas fa-user-friends"></i> Client Referrals & Property Viewings</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addReferralFromPipeline()" style="padding: 10px 20px; background: #6c5ce7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-arrow-down"></i> Import from Pipeline
                        </button>
                        <button onclick="addNewReferral()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-plus"></i> Add Referral
                        </button>
                        <button onclick="exportReferralsCSV()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="referrals-total">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Total Referrals</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="referrals-converted">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Converted</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #ffc107;" id="referrals-active">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Active</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #17a2b8;" id="referrals-properties">0</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Properties Viewed</div>
                    </div>
                </div>
                
                <!-- Referrals Table -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; min-width: 1200px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); table-layout: fixed;">
                        <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <tr>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 140px;">Name</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 130px;">Phone</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 250px;">Properties Viewed</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 200px;">Interested In</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 110px;">Last Contact</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 120px;">Status</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; width: 180px;">Notes</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="referrals-table-body">
                            <!-- Rows added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast-notification">
        <div class="toast-header">
            <span class="toast-icon">✓</span>
            <span id="toast-title">Success</span>
        </div>
        <div class="toast-body" id="toast-message"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ==================== AUTHENTICATION & STAFF MANAGEMENT ====================
        
        let currentUser = null;
        let users = [];
        let activityLog = [];
        
        // Load users from localStorage
        function loadUsers() {
            const stored = localStorage.getItem('elevateEstatesUsers');
            if (stored) {
                try {
                    users = JSON.parse(stored);
                } catch (e) {
                    users = [];
                }
            }
            
            // Create default admin if no users exist
            if (users.length === 0) {
                users = [{
                    id: 1,
                    firstName: 'Admin',
                    lastName: 'User',
                    email: 'admin@ridwanharir.com',
                    password: 'admin123', // In production, this should be hashed
                    role: 'admin',
                    phone: '',
                    createdAt: new Date().toISOString(),
                    createdBy: null,
                    lastLogin: null
                }];
                saveUsers();
            }
        }
        
        function saveUsers() {
            localStorage.setItem('elevateEstatesUsers', JSON.stringify(users));
        }
        
        // Load activity log
        function loadActivityLog() {
            const stored = localStorage.getItem('elevateEstatesActivity');
            if (stored) {
                try {
                    activityLog = JSON.parse(stored);
                } catch (e) {
                    activityLog = [];
                }
            }
        }
        
        function saveActivityLog() {
            localStorage.setItem('elevateEstatesActivity', JSON.stringify(activityLog));
        }
        
        function logActivity(action, details = '') {
            if (!currentUser) return;
            
            activityLog.unshift({
                id: Date.now(),
                userId: currentUser.id,
                userName: `${currentUser.firstName} ${currentUser.lastName}`,
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 200 activities
            if (activityLog.length > 200) {
                activityLog = activityLog.slice(0, 200);
            }
            
            saveActivityLog();
        }
        
        // Check authentication - DISABLED (Auto-login)
        function checkAuth() {
            // Create a default user for the session
            currentUser = {
                id: 1,
                email: 'admin',
                firstName: 'Admin',
                lastName: 'User',
                role: 'admin',
                lastLogin: new Date().toISOString()
            };
            
            showMainApp();
            updateUserUI();
            console.log('[AUTH] Auto-login enabled - authentication bypassed');
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
        }
        
        function hideLoginScreen() {
            document.getElementById('login-screen').classList.add('hidden');
        }
        
        function showMainApp() {
            hideLoginScreen();
        }
        
        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
            
            if (user) {
                currentUser = user;
                user.lastLogin = new Date().toISOString();
                saveUsers();
                localStorage.setItem('elevateEstatesCurrentUser', JSON.stringify(currentUser));
                
                errorDiv.classList.remove('show');
                showMainApp();
                updateUserUI();
                logActivity('Logged in', 'User signed in to the system');
                
                showToast('Welcome!', `Welcome back, ${user.firstName}!`);
            } else {
                errorDiv.textContent = 'Invalid email or password. Please try again.';
                errorDiv.classList.add('show');
            }
        }
        
        // Logout - DISABLED (just reload page)
        function logout() {
            if (confirm('Are you sure you want to reload the page?')) {
                location.reload();
            }
        }
        
        // Update user UI
        function updateUserUI() {
            if (!currentUser) return;
            
            const initials = (currentUser.firstName[0] + currentUser.lastName[0]).toUpperCase();
            document.getElementById('user-initials').textContent = initials;
            document.getElementById('dropdown-user-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('dropdown-user-role').textContent = currentUser.role.toUpperCase();
            
            // Show staff management menu only for admins
            if (currentUser.role === 'admin') {
                document.getElementById('staff-management-menu').style.display = 'flex';
            } else {
                document.getElementById('staff-management-menu').style.display = 'none';
            }
        }
        
        // Toggle user dropdown
        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu');
            const dropdown = document.getElementById('user-dropdown');
            
            if (userMenu && !userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Staff Management Functions
        function openStaffManagement() {
            if (currentUser.role !== 'admin') {
                showToast('Access Denied', 'Only administrators can access staff management', true);
                return;
            }
            
            document.getElementById('staff-modal').classList.add('show');
            renderStaffList();
            renderActivityLog();
            logActivity('Opened staff management', 'Accessed staff management panel');
        }
        
        function closeStaffModal() {
            document.getElementById('staff-modal').classList.remove('show');
        }
        
        function switchStaffTab(tab) {
            // Update tabs
            document.querySelectorAll('.staff-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.staff-tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'view') {
                document.getElementById('staff-view-tab').classList.add('active');
                renderStaffList();
            } else if (tab === 'create') {
                document.getElementById('staff-create-tab').classList.add('active');
            } else if (tab === 'activity') {
                document.getElementById('staff-activity-tab').classList.add('active');
                renderActivityLog();
            }
        }
        
        function renderStaffList() {
            const listDiv = document.getElementById('staff-list');
            listDiv.innerHTML = '';
            
            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'staff-card';
                
                const initials = (user.firstName[0] + user.lastName[0]).toUpperCase();
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
                const createdAt = new Date(user.createdAt).toLocaleDateString();
                
                card.innerHTML = `
                    <div class="staff-avatar">${initials}</div>
                    <div class="staff-info">
                        <div class="staff-name">${user.firstName} ${user.lastName}</div>
                        <div class="staff-email">${user.email}</div>
                        <div class="staff-meta">
                            <span class="staff-role-badge ${user.role}">${user.role}</span>
                            <span><i class="fas fa-calendar"></i> Joined: ${createdAt}</span>
                            <span><i class="fas fa-clock"></i> Last login: ${lastLogin}</span>
                        </div>
                    </div>
                    <div class="staff-actions">
                        ${user.id !== currentUser.id ? `
                            <button class="staff-action-btn edit" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="staff-action-btn delete" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        ` : '<span style="color: #999; font-size: 12px;">(You)</span>'}
                    </div>
                `;
                
                listDiv.appendChild(card);
            });
        }
        
        function handleCreateAccount(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('new-first-name').value.trim();
            const lastName = document.getElementById('new-last-name').value.trim();
            const email = document.getElementById('new-email').value.trim();
            const password = document.getElementById('new-password').value;
            const passwordConfirm = document.getElementById('new-password-confirm').value;
            const role = document.getElementById('new-role').value;
            const phone = document.getElementById('new-phone').value.trim();
            
            // Validation
            if (password !== passwordConfirm) {
                showToast('Error', 'Passwords do not match!', true);
                return;
            }
            
            if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                showToast('Error', 'Email already exists!', true);
                return;
            }
            
            const newUser = {
                id: Math.max(...users.map(u => u.id), 0) + 1,
                firstName,
                lastName,
                email,
                password,
                role,
                phone,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.id,
                lastLogin: null
            };
            
            users.push(newUser);
            saveUsers();
            
            logActivity('Created account', `New ${role} account created for ${firstName} ${lastName}`);
            showToast('Success!', `Account created for ${firstName} ${lastName}`);
            
            // Reset form
            document.getElementById('new-first-name').value = '';
            document.getElementById('new-last-name').value = '';
            document.getElementById('new-email').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-password-confirm').value = '';
            document.getElementById('new-role').value = '';
            document.getElementById('new-phone').value = '';
            
            // Switch to staff list
            switchStaffTab('view');
            document.querySelector('.staff-tab').click();
        }
        
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`Delete account for ${user.firstName} ${user.lastName}?\n\nThis action cannot be undone.`)) {
                users = users.filter(u => u.id !== userId);
                saveUsers();
                renderStaffList();
                
                logActivity('Deleted account', `Removed ${user.firstName} ${user.lastName} from the system`);
                showToast('Deleted', `Account for ${user.firstName} ${user.lastName} has been removed`);
            }
        }
        
        function editUser(userId) {
            showToast('Coming Soon', 'Edit user functionality will be available in the next update');
        }
        
        // Account Settings Functions
        function openProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('settings-modal').classList.add('show');
            loadProfileSettings();
            logActivity('Opened settings', 'Accessed account settings');
        }
        
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }
        
        function switchSettingsTab(tab) {
            // Update tabs
            const tabs = document.querySelectorAll('#settings-modal .staff-tab');
            const contents = document.querySelectorAll('#settings-modal .staff-tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'profile') {
                document.getElementById('settings-profile-tab').classList.add('active');
            } else if (tab === 'password') {
                document.getElementById('settings-password-tab').classList.add('active');
            } else if (tab === 'preferences') {
                document.getElementById('settings-preferences-tab').classList.add('active');
                loadPreferences();
            }
        }
        
        function loadProfileSettings() {
            if (!currentUser) return;
            
            const initials = (currentUser.firstName[0] + currentUser.lastName[0]).toUpperCase();
            document.getElementById('settings-avatar-initials').textContent = initials;
            document.getElementById('settings-user-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            
            const roleBadge = document.getElementById('settings-user-role-badge');
            roleBadge.textContent = currentUser.role.toUpperCase();
            roleBadge.className = `staff-role-badge ${currentUser.role}`;
            
            document.getElementById('settings-first-name').value = currentUser.firstName;
            document.getElementById('settings-last-name').value = currentUser.lastName;
            document.getElementById('settings-email').value = currentUser.email;
            document.getElementById('settings-phone').value = currentUser.phone || '';
            
            document.getElementById('settings-role-text').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            document.getElementById('settings-created-date').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            document.getElementById('settings-last-login').textContent = currentUser.lastLogin ? new Date(currentUser.lastLogin).toLocaleString() : 'Never';
        }
        
        function updateProfile(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('settings-first-name').value.trim();
            const lastName = document.getElementById('settings-last-name').value.trim();
            const email = document.getElementById('settings-email').value.trim();
            const phone = document.getElementById('settings-phone').value.trim();
            
            // Check if email is already used by another user
            const emailExists = users.some(u => u.id !== currentUser.id && u.email.toLowerCase() === email.toLowerCase());
            if (emailExists) {
                showToast('Error', 'Email already in use by another account', true);
                return;
            }
            
            // Update current user
            currentUser.firstName = firstName;
            currentUser.lastName = lastName;
            currentUser.email = email;
            currentUser.phone = phone;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
            }
            
            saveUsers();
            localStorage.setItem('elevateEstatesCurrentUser', JSON.stringify(currentUser));
            updateUserUI();
            
            logActivity('Updated profile', 'Changed account information');
            showToast('Success!', 'Profile updated successfully');
        }
        
        function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password-change').value;
            const confirmPassword = document.getElementById('new-password-confirm-change').value;
            
            // Verify current password
            if (currentPassword !== currentUser.password) {
                showToast('Error', 'Current password is incorrect', true);
                return;
            }
            
            // Check if passwords match
            if (newPassword !== confirmPassword) {
                showToast('Error', 'New passwords do not match', true);
                return;
            }
            
            // Check if new password is different
            if (newPassword === currentPassword) {
                showToast('Error', 'New password must be different from current password', true);
                return;
            }
            
            // Update password
            currentUser.password = newPassword;
            
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
            }
            
            saveUsers();
            localStorage.setItem('elevateEstatesCurrentUser', JSON.stringify(currentUser));
            
            // Clear form
            document.getElementById('current-password').value = '';
            document.getElementById('new-password-change').value = '';
            document.getElementById('new-password-confirm-change').value = '';
            
            logActivity('Changed password', 'Updated account password');
            showToast('Success!', 'Password updated successfully');
        }
        
        function loadPreferences() {
            const prefs = localStorage.getItem('userPreferences');
            if (prefs) {
                try {
                    const preferences = JSON.parse(prefs);
                    document.getElementById('pref-property-alerts').checked = preferences.propertyAlerts !== false;
                    document.getElementById('pref-viewing-reminders').checked = preferences.viewingReminders !== false;
                    document.getElementById('pref-system-updates').checked = preferences.systemUpdates || false;
                    document.getElementById('pref-items-per-page').value = preferences.itemsPerPage || '25';
                    document.getElementById('pref-default-view').value = preferences.defaultView || 'list';
                } catch (e) {
                    // Use defaults
                }
            }
        }
        
        function updatePreferences(event) {
            event.preventDefault();
            
            const preferences = {
                propertyAlerts: document.getElementById('pref-property-alerts').checked,
                viewingReminders: document.getElementById('pref-viewing-reminders').checked,
                systemUpdates: document.getElementById('pref-system-updates').checked,
                itemsPerPage: document.getElementById('pref-items-per-page').value,
                defaultView: document.getElementById('pref-default-view').value
            };
            
            localStorage.setItem('userPreferences', JSON.stringify(preferences));
            
            logActivity('Updated preferences', 'Changed display and notification settings');
            showToast('Success!', 'Preferences saved successfully');
        }
        
        function openActivityLog() {
            openStaffManagement();
            // Auto-switch to activity tab
            setTimeout(() => {
                document.querySelectorAll('.staff-tab')[2].click();
            }, 100);
        }
        
        function renderActivityLog() {
            const listDiv = document.getElementById('activity-log-list');
            listDiv.innerHTML = '';
            
            const recent = activityLog.slice(0, 50);
            
            if (recent.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No activity to display</div>';
                return;
            }
            
            recent.forEach(activity => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-orange);';
                
                const time = new Date(activity.timestamp).toLocaleString();
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <strong style="color: #333;">${activity.userName}</strong>
                        <span style="font-size: 11px; color: #999;">${time}</span>
                    </div>
                    <div style="font-size: 13px; color: #666;">${activity.action}</div>
                    ${activity.details ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${activity.details}</div>` : ''}
                `;
                
                listDiv.appendChild(item);
            });
        }
        
        // Initialize authentication on page load
        loadUsers();
        loadActivityLog();
        checkAuth();
        
        // ==================== GLOBAL SEARCH FUNCTION ====================
        function handleGlobalSearch() {
            const searchTerm = document.getElementById('global-search').value.toLowerCase();
            const filtered = properties.filter(p => 
                p.name.toLowerCase().includes(searchTerm) ||
                p.address.toLowerCase().includes(searchTerm) ||
                p.borough.toLowerCase().includes(searchTerm)
            );
            
            // Update property list
            renderPropertiesBrowseList();
            
            // Update map markers
            if (window.propertyMap) {
                updateMapMarkers();
            }
        }
        
        // ==================== END AUTHENTICATION ====================
        
        window.addEventListener('load', function() {
            const lhaMonthlyRates = {
                "Lewisham": 1291.98, "Epsom": 1196.69, "Lambeth": 1346.28,
                "Ealing": 1346.28, "Brent": 1436.02, "Harrow": 1096.98,
                "Hillingdon": 1096.98, "Kingston upon Thames": 1196.69,
                "Potters Bar": 1146.86, "Hertsmere": 1146.86,
                "Thurrock": 772.89, "Islington": 1436.02, "Bromley": 1096.98
            };

            function loadPropertiesFromStorage() {
                try {
                    const stored = localStorage.getItem('propertySystemProperties');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        console.log('Loaded', parsed.length, 'properties from storage');
                        return parsed;
                    }
                } catch (e) {
                    console.error('Failed to load properties:', e);
                }
                return null;
            }

            function savePropertiesToStorage() {
                try {
                    localStorage.setItem('propertySystemProperties', JSON.stringify(properties));
                    localStorage.setItem('takenPropertiesSet', JSON.stringify([...takenProperties]));
                    window.properties = properties;
                    window.takenProperties = takenProperties;
                    console.log('[SAVE] Saved', properties.length, 'properties and', takenProperties.size, 'taken properties');
                    return true;
                } catch (e) {
                    console.error('Failed to save!', e);
                    return false;
                }
            }

            const defaultProperties = [
                { id: 1, name: "Studio 3 34 Playgreen Way", address: "34 Playgreen Way, London, SE6 3HU", borough: "Lewisham", link: null, lat: 51.429980, lng: -0.023430, rent: 1291.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-01' },
                { id: 2, name: "Studio 6 38 Playgreen Way", address: "38 Playgreen Way, London, SE6 3HU", borough: "Lewisham", link: null, lat: 51.430100, lng: -0.023550, rent: 1291.98, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-01' },
                { id: 3, name: "Studio 2A 21 Mansell Road", address: "21 Mansell Road, W3 7QH", borough: "Ealing", link: null, lat: 51.505554, lng: -0.26199, rent: 1346.28, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-01' },
                { id: 4, name: "Studio 3 13 Foxholt Gardens", address: "13 Foxholt Gardens, NW10 0TA", borough: "Brent", link: null, lat: 51.543114, lng: -0.267969, rent: 1436.02, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-08-20' },
                { id: 5, name: "Studio 2 14 Chippenham Close", address: "14 Chippenham Close, HA5 2NF", borough: "Hillingdon", link: null, lat: 51.59254, lng: -0.41297, rent: 1096.98, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' },
                { id: 6, name: "Studio 3 14 Chippenham Close", address: "14 Chippenham Close, HA5 2NF", borough: "Hillingdon", link: null, lat: 51.59254, lng: -0.41297, rent: 1096.98, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' },
                { id: 7, name: "Studio 4 14 Chippenham Close", address: "14 Chippenham Close, HA5 2NF", borough: "Hillingdon", link: null, lat: 51.59254, lng: -0.41297, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' },
                { id: 8, name: "Studio 5 14 Chippenham Close", address: "14 Chippenham Close, HA5 2NF", borough: "Hillingdon", link: null, lat: 51.59254, lng: -0.41297, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' },
                { id: 9, name: "Studio 6 14 Chippenham Close", address: "14 Chippenham Close, HA5 2NF", borough: "Hillingdon", link: null, lat: 51.59254, lng: -0.41297, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' },
                { id: 10, name: "Studio 3 289a Sydenham Road", address: "289a Sydenham Road, SE26 5EW", borough: "Lewisham", link: null, lat: 51.427540, lng: -0.040290, rent: 1291.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-10' },
                { id: 11, name: "Studio 6 289a Sydenham Road", address: "289a Sydenham Road, SE26 5EW", borough: "Lewisham", link: null, lat: 51.427640, lng: -0.040190, rent: 1291.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-10' },
                { id: 12, name: "Studio 1 56 Dickens Avenue", address: "56 Dickens Avenue, RM18 8HJ", borough: "Thurrock", link: null, lat: 51.46697, lng: 0.37387, rent: 772.89, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-15' },
                { id: 13, name: "Studio 3 56 Dickens Avenue", address: "56 Dickens Avenue, RM18 8HJ", borough: "Thurrock", link: null, lat: 51.46697, lng: 0.37387, rent: 772.89, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-15' },
                { id: 14, name: "Studio 4 56 Dickens Avenue", address: "56 Dickens Avenue, RM18 8HJ", borough: "Thurrock", link: null, lat: 51.46697, lng: 0.37387, rent: 772.89, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-15' },
                { id: 15, name: "Studio 5 56 Dickens Avenue", address: "56 Dickens Avenue, RM18 8HJ", borough: "Thurrock", link: null, lat: 51.46697, lng: 0.37387, rent: 772.89, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-15' },
                { id: 16, name: "Studio 6 56 Dickens Avenue", address: "56 Dickens Avenue, RM18 8HJ", borough: "Thurrock", link: null, lat: 51.46697, lng: 0.37387, rent: 772.89, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-15' },
                { id: 17, name: "Flat 1 71 Brookbank Avenue", address: "71 Brookbank Avenue, London, W7 3DN", borough: "Ealing", link: null, lat: 51.5252, lng: -0.344, rent: 1346.28, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-15' },
                { id: 18, name: "Flat 2 71 Brookbank Avenue", address: "71 Brookbank Avenue, London, W7 3DN", borough: "Ealing", link: null, lat: 51.5253, lng: -0.3441, rent: 1346.28, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-15' },
                { id: 19, name: "Studio 1 2 Dawlish Avenue", address: "2 Dawlish Avenue, UB6 8AF", borough: "Ealing", link: "https://elevateestatesmanagement.co.uk/property/dawlish-ave-perivale-ub6-8af/", lat: 51.534170, lng: -0.322070, rent: 1346.28, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-01' },
                { id: 20, name: "Studio 3 2 Dawlish Avenue", address: "2 Dawlish Avenue, UB6 8AF", borough: "Ealing", link: "https://elevateestatesmanagement.co.uk/property/dawlish-ave-perivale-ub6-8af/", lat: 51.534270, lng: -0.322170, rent: 1346.28, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-01' },
                { id: 21, name: "Studio 3B 2 Dawlish Avenue", address: "2 Dawlish Avenue, UB6 8AF", borough: "Ealing", link: "https://elevateestatesmanagement.co.uk/property/dawlish-ave-perivale-ub6-8af/", lat: 51.534070, lng: -0.321970, rent: 1346.28, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-01' },
                { id: 22, name: "Studio 5B 2 Dawlish Avenue", address: "2 Dawlish Avenue, UB6 8AF", borough: "Ealing", link: "https://elevateestatesmanagement.co.uk/property/dawlish-ave-perivale-ub6-8af/", lat: 51.533970, lng: -0.322170, rent: 1346.28, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-01' },
                { id: 23, name: "Studio 4 24 St. Francis Close", address: "24 St. Francis Close, EN6 2RH", borough: "Hertsmere", link: "https://elevateestatesmanagement.co.uk/property/st-francis-close-potters-bar-en6-2rh/", lat: 51.689010, lng: -0.176208, rent: 1146.86, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-20' },
                { id: 24, name: "Studio 5 24 St. Francis Close", address: "24 St. Francis Close, EN6 2RH", borough: "Hertsmere", link: "https://elevateestatesmanagement.co.uk/property/st-francis-close-potters-bar-en6-2rh/", lat: 51.689110, lng: -0.176108, rent: 1146.86, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-20' },
                { id: 25, name: "Studio 6 53 Harley Crescent", address: "53 Harley Crescent, HA1 4XH", borough: "Harrow", link: null, lat: 51.590040, lng: -0.343240, rent: 1096.98, gender: "female", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-05' },
                { id: 26, name: "Studio 1c 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386491, lng: -0.305118, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 27, name: "Studio 2c 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386591, lng: -0.305218, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 28, name: "Studio 3c 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386391, lng: -0.305018, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 29, name: "Studio 4c 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386291, lng: -0.305218, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 30, name: "Studio 1d 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386691, lng: -0.305018, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 31, name: "Studio 4d 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386191, lng: -0.305318, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 32, name: "Studio 5d 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386491, lng: -0.305118, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 33, name: "Studio 6d 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386591, lng: -0.305218, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 34, name: "Studio 1e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386391, lng: -0.305018, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 35, name: "Studio 2e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386291, lng: -0.305218, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 36, name: "Studio 3e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386691, lng: -0.305018, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 37, name: "Studio 4e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386191, lng: -0.305318, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 38, name: "Studio 5e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386491, lng: -0.305118, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 39, name: "Studio 6e 2a Corkran Rd", address: "2a Corkran Rd, KT6 6PN", borough: "Kingston upon Thames", link: null, lat: 51.386591, lng: -0.305218, rent: 1196.69, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: false, petsAllowed: false, dateAdded: '2024-10-25' },
                { id: 40, name: "Studio 1c 75 Howson Road", address: "75 Howson Road, SE4 2AT", borough: "Lewisham", link: "https://elevateestatesmanagement.co.uk/property/howson-road-lewisham-se4-2at/", lat: 51.465810, lng: -0.024460, rent: 1291.98, gender: "any", floor: "3rd", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-08-01' },
                { id: 41, name: "Studio 3a 75 Howson Road", address: "75 Howson Road, SE4 2AT", borough: "Lewisham", link: "https://elevateestatesmanagement.co.uk/property/howson-road-lewisham-se4-2at/", lat: 51.465910, lng: -0.024360, rent: 1291.98, gender: "any", floor: "3rd", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-08-01' },
                { id: 42, name: "Flat 1 28a High Street", address: "28a High Street, Harefield, Uxbridge, UB9 6BU", borough: "Hillingdon", link: null, lat: 51.60349, lng: -0.48257, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 2, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-20' },
                { id: 43, name: "Flat 1 26a High Street", address: "26a High Street, Harefield, Uxbridge, UB9 6BU", borough: "Hillingdon", link: null, lat: 51.60349, lng: -0.48257, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 2, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-09-20' },
                { id: 44, name: "Studio 1 85 Clarence Road", address: "85 Clarence Road, Grays, RM17 6RA", borough: "Thurrock", link: null, lat: 51.47794, lng: 0.32749, rent: 772.89, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-08' },
                { id: 45, name: "Studio 5 85 Clarence Road", address: "85 Clarence Road, Grays, RM17 6RA", borough: "Thurrock", link: null, lat: 51.47774, lng: 0.32759, rent: 772.89, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-08' },
                { id: 46, name: "Studio 1 29 Bridge Road", address: "29 Bridge Road, NW10 9DG", borough: "Brent", link: null, lat: 51.547360, lng: -0.25473, rent: 1436.02, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-10' },
                { id: 47, name: "Studio 2 29 Bridge Road", address: "29 Bridge Road, NW10 9DG", borough: "Brent", link: null, lat: 51.547460, lng: -0.25483, rent: 1436.02, gender: "any", floor: "GF", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-10' },
                { id: 48, name: "Studio 5 29 Bridge Road", address: "29 Bridge Road, NW10 9DG", borough: "Brent", link: null, lat: 51.547160, lng: -0.25483, rent: 1436.02, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-10' },
                { id: 49, name: "Studio 6 29 Bridge Road", address: "29 Bridge Road, NW10 9DG", borough: "Brent", link: null, lat: 51.547660, lng: -0.25493, rent: 1436.02, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-10' },
                { id: 50, name: "Studio 2 296A Ewell Road", address: "296A Ewell Road, KT6 7AQ", borough: "Kingston upon Thames", link: "https://elevateestatesmanagement.co.uk/property/ewell-road-kt6-7aq/", lat: 51.386920, lng: -0.292340, rent: 1196.69, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-11-12' },
                { id: 51, name: "Studio 2 38 Parkfield Way", address: "38 Parkfield Way, BR2 8AF", borough: "Bromley", link: null, lat: 51.388620, lng: 0.052920, rent: 1096.98, gender: "any", floor: "1st", bedrooms: 1, maxOccupancy: 1, lift: false, billsIncluded: true, petsAllowed: false, dateAdded: '2024-10-05' }
            ];

            // VERSION CONTROL - Force update when properties change
            const PROPERTY_VERSION = '14.0'; // MAJOR UPDATE: Grouped address view with bulk editing!
            const storedVersion = localStorage.getItem('propertyVersion');
            
            // Load from storage or use defaults
            const storedProperties = loadPropertiesFromStorage();
            if (storedVersion === PROPERTY_VERSION && storedProperties && storedProperties.length > 0) {
                properties = storedProperties;
                console.log('[SYSTEM] Loaded', storedProperties.length, 'properties from storage (v' + PROPERTY_VERSION + ')');
            } else {
                properties = defaultProperties;
                localStorage.setItem('propertyVersion', PROPERTY_VERSION);
                console.log('[SYSTEM] 🔄 Properties updated to v' + PROPERTY_VERSION + ' - loaded', defaultProperties.length, 'fresh properties');
            }
            
            // Ensure all properties have status field (for backward compatibility)
            properties = properties.map(p => ({
                ...p,
                status: p.status || 'available', // available, taken, reserved
                takenBy: p.takenBy || null,
                takenDate: p.takenDate || null,
                type: p.type || 'Studio', // Studio, 1-Bed, 2-Bed, etc.
                notes: p.notes || '',
                dateAdded: p.dateAdded || new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString() // Random date within last 30 days for old properties
            }));
            
            // CRITICAL: Expose properties globally for database sync
            window.properties = properties;
            console.log('[SYSTEM] Loaded', properties.length, 'properties - available globally for sync');
            
            // Load property tracking history
            loadPropertyTracking();

            const boroughColors = {
                "Lewisham": "#e74c3c", "Epsom": "#1abc9c", "Lambeth": "#d35400",
                "Ealing": "#f39c12", "Brent": "#8E1616", "Harrow": "#c0392b",
                "Hillingdon": "#2ed573", "Kingston upon Thames": "#2ecc71",
                "Potters Bar": "#27ae60", "Hertsmere": "#e67e22",
                "Thurrock": "#3742fa", "Islington": "#8e44ad", "Bromley": "#636e72"
            };

            const timeSlots = ["09:00", "09:15", "09:30", "09:45", "10:00", "10:15", "10:30", "10:45", "11:00", "11:15", "11:30", "11:45", "12:00", "12:15", "12:30", "12:45", "13:00", "13:15", "13:30", "13:45", "14:00", "14:15", "14:30", "14:45", "15:00", "15:15", "15:30", "15:45", "16:00", "16:15", "16:30", "16:45", "17:00"];

            // Load taken properties from localStorage
            let takenProperties = new Set();
            try {
                const storedTaken = localStorage.getItem('takenPropertiesSet');
                if (storedTaken) {
                    const takenArray = JSON.parse(storedTaken);
                    takenProperties = new Set(takenArray);
                    console.log('[LOAD] Loaded', takenProperties.size, 'taken properties from storage');
                }
            } catch (e) {
                console.error('[LOAD] Failed to load taken properties:', e);
            }
            
            // Load viewings from localStorage (CRITICAL: Must be global and load from storage!)
            window.viewings = [];
            try {
                const savedViewings = localStorage.getItem('propertyViewings');
                if (savedViewings) {
                    window.viewings = JSON.parse(savedViewings);
                    console.log('[LOAD] Loaded', window.viewings.length, 'viewings from storage');
                }
            } catch (e) {
                console.error('[LOAD] Failed to load viewings:', e);
                window.viewings = [];
            }
            
            let currentFilter = 'all';
            let map, markers = {};
            // Make map globally accessible for floating menu
            window.propertyMap = null;
            
            // Expose takenProperties globally for database sync
            window.takenProperties = takenProperties;
            
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTime = null;
            let selectedProperty = null;
            let currentTab = 'eligibility';
            let currentClientData = null;
            let viewingSortOrder = 'date-asc';
            let editingPropertyId = null; // date-asc, date-desc, property
            
            // Create local alias for viewings (points to global window.viewings)
            let viewings = window.viewings;
            let leftSidebarCollapsed = false;
            let rightSidebarExpanded = false;
            let boroughCollapsedState = {}; // Track which boroughs are collapsed
            let checklistCollapsed = false; // Track property checklist collapse state
            
            // Property tracking system - tracks who viewed what and when
            let propertyTracking = {}; // { propertyId: [{ viewedBy, viewedAt, status }] }
            
            // Load property tracking from storage
            function loadPropertyTracking() {
                const stored = localStorage.getItem('propertyTracking');
                if (stored) {
                    try {
                        propertyTracking = JSON.parse(stored);
                    } catch (e) {
                        propertyTracking = {};
                    }
                }
            }
            
            // Save property tracking to storage
            function savePropertyTracking() {
                localStorage.setItem('propertyTracking', JSON.stringify(propertyTracking));
            }
            
            // Add viewing record to property tracking
            function trackPropertyViewing(propertyId, clientName, clientPhone, viewingDate, status = 'viewed') {
                if (!propertyTracking[propertyId]) {
                    propertyTracking[propertyId] = [];
                }
                
                propertyTracking[propertyId].push({
                    viewedBy: clientName,
                    phone: clientPhone,
                    viewedAt: viewingDate,
                    status: status, // viewed, interested, taken, rejected
                    timestamp: new Date().toISOString()
                });
                
                savePropertyTracking();
            }
            
            // Get viewing history for a property
            function getPropertyHistory(propertyId) {
                return propertyTracking[propertyId] || [];
            }
            
            // Update property status (available, taken, reserved)
            function updatePropertyStatus(propertyId, status, takenBy = null) {
                const property = properties.find(p => p.id === propertyId);
                if (property) {
                    property.status = status;
                    if (takenBy) {
                        property.takenBy = takenBy;
                        property.takenDate = new Date().toISOString();
                    }
                    savePropertiesToStorage();
                    renderPropertyList();
                }
            }
            
            // Routing settings - CONFLICT CHECKING DEFAULT ON
            let routingSettings = {
                conflictCheckingEnabled: true,  // DEFAULT: ON
                autoOptimizeRoutes: true,
                showSuggestedTimes: true,
                requireConfirmation: true
            };

            window.toggleLeftSidebar = function() {
                leftSidebarCollapsed = !leftSidebarCollapsed;
                const sidebar = document.getElementById('left-sidebar');
                const icon = document.getElementById('left-toggle-icon');
                const menuIcon = document.getElementById('menu-left-icon');
                
                if (leftSidebarCollapsed) {
                    document.body.classList.add('left-collapsed');
                    icon.className = 'fas fa-chevron-right';
                    if (menuIcon) menuIcon.className = 'fas fa-bars';
                } else {
                    document.body.classList.remove('left-collapsed');
                    icon.className = 'fas fa-chevron-left';
                    if (menuIcon) menuIcon.className = 'fas fa-list';
                }
                
                // Force map to resize
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
            };
            
            // Toggle property checklist expand/collapse
            window.togglePropertyChecklist = function() {
                checklistCollapsed = !checklistCollapsed;
                const propertyList = document.getElementById('property-list');
                const addBtn = document.getElementById('add-property-btn');
                const filterBtns = document.getElementById('sort-filter-controls');
                const stats = document.getElementById('checklist-stats');
                const icon = document.getElementById('checklist-toggle-icon');
                
                if (checklistCollapsed) {
                    propertyList.style.display = 'none';
                    if (addBtn) addBtn.style.display = 'none';
                    if (filterBtns) filterBtns.style.display = 'none';
                    if (stats) stats.style.display = 'none';
                    icon.className = 'fas fa-chevron-down';
                } else {
                    propertyList.style.display = 'block';
                    if (addBtn) addBtn.style.display = 'flex';
                    if (filterBtns) filterBtns.style.display = 'block';
                    if (stats) stats.style.display = 'flex';
                    icon.className = 'fas fa-chevron-up';
                }
            };
            
            // Sort properties
            window.sortProperties = function(sortOrder) {
                currentSortOrder = sortOrder;
                renderPropertyList();
            };

            window.toggleRightSidebarSize = function() {
                rightSidebarExpanded = !rightSidebarExpanded;
                const icon = document.getElementById('resize-icon');
                const text = document.getElementById('resize-text');
                const menuIcon = document.getElementById('menu-resize-icon');
                
                if (rightSidebarExpanded) {
                    document.body.classList.add('right-expanded');
                    icon.className = 'fas fa-compress-alt';
                    text.textContent = 'Collapse';
                    if (menuIcon) menuIcon.className = 'fas fa-compress-alt';
                } else {
                    document.body.classList.remove('right-expanded');
                    icon.className = 'fas fa-expand-alt';
                    text.textContent = 'Expand';
                    if (menuIcon) menuIcon.className = 'fas fa-expand-alt';
                }
                
                // Force map to resize
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
            };

            window.toggleBorough = function(borough) {
                boroughCollapsedState[borough] = !boroughCollapsedState[borough];
                const header = document.querySelector(`[data-borough="${borough}"]`);
                const properties = document.getElementById(`borough-properties-${borough}`);
                
                if (boroughCollapsedState[borough]) {
                    header.classList.add('collapsed');
                    properties.classList.add('collapsed');
                } else {
                    header.classList.remove('collapsed');
                    properties.classList.remove('collapsed');
                }
            };

            function calculateUpfrontCosts(monthlyRent) {
                const weeklyRent = (monthlyRent * 12) / 52;
                const deposit = weeklyRent * 5;
                const total = monthlyRent + deposit;
                return { monthlyRent, weeklyRent, deposit, total };
            }

            function populateUpfrontCalculator() {
                const select = document.getElementById('upfront-calc-property');
                select.innerHTML = '<option value="">Choose a property to see costs...</option>';
                
                // Group by address
                const addressGroups = {};
                properties.forEach(prop => {
                    if (!takenProperties.has(prop.id)) {
                        const key = prop.address;
                        if (!addressGroups[key]) {
                            addressGroups[key] = [];
                        }
                        addressGroups[key].push(prop);
                    }
                });
                
                Object.values(addressGroups).forEach(group => {
                    const firstProp = group[0];
                    const option = document.createElement('option');
                    option.value = firstProp.id;
                    
                    let text = `${firstProp.address}`;
                    if (group.length === 1) {
                        text += ` (1 studio)`;
                    } else if (group.length > 1) {
                        text += ` (${group.length} studios)`;
                    }
                    text += ` - £${firstProp.rent}/mo`;
                    if (firstProp.gender === 'female') {
                        text += ' (Women Only)';
                    }
                    
                    option.textContent = text;
                    select.appendChild(option);
                });
            }

                window.calculatePropertyUpfrontCosts = function() {
                const select = document.getElementById('upfront-calc-property');
                const container = document.getElementById('upfront-costs-display');
                const propertyId = parseInt(select.value);
                
                if (!propertyId) {
                    container.innerHTML = '';
                    return;
                }
                
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const costs = calculateUpfrontCosts(property.rent);
                
                container.innerHTML = `
                    <div class="upfront-costs-card">
                        <h4><i class="fas fa-pound-sign"></i> ${property.name}</h4>
                        <div class="cost-row">
                            <span>Monthly Rent:</span>
                            <span>£${costs.monthlyRent.toFixed(2)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Weekly Rent:</span>
                            <span>£${costs.weeklyRent.toFixed(2)}</span>
                        </div>
                        <div class="cost-row">
                            <span>Deposit (5 weeks):</span>
                            <span>£${costs.deposit.toFixed(2)}</span>
                        </div>
                        <div class="cost-row">
                            <span>TOTAL UPFRONT:</span>
                            <span>£${costs.total.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            };

            function showToast(title, message, isError = false) {
                const toast = document.getElementById('toast-notification');
                const titleEl = document.getElementById('toast-title');
                const messageEl = document.getElementById('toast-message');
                const icon = toast.querySelector('.toast-icon');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                if (isError) {
                    toast.classList.add('error');
                    icon.textContent = '✗';
                    icon.className = 'toast-icon error';
                } else {
                    toast.classList.remove('error');
                    icon.textContent = '✓';
                    icon.className = 'toast-icon success';
                }
                
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
            
            // Make showToast globally accessible
            window.showToast = showToast;

            function loadViewingsFromStorage() {
                try {
                    const stored = localStorage.getItem('propertyViewings');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (parsed.length > 0) {
                            showToast('Data Loaded', `Loaded ${parsed.length} viewing(s)`);
                        }
                        return parsed;
                    }
                    return [];
                } catch (e) {
                    showToast('Error', 'Failed to load viewings', true);
                    return [];
                }
            }

            function saveViewingsToStorage() {
                try {
                    // Update both local and global references
                    window.viewings = viewings;
                    localStorage.setItem('propertyViewings', JSON.stringify(viewings));
                    updateViewingsCounts();
                    return true;
                } catch (e) {
                    showToast('Error', 'Failed to save!', true);
                    return false;
                }
            }

            function updateViewingsCounts() {
                const badge = document.getElementById('viewings-badge');
                const count = viewings.length;
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
                
                // Update sidebar viewings count
                const sidebarCount = document.getElementById('viewings-count-sidebar');
                if (sidebarCount) sidebarCount.textContent = count;
            }

            viewings = loadViewingsFromStorage();
            updateViewingsCounts();


            // Property Modal Functions
            window.openAddPropertyModal = function() {
                editingPropertyId = null;
                document.getElementById('modal-title').textContent = 'Add New Property';
                document.getElementById('property-form').reset();
                document.getElementById('property-id').value = '';
                
                // Set defaults
                document.getElementById('property-type').value = 'Studio';
                document.getElementById('property-floor').value = 'GF';
                document.getElementById('property-bedrooms').value = '1';
                document.getElementById('property-occupancy').value = '1';
                document.getElementById('property-lift').checked = false;
                document.getElementById('property-bills').checked = true;
                document.getElementById('property-pets').checked = false;
                document.getElementById('property-status').value = 'available';
                document.getElementById('property-date').value = new Date().toISOString().split('T')[0];
                
                // Reset studio tracking
                document.getElementById('property-total-studios').value = 1;
                document.getElementById('property-rent-per-studio').value = '';
                currentStudioStates = {1: true};
                document.getElementById('studio-grid-container').style.display = 'none';
                
                // Hide viewing history and taken by field
                document.getElementById('viewing-history-section').style.display = 'none';
                document.getElementById('taken-by-field').style.display = 'none';
                
                document.getElementById('property-modal').classList.add('show');
            };

            window.openEditPropertyModal = function(propertyId) {
                editingPropertyId = propertyId;
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;

                document.getElementById('modal-title').textContent = 'Edit Property';
                document.getElementById('property-id').value = property.id;
                document.getElementById('property-name').value = property.name;
                document.getElementById('property-address').value = property.address;
                document.getElementById('property-borough').value = property.borough;
                document.getElementById('property-rent').value = property.rent;
                document.getElementById('property-lat').value = property.lat;
                document.getElementById('property-lng').value = property.lng;
                document.getElementById('property-gender').value = property.gender || 'any';
                document.getElementById('property-link').value = property.link || '';
                
                // New fields
                document.getElementById('property-type').value = property.type || 'Studio';
                document.getElementById('property-floor').value = property.floor || 'GF';
                document.getElementById('property-bedrooms').value = property.bedrooms || 1;
                document.getElementById('property-occupancy').value = property.maxOccupancy || 1;
                document.getElementById('property-lift').checked = property.lift || false;
                document.getElementById('property-bills').checked = property.billsIncluded !== false;
                document.getElementById('property-pets').checked = property.petsAllowed || false;
                document.getElementById('property-status').value = property.status || 'available';
                document.getElementById('property-notes').value = property.notes || '';
                document.getElementById('property-taken-by').value = property.takenBy || '';
                
                // Set date field - convert ISO to YYYY-MM-DD format
                if (property.dateAdded) {
                    const date = new Date(property.dateAdded);
                    document.getElementById('property-date').value = date.toISOString().split('T')[0];
                } else {
                    document.getElementById('property-date').value = new Date().toISOString().split('T')[0];
                }
                
                // Load studio data
                if (property.studioData) {
                    document.getElementById('property-rent-per-studio').value = property.rentPerStudio || property.rent;
                    loadStudioData(property.studioData);
                } else {
                    document.getElementById('property-total-studios').value = 1;
                    document.getElementById('property-rent-per-studio').value = '';
                    currentStudioStates = {};
                    document.getElementById('studio-grid-container').style.display = 'none';
                }
                
                // Show/hide taken by field
                toggleTakenFields();
                
                // Show viewing history
                const history = getPropertyHistory(propertyId);
                const historySection = document.getElementById('viewing-history-section');
                const historyList = document.getElementById('viewing-history-list');
                
                if (history.length > 0) {
                    historySection.style.display = 'block';
                    historyList.innerHTML = history.map((h, i) => `
                        <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--primary-orange);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; font-size: 13px; color: #333;">
                                        ${i + 1}. ${h.viewedBy}
                                    </div>
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                        ${h.phone || 'No phone'} • ${new Date(h.viewedAt).toLocaleDateString('en-GB')}
                                    </div>
                                </div>
                                <div style="padding: 4px 8px; background: ${getStatusColor(h.status)}; color: white; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">
                                    ${h.status}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historySection.style.display = 'none';
                }
                
                document.getElementById('property-modal').classList.add('show');
            };
            
            // Helper for viewing history status colors
            function getStatusColor(status) {
                const colors = {
                    'viewed': '#8E1616',
                    'interested': '#f39c12',
                    'taken': '#2ecc71',
                    'rejected': '#e74c3c'
                };
                return colors[status] || '#95a5a6';
            }
            
            // Toggle taken by field visibility
            window.toggleTakenFields = function() {
                const status = document.getElementById('property-status').value;
                const takenByField = document.getElementById('taken-by-field');
                takenByField.style.display = (status === 'taken' || status === 'reserved') ? 'block' : 'none';
            };
            
            // ==================== STUDIO TRACKING SYSTEM ====================
            let currentStudioStates = {}; // Track which studios are occupied
            
            window.generateStudioGrid = function() {
                const totalStudios = parseInt(document.getElementById('property-total-studios').value);
                const container = document.getElementById('studio-grid-container');
                const grid = document.getElementById('studio-grid');
                
                if (!totalStudios || totalStudios < 1) {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                grid.innerHTML = '';
                
                // Generate studio buttons
                for (let i = 1; i <= totalStudios; i++) {
                    const occupied = currentStudioStates[i] !== undefined ? currentStudioStates[i] : true;
                    const studioBtn = document.createElement('div');
                    studioBtn.className = 'studio-toggle-btn';
                    studioBtn.dataset.studioNum = i;
                    studioBtn.innerHTML = `
                        <div style="font-size: 11px; font-weight: 600; color: ${occupied ? '#10b981' : '#ef4444'};">
                            ${occupied ? '✓' : '✗'}
                        </div>
                        <div style="font-size: 10px; margin-top: 2px;">Studio ${i}</div>
                    `;
                    studioBtn.style.cssText = `
                        padding: 10px 8px;
                        background: ${occupied ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
                        color: white;
                        border-radius: 8px;
                        cursor: pointer;
                        text-align: center;
                        transition: all 0.2s;
                        border: 2px solid ${occupied ? '#10b981' : '#ef4444'};
                    `;
                    
                    studioBtn.onclick = function() {
                        const num = parseInt(this.dataset.studioNum);
                        currentStudioStates[num] = !currentStudioStates[num];
                        generateStudioGrid();
                        updateStudioSummary();
                    };
                    
                    studioBtn.onmouseover = function() {
                        this.style.transform = 'scale(1.05)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                    };
                    
                    studioBtn.onmouseout = function() {
                        this.style.transform = 'scale(1)';
                        this.style.boxShadow = 'none';
                    };
                    
                    currentStudioStates[i] = occupied;
                    grid.appendChild(studioBtn);
                }
                
                updateStudioSummary();
            };
            
            function updateStudioSummary() {
                const totalStudios = parseInt(document.getElementById('property-total-studios').value) || 0;
                const occupied = Object.values(currentStudioStates).filter(s => s === true).length;
                const vacant = totalStudios - occupied;
                const summary = document.getElementById('studio-occupancy-summary');
                if (summary) {
                    summary.innerHTML = `<span style="color: #10b981; font-weight: 600;">${occupied} Occupied</span> • <span style="color: #ef4444; font-weight: 600;">${vacant} Vacant</span>`;
                }
            }
            
            window.getStudioData = function() {
                const totalStudios = parseInt(document.getElementById('property-total-studios').value);
                if (!totalStudios || totalStudios < 1) return null;
                
                return {
                    total: totalStudios,
                    studios: currentStudioStates,
                    occupied: Object.values(currentStudioStates).filter(s => s === true).length
                };
            };
            
            window.loadStudioData = function(studioData) {
                if (!studioData) {
                    currentStudioStates = {};
                    return;
                }
                currentStudioStates = studioData.studios || {};
                document.getElementById('property-total-studios').value = studioData.total || 1;
                generateStudioGrid();
            };
            // ==================== END STUDIO TRACKING ====================

            window.closePropertyModal = function() {
                document.getElementById('property-modal').classList.remove('show');
                editingPropertyId = null;
            };

            window.saveProperty = function(event) {
                event.preventDefault();
                
                const name = document.getElementById('property-name').value.trim();
                const address = document.getElementById('property-address').value.trim();
                const borough = document.getElementById('property-borough').value;
                const rent = parseFloat(document.getElementById('property-rent').value);
                const lat = parseFloat(document.getElementById('property-lat').value);
                const lng = parseFloat(document.getElementById('property-lng').value);
                const gender = document.getElementById('property-gender').value;
                const status = document.getElementById('property-status').value;
                const link = document.getElementById('property-link').value.trim() || null;
                
                // New fields
                const type = document.getElementById('property-type').value;
                const floor = document.getElementById('property-floor').value;
                const bedrooms = parseInt(document.getElementById('property-bedrooms').value);
                const maxOccupancy = parseInt(document.getElementById('property-occupancy').value);
                const lift = document.getElementById('property-lift').checked;
                const billsIncluded = document.getElementById('property-bills').checked;
                const petsAllowed = document.getElementById('property-pets').checked;
                const notes = document.getElementById('property-notes').value.trim();
                const takenBy = document.getElementById('property-taken-by').value.trim() || null;
                const dateAdded = document.getElementById('property-date').value;
                
                // Studio tracking data
                const studioData = getStudioData();
                const rentPerStudio = parseFloat(document.getElementById('property-rent-per-studio').value) || rent;

                if (editingPropertyId) {
                    const index = properties.findIndex(p => p.id === editingPropertyId);
                    if (index !== -1) {
                        const oldStatus = properties[index].status;
                        
                        properties[index] = {
                            ...properties[index],
                            name, address, borough, rent, lat, lng, gender, link,
                            type, floor, bedrooms, maxOccupancy, lift, billsIncluded, petsAllowed, notes,
                            status, takenBy, dateAdded,
                            studioData, rentPerStudio,
                            takenDate: (status === 'taken' && oldStatus !== 'taken') ? new Date().toISOString() : properties[index].takenDate
                        };
                        
                        if (status === 'taken') {
                            takenProperties.add(editingPropertyId);
                        } else {
                            takenProperties.delete(editingPropertyId);
                        }
                        
                        logActivity('Updated property', `${name} information modified`);
                        showToast('Updated!', `${name} has been updated`);
                    }
                } else {
                    const newId = Math.max(...properties.map(p => p.id), 0) + 1;
                    const newProperty = {
                        id: newId,
                        name, address, borough, rent, lat, lng, gender, link,
                        type, floor, bedrooms, maxOccupancy, lift, billsIncluded, petsAllowed, notes,
                        status, takenBy,
                        studioData, rentPerStudio,
                        dateAdded: new Date().toISOString(),
                        takenDate: status === 'taken' ? new Date().toISOString() : null
                    };
                    
                    properties.push(newProperty);
                    
                    if (status === 'taken') {
                        takenProperties.add(newId);
                    }
                    
                    logActivity('Added property', `${name} at ${address}`);
                    showToast('Added!', `${name} has been added to the system`);
                }

                savePropertiesToStorage();
                closePropertyModal();
                renderPropertyList();
                populateEligibilityPropertySelector();
                renderLegend();
                updateMarkers();
                populateUpfrontCalculator();
            };

            window.deleteProperty = function(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;

                if (confirm(`Delete "${property.name}"?\n\nThis will also remove all viewings for this property.`)) {
                    properties = properties.filter(p => p.id !== propertyId);
                    takenProperties.delete(propertyId);
                    
                    const viewingsToRemove = viewings.filter(v => v.propertyId === propertyId).length;
                    viewings = viewings.filter(v => v.propertyId !== propertyId);
                    
                    savePropertiesToStorage();
                    saveViewingsToStorage();
                    
                    logActivity('Deleted property', `${property.name} removed from system`);
                    showToast('Deleted!', `Property removed${viewingsToRemove > 0 ? ` (${viewingsToRemove} viewing(s) also removed)` : ''}`);
                    
                    renderPropertyList();
                populateEligibilityPropertySelector();
                    renderLegend();
                    updateMarkers();
                    renderViewingsList();
                    populateUpfrontCalculator();
            populateEligibilityPropertySelector();
                }
            };


            function toggleSalarySection() {
                const employment = document.getElementById('employment-status').value;
                const salarySection = document.getElementById('salary-section');
                const salaryInput = document.getElementById('annual-salary');
                
                if (employment === 'full-time' || employment === 'part-time' || employment === 'self-employed') {
                    salarySection.style.display = 'block';
                    salaryInput.required = true;
                } else {
                    salarySection.style.display = 'none';
                    salaryInput.required = false;
                    salaryInput.value = '';
                }
                
                updateSalaryCalculation();
            }
            
            window.updateSalaryCalculation = function() {
                const salary = parseFloat(document.getElementById('annual-salary')?.value) || 0;
                const calcDiv = document.getElementById('salary-calculation');
                const propertyId = parseInt(document.getElementById('eligibility-property-select')?.value);
                
                if (!salary || !propertyId || !calcDiv) {
                    if (calcDiv) calcDiv.style.display = 'none';
                    return;
                }
                
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const monthlyIncome = salary / 12;
                const rentPercentage = (property.rent / monthlyIncome) * 100;
                const recommended = monthlyIncome * 0.3;
                
                let color = '#2ecc71';
                let status = 'Excellent';
                if (rentPercentage > 30 && rentPercentage <= 40) {
                    color = '#f39c12';
                    status = 'Acceptable';
                } else if (rentPercentage > 40) {
                    color = '#e74c3c';
                    status = 'High Risk';
                }
                
                calcDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">Affordability Check</div>
                    <div>Monthly Income: <strong>£${monthlyIncome.toFixed(2)}</strong></div>
                    <div>Rent as % of income: <strong style="color: ${color}">${rentPercentage.toFixed(1)}%</strong> (${status})</div>
                    <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #ddd;">
                        Recommended max rent: £${recommended.toFixed(2)}/mo (30% rule)
                    </div>
                `;
                calcDiv.style.display = 'block';
            };
            
            window.quickBookFromMap = function(propertyId) {
                selectedProperty = propertyId;
                if (!selectedDate) {
                    selectedDate = new Date();
                    selectedDate.setDate(selectedDate.getDate() + 1);
                }
                
                // Switch to booking tab
                currentTab = 'booking';
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const bookingBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent.includes('Booking'));
                if (bookingBtn) bookingBtn.classList.add('active');
                
                document.getElementById('booking-tab').classList.add('active');
                
                renderCalendar();
                renderTimeSlots();
                renderBookingForm();
                
                showToast('Property Selected', 'Choose a date and time for viewing');
            };

            // Map style layers
            let currentTileLayer;
            const mapStyles = {
                streets: {
                    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    attribution: '© OpenStreetMap contributors'
                },
                satellite: {
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attribution: '© Esri'
                },
                dark: {
                    url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                    attribution: '© OpenStreetMap © CartoDB'
                }
            };
            let currentMapStyle = 'streets';

            function initMap() {
                // Initialize map centered on London with bounds
                map = L.map('map', {
                    center: [51.5074, -0.1278],
                    zoom: 11,
                    minZoom: 10,
                    maxZoom: 18,
                    maxBounds: [[51.2, -0.6], [51.8, 0.3]] // Lock to London area
                });
                
                window.propertyMap = map; // Make globally accessible
                
                // Add default tile layer
                currentTileLayer = L.tileLayer(mapStyles.streets.url, {
                    attribution: mapStyles.streets.attribution,
                    maxZoom: 18
                }).addTo(map);
            }
            
            // Function to change map style
            window.changeMapStyle = function(style) {
                if (mapStyles[style] && currentTileLayer) {
                    map.removeLayer(currentTileLayer);
                    currentTileLayer = L.tileLayer(mapStyles[style].url, {
                        attribution: mapStyles[style].attribution,
                        maxZoom: 18
                    }).addTo(map);
                    currentMapStyle = style;
                    
                    // Update button states
                    document.querySelectorAll('.map-style-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`.map-style-btn[onclick*="${style}"]`)?.classList.add('active');
                }
            };

            window.switchTab = function(tab) {
                currentTab = tab;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.closest('.tab-btn').classList.add('active');
                document.getElementById(tab + '-tab').classList.add('active');
                
                if (tab === 'booking') {
                    renderCalendar();
                } else if (tab === 'viewings') {
                    renderViewingsList();
                } else if (tab === 'pipeline') {
                    renderPipelineTable();
                    updatePipelineMetrics();
                } else if (tab === 'referrals') {
                    renderReferralsTable();
                    updateReferralsMetrics();
                }
            };

            window.toggleBenefitsSection = function(show) {
                document.getElementById('benefits-details').style.display = show ? 'block' : 'none';
    
                // Show/hide property selector based on benefits status
                const propertySelectGroup = document.getElementById('property-select-group');
                const propertySelect = document.getElementById('eligibility-property-select');
                const additionalFundsGroup = document.getElementById('additional-funds-group');
    
                if (show) {
                    // On benefits: hide property selector, show additional funds
                    propertySelectGroup.style.display = 'none';
                    additionalFundsGroup.style.display = 'block';
                    propertySelect.required = false;
                } else {
                    // Not on benefits (private rental): show property selector, hide additional funds
                    propertySelectGroup.style.display = 'block';
                    additionalFundsGroup.style.display = 'none';
                    propertySelect.required = true;
                }
            };

            window.checkAgeRestrictions = function() {
                const age = parseInt(document.getElementById('client-age').value);
                const exemptionSection = document.getElementById('under-35-exemption');
                
                if (age && age < 35) {
                    exemptionSection.style.display = 'block';
                } else {
                    exemptionSection.style.display = 'none';
                    // Clear selection if hidden
                    const radios = document.querySelectorAll('input[name="sar-exemption"]');
                    radios.forEach(r => r.checked = false);
                }
            };

            
            let eligibilitySelectorInitialized = false;
            function populateEligibilityPropertySelector(force = false) {
                const select = document.getElementById('eligibility-property-select');
                if (!select) return;
                select.innerHTML = '<option value="">Choose a property to check eligibility...</option>';

                // Group properties by address
                const addressGroups = {};
                properties.forEach(prop => {
                    if (!takenProperties.has(prop.id)) {
                        const key = prop.address;
                        if (!addressGroups[key]) {
                            addressGroups[key] = [];
                        }
                        addressGroups[key].push(prop);
                    }
                });

                // Create options for each address group
                Object.values(addressGroups).forEach(group => {
                    const firstProp = group[0];
                    const option = document.createElement('option');
                    option.value = firstProp.id;

                    let text = `${firstProp.address}`;
                    if (group.length > 1) {
                        text += ` (${group.length} studios)`;
                    }
                    text += ` - £${firstProp.rent}/mo`;
                    if (firstProp.gender === 'female') {
                        text += ' (Women Only)';
                    }

                    option.textContent = text;
                    select.appendChild(option);
                });

                // Update selectedProperty when selection changes
                select.addEventListener('change', function() {
                    selectedProperty = parseInt(this.value) || null;
                    // keep UI in sync when selection changes
                    updateSalaryCalculation();
                    updateEligibilityPropertyCosts();
                });

                eligibilitySelectorInitialized = true;
            }

            window.updateEligibilityPropertyCosts = function() {
                updateSalaryCalculation();
                const select = document.getElementById('eligibility-property-select');
                const preview = document.getElementById('property-cost-preview');
                const propertyId = parseInt(select.value);
                
                if (!propertyId || !preview) {
                    if (preview) preview.innerHTML = '';
                    return;
                }
                
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const costs = calculateUpfrontCosts(property.rent);
                
                preview.innerHTML = `
                    <div style="background: #f0f7ff; padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary-orange);">
                        <div style="font-weight: 600; margin-bottom: 5px;">💷 Upfront Costs for ${property.name}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div>First Month: <strong>£${costs.monthlyRent.toFixed(2)}</strong></div>
                            <div>Deposit (5 weeks): <strong>£${costs.deposit.toFixed(2)}</strong></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; font-weight: 600; color: var(--primary-orange);">
                            TOTAL UPFRONT: £${costs.total.toFixed(2)}
                        </div>
                    </div>
                `;
            };

            // Handle benefit cap selection changes
            window.handleBenefitCapChange = function() {
                const cappedInput = document.querySelector('input[name="benefit-capped"]:checked');
                const benefitAmountInput = document.getElementById('benefit-amount');
                const benefitAmountGroup = document.getElementById('benefit-amount-group');
                const benefitAmountRequired = document.getElementById('benefit-amount-required');
                const benefitAmountHint = document.getElementById('benefit-amount-hint');
                
                if (!cappedInput) return;
                
                const cappedValue = cappedInput.value;
                
                if (cappedValue === 'yes') {
                    // If capped, auto-fill with cap amount and make it optional
                    benefitAmountInput.value = '1050.33';
                    benefitAmountInput.disabled = true;
                    benefitAmountRequired.textContent = '';
                    benefitAmountHint.innerHTML = '✅ <strong>Capped at £1,050.33/month</strong> - This is the maximum housing benefit you can receive';
                    benefitAmountHint.style.color = '#2ecc71';
                } else if (cappedValue === 'no') {
                    // If uncapped, clear and enable input
                    benefitAmountInput.value = '';
                    benefitAmountInput.disabled = false;
                    benefitAmountInput.placeholder = 'e.g. 1436.02 (Enter your full housing element)';
                    benefitAmountRequired.textContent = '*';
                    benefitAmountHint.innerHTML = '💡 Enter your full <strong>housing element</strong> amount - NO CAP applies to you!';
                    benefitAmountHint.style.color = '#2ecc71';
                } else {
                    // If unsure, enable input with helpful text
                    benefitAmountInput.value = '';
                    benefitAmountInput.disabled = false;
                    benefitAmountInput.placeholder = 'Enter your housing element amount';
                    benefitAmountRequired.textContent = '*';
                    benefitAmountHint.innerHTML = '💡 Enter your <strong>housing element</strong> amount and we\'ll help determine if it\'s capped';
                    benefitAmountHint.style.color = '#666';
                }
            };
            
            window.checkEligibility = function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const name = document.getElementById('client-name').value.trim();
                const gender = document.getElementById('client-gender').value;
                const age = parseInt(document.getElementById('client-age').value);
                const employmentStatus = document.getElementById('employment-status').value;
                const receivingBenefits = document.querySelector('input[name="receiving-benefits"]:checked')?.value;
                const householdSize = parseInt(document.getElementById('household-size').value);
                const childrenCount = parseInt(document.getElementById('children-count').value) || 0;
                
                // Check SAR exemption for under 35s
                let sarExemption = null;
                let isUnder35 = age < 35;
                if (isUnder35) {
                    const sarInput = document.querySelector('input[name="sar-exemption"]:checked');
                    sarExemption = sarInput ? sarInput.value : null;
                    if (sarExemption === null) {
                        alert('❌ Please indicate if you have a Shared Accommodation Rate (SAR) exemption');
                        return false;
                    }
                }
                
                let rentBudget = 0;
                let additionalFunds = 0;
                let propertyRent = 0;
                let selectedProperty = null; // For non-benefit private rentals
                
                if (receivingBenefits === 'yes') {
                    // On benefits: budget is benefit amount + additional funds
                    additionalFunds = parseFloat(document.getElementById('additional-funds').value) || 0;
                    rentBudget = additionalFunds; // We'll add benefit amount later
                } else {
                    // Not on benefits: use full rent budget from selected property
                    const selectedPropertyId = parseInt(document.getElementById('eligibility-property-select')?.value);
                    selectedProperty = properties.find(p => p.id === selectedPropertyId);
                    propertyRent = selectedProperty ? selectedProperty.rent : 0;
                    rentBudget = parseFloat(document.getElementById('rent-budget').value) || propertyRent;
                    
                    // Validate property selection
                    if (!selectedProperty) {
                        alert('⚠ Please select a property');
                        return false;
                    }
                }
                
                if (!name || !gender || !age || !employmentStatus || !receivingBenefits || !householdSize) {
                    alert('⚠ Please fill in all required fields');
                    return false;
                }
                
                // Validate salary for employed people not on benefits
                if (receivingBenefits === 'no') {
                    const employment = document.getElementById('employment-status').value;
                    if (employment === 'full-time' || employment === 'part-time' || employment === 'self-employed') {
                        const salary = parseFloat(document.getElementById('annual-salary').value);
                        if (!salary || salary <= 0) {
                            alert('⚠ Please enter your annual salary');
                            return false;
                        }
                    }
                }
                
                if (false) {
                    alert('❌ Please fill in all required fields');
                    return false;
                }
                
                let benefitType = '';
                let benefitAmount = 0;
                let userSelectedCapped = null;
                let additionalBenefits = [];
                
                if (receivingBenefits === 'yes') {
                    benefitType = document.getElementById('benefit-type').value;
                    const cappedInput = document.querySelector('input[name="benefit-capped"]:checked');
                    userSelectedCapped = cappedInput ? cappedInput.value : null;
                    
                    // If user selected "capped", automatically use the cap amount
                    if (userSelectedCapped === 'yes') {
                        benefitAmount = 1050.33;
                    } else {
                        benefitAmount = parseFloat(document.getElementById('benefit-amount').value) || 0;
                    }
                    
                    const checkedBenefits = document.querySelectorAll('input[name="additional-benefits"]:checked');
                    additionalBenefits = Array.from(checkedBenefits).map(cb => cb.value);
                    
                    // Validate benefit info
                    if (!benefitType) {
                        alert('❌ Please select your benefit type');
                        return false;
                    }
                    
                    // Only require benefit amount if NOT capped (capped is auto-filled)
                    if (userSelectedCapped !== 'yes' && !benefitAmount) {
                        alert('❌ Please enter your monthly benefit amount');
                        return false;
                    }
                    
                    if (!userSelectedCapped) {
                        alert('❌ Please indicate if your benefit is capped');
                        return false;
                    }
                }
                
                let actuallyUncapped = false;
                let capReason = '';
                let autoSarExemption = false;
                
                if (receivingBenefits === 'yes') {
                    const hasPIP = benefitType === 'pip' || additionalBenefits.includes('disability');
                    const hasESA = benefitType === 'esa';
                    const hasLCWRA = benefitType === 'lcwra';
                    const hasCarers = benefitType === 'carers-allowance';
                    const isPartTimeEmployed = employmentStatus === 'part-time';
                    const isOnUC = benefitType === 'universal-credit';
                    
                    // Auto-detect SAR exemption for disability benefits
                    if (isUnder35 && (hasPIP || hasESA || hasLCWRA)) {
                        autoSarExemption = true;
                    }
                    
                    if (hasPIP || hasESA || hasLCWRA || hasCarers) {
                        actuallyUncapped = true;
                        capReason = 'Exempt - NO UPPER LIMIT on benefit award (receives qualifying disability/carer benefits)';
                    } else if (isPartTimeEmployed && isOnUC) {
                        actuallyUncapped = true;
                        capReason = 'Exempt - NO UPPER LIMIT (Part-time employed on Universal Credit)';
                    } else if (userSelectedCapped === 'no') {
                        actuallyUncapped = true;
                        capReason = 'User-confirmed - NO UPPER LIMIT';
                    } else {
                        actuallyUncapped = false;
                        capReason = 'Standard benefit cap applies (£1,050/month limit)';
                    }
                }
                
                // Determine final SAR exemption status
                let hasSarExemption = autoSarExemption || (isUnder35 && sarExemption === 'yes');
                let sarStatus = '';
                if (isUnder35) {
                    if (autoSarExemption) {
                        sarStatus = '✅ Automatic SAR exemption (disability benefits) - ELIGIBLE for self-contained studios';
                    } else if (sarExemption === 'yes') {
                        sarStatus = '✅ Has SAR exemption - ELIGIBLE for self-contained studios';
                    } else {
                        sarStatus = '⚠️ No SAR exemption - Only eligible for SHARED accommodation (not our studios)';
                    }
                }
                
                const benefitCapLimit = 1050;
                let effectiveBenefitAmount = actuallyUncapped ? benefitAmount : Math.min(benefitAmount, benefitCapLimit);
                let cappedAmount = actuallyUncapped ? 0 : Math.max(0, benefitAmount - benefitCapLimit);
                
                // Total budget is benefit + additional funds (for benefit recipients) or just rent budget (for non-recipients)
                let totalBudget = receivingBenefits === 'yes' ? effectiveBenefitAmount + rentBudget : propertyRent;
                
                let allProperties = [];
                
                properties.forEach(prop => {
                    if (takenProperties.has(prop.id)) return;
                    if (prop.gender === 'female' && gender !== 'female') return;
                    
                    const shortfall = receivingBenefits === 'yes' 
                        ? Math.max(0, prop.rent - effectiveBenefitAmount) 
                        : 0; // If not on benefits, they pay full rent themselves
                    
                    const coveragePercent = receivingBenefits === 'yes'
                        ? Math.round((Math.min(effectiveBenefitAmount, prop.rent) / prop.rent) * 100)
                        : 0;
                    
                    allProperties.push({
                        ...prop,
                        shortfall: shortfall,
                        coveragePercent: coveragePercent,
                        uncapped: actuallyUncapped,
                        canAfford: receivingBenefits === 'yes' 
                        ? (effectiveBenefitAmount + additionalFunds) >= prop.rent
                        : true, // If not on benefits, assume they can afford the property they selected
                        isFemaleOnly: prop.gender === 'female'
                    });
                });
                
                // Sort: For female clients, prioritize female-only properties, then by shortfall
                // For other clients, just sort by shortfall
                if (gender === 'female') {
                    allProperties.sort((a, b) => {
                        // Female-only properties first
                        if (a.isFemaleOnly && !b.isFemaleOnly) return -1;
                        if (!a.isFemaleOnly && b.isFemaleOnly) return 1;
                        // Then by shortfall
                        return a.shortfall - b.shortfall;
                    });
                } else {
                    allProperties.sort((a, b) => a.shortfall - b.shortfall);
                }
                
                let status = 'eligible';
                let reasons = [];
                
                // Check gender compatibility with selected property (only for non-benefit private rentals)
                if (selectedProperty && selectedProperty.gender === 'female' && gender !== 'female') {
                    status = 'ineligible';
                    reasons.push('❌ This is a women-only property');
                } else if (selectedProperty && selectedProperty.gender === 'male' && gender !== 'male') {
                    status = 'ineligible';
                    reasons.push('❌ This is a men-only property');
                } else if (age < 18) {
                    status = 'ineligible';
                    reasons.push('❌ Must be 18+');
                } else if (isUnder35 && !hasSarExemption) {
                    status = 'ineligible';
                    reasons.push('❌ Under 35 without SAR exemption - Only eligible for shared accommodation');
                    reasons.push('ℹ️ Our properties are self-contained studios, not suitable for SAR');
                } else {
                    // Check affordability for selected property (if applicable)
                    if (selectedProperty) {
                        const propertyShortfall = receivingBenefits === 'yes' 
                            ? Math.max(0, selectedProperty.rent - effectiveBenefitAmount - additionalFunds)
                            : 0;
                    }
                    
                    if (isUnder35) {
                        reasons.push(sarStatus);
                    }
                    
                    // Add property affordability info (only for non-benefit private rentals with selected property)
                    if (selectedProperty && receivingBenefits === 'no') {
                        reasons.push(`🏠 Selected: ${selectedProperty.name} - £${selectedProperty.rent}/mo`);
                    } else if (selectedProperty && receivingBenefits === 'yes') {
                        const benefitCoverage = Math.min(effectiveBenefitAmount, selectedProperty.rent);
                        const coveragePercent = Math.round((benefitCoverage / selectedProperty.rent) * 100);
                        const shortfall = Math.max(0, selectedProperty.rent - effectiveBenefitAmount);
                        
                        reasons.push(`🏠 ${selectedProperty.name}: £${selectedProperty.rent}/mo`);
                        reasons.push(`💷 Benefit covers: £${benefitCoverage.toFixed(2)} (${coveragePercent}%)`);
                        
                        if (shortfall > 0) {
                            if (additionalFunds >= shortfall) {
                                reasons.push(`✅ Shortfall: £${shortfall.toFixed(2)}/mo - Covered by additional funds`);
                            } else {
                                reasons.push(`⚠️ Shortfall: £${shortfall.toFixed(2)}/mo - Need £${(shortfall - additionalFunds).toFixed(2)} more`);
                            }
                        } else {
                            reasons.push('✅ Fully covered by benefit');
                        }
                    }
                    
                    if (receivingBenefits === 'yes') {
                        reasons.push(actuallyUncapped ? '✅ ' + capReason : '⚠️ ' + capReason);
                        if (cappedAmount > 0) {
                            reasons.push(`💰 Reduced by £${cappedAmount.toFixed(2)}/mo`);
                        }
                    }
                    
                    const perfect = allProperties.filter(p => p.shortfall === 0).length;
                    const low = allProperties.filter(p => p.shortfall > 0 && p.shortfall <= 50).length;
                    const medium = allProperties.filter(p => p.shortfall > 50 && p.shortfall <= 150).length;
                    
                    if (perfect > 0) reasons.push(`✅ ${perfect} fully covered`);
                    if (low > 0) reasons.push(`💚 ${low} with £0-50 shortfall`);
                    if (medium > 0) reasons.push(`💛 ${medium} with £50-150 shortfall`);
                }
                
                currentClientData = {
                    name, gender, age, employmentStatus, receivingBenefits,
                    benefitType, benefitAmount, effectiveBenefitAmount,
                    actuallyUncapped, capReason, cappedAmount,
                    householdSize, childrenCount, rentBudget,
                    additionalBenefits, totalBudget, isUnder35, hasSarExemption, sarStatus
                };
                
                displayEligibilityResult({
                    status, name, gender, age, employmentStatus, receivingBenefits,
                    benefitType, benefitAmount, effectiveBenefitAmount,
                    actuallyUncapped, capReason, cappedAmount, householdSize,
                    childrenCount, rentBudget, reasons, additionalBenefits, totalBudget,
                    isUnder35, hasSarExemption, sarStatus
                }, selectedProperty);
                
                // Show suggested properties for benefit recipients, hide for non-benefit private rentals
                if (status === 'eligible' && receivingBenefits === 'yes') {
                    displaySuggestedProperties(allProperties);
                } else {
                    document.getElementById('suggested-properties').innerHTML = '';
                }
                
                document.getElementById('eligibility-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                return false;
            };

            function displayEligibilityResult(data, selectedProperty) {
                const container = document.getElementById('eligibility-result');
                const statusIcons = { eligible: '✓', ineligible: '✗', review: '⚠' };
                const statusTitles = {
                    eligible: 'Eligible',
                    ineligible: 'Not Eligible',
                    review: 'Review Required'
                };
                
                let html = `
                    <div class="result-card ${data.status}">
                        <div class="result-header">
                            <div class="result-icon ${data.status}">${statusIcons[data.status]}</div>
                            <div>
                                <div class="result-title">${statusTitles[data.status]}</div>
                                <div class="result-subtitle">${data.name}</div>
                            </div>
                        </div>
                        <div class="result-details">
                            <div class="detail-item">
                                <div class="detail-label">Personal</div>
                                <div class="detail-value">${data.age}y • ${data.gender} • ${data.employmentStatus.replace('-', ' ')}</div>
                            </div>`;
                            
                if (data.isUnder35) {
                    const bgColor = data.hasSarExemption ? '#d4edda' : '#fff3cd';
                    const textColor = data.hasSarExemption ? '#155724' : '#856404';
                    html += `
                            <div class="detail-item" style="background: ${bgColor};">
                                <div class="detail-label">SAR Status (Under 35)</div>
                                <div class="detail-value" style="color: ${textColor}; font-size: 12px; line-height: 1.4;">
                                    ${data.sarStatus}
                                </div>
                            </div>`;
                }
                
                html += `
                            <div class="detail-item">
                                <div class="detail-label">Household</div>
                                <div class="detail-value">${data.householdSize} person(s)${data.childrenCount > 0 ? ` • ${data.childrenCount} child(ren)` : ''}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Selected Property</div>
                                <div class="detail-value">${selectedProperty ? selectedProperty.name + ' - £' + selectedProperty.rent.toFixed(2) + '/mo' : 'None'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Budget</div>
                                <div class="detail-value">`;
                
                if (data.receivingBenefits === 'yes') {
                    html += `£${data.effectiveBenefitAmount.toFixed(2)}/mo (benefit)`;
                    if (data.rentBudget > 0) {
                        html += ` + £${data.rentBudget.toFixed(2)} (additional) = £${(data.effectiveBenefitAmount + data.rentBudget).toFixed(2)} total`;
                    }
                } else {
                    html += selectedProperty ? `£${selectedProperty.rent.toFixed(2)}/mo (property rent)` : 'Not specified';
                }
                
                html += `</div>
                            </div>`;
                
                if (data.receivingBenefits === 'yes') {
                    html += `
                            <div class="detail-item" style="background: ${data.actuallyUncapped ? '#d4edda' : '#fff3cd'};">
                                <div class="detail-label">Benefit</div>
                                <div class="detail-value">${data.benefitType.toUpperCase().replace(/-/g, ' ')}</div>
                            </div>
                            <div class="detail-item" style="background: ${data.actuallyUncapped ? '#d4edda' : '#fff3cd'};">
                                <div class="detail-label">Cap Status</div>
                                <div class="detail-value" style="color: ${data.actuallyUncapped ? '#2ecc71' : '#f39c12'};">
                                    ${data.actuallyUncapped ? 'UNCAPPED ✓' : 'CAPPED ⚠'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Effective Benefit</div>
                                <div class="detail-value">£${data.effectiveBenefitAmount.toFixed(2)}/mo</div>
                            </div>`;
                }
                
                if (selectedProperty) {
                    const costs = calculateUpfrontCosts(selectedProperty.rent);
                    html += `
                            <div class="upfront-costs-card">
                                <h4><i class="fas fa-pound-sign"></i> Upfront Costs for ${selectedProperty.name}</h4>
                                <div class="cost-row">
                                    <span>First Month:</span>
                                    <span>£${costs.monthlyRent.toFixed(2)}</span>
                                </div>
                                <div class="cost-row">
                                    <span>Deposit (5 weeks):</span>
                                    <span>£${costs.deposit.toFixed(2)}</span>
                                </div>
                                <div class="cost-row">
                                    <span>TOTAL:</span>
                                    <span>£${costs.total.toFixed(2)}</span>
                                </div>
                            </div>`;
                }
                
                html += `</div>`;
                
                if (data.reasons.length > 0) {
                    html += `
                        <div class="requirements-list">
                            <h4>Summary:</h4>
                            <ul>
                                ${data.reasons.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                
                html += `
                    <button onclick="exportEligibilityResults()" style="width: 100%; margin-top: 15px; padding: 10px; background: #8E1616; color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-envelope"></i> Copy Full Entitlement Details for Email
                    </button>
                </div>`;
                
                container.innerHTML = html;
            }

            function displaySuggestedProperties(allProps) {
                const container = document.getElementById('suggested-properties');
                
                if (allProps.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No suitable properties</p></div>';
                    return;
                }
                
                const femaleOnlyCount = allProps.filter(p => p.isFemaleOnly).length;
                const isFemaleClient = currentClientData && currentClientData.gender === 'female';
                
                let html = `
                    <div class="suggested-properties">
                        <h3><i class="fas fa-home"></i> Available (${allProps.length})</h3>
                        ${isFemaleClient && femaleOnlyCount > 0 ? `
                        <div style="background: #fff0f6; border-left: 3px solid #ff69b4; padding: 8px 10px; margin-bottom: 10px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #c2185b; font-weight: 600;">
                                <i class="fas fa-star"></i> ${femaleOnlyCount} Women-Only Properties (shown first)
                            </div>
                        </div>
                        ` : ''}
                        <p style="font-size: 11px; color: #666; margin-bottom: 15px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #2ecc71; border-radius: 2px; margin-right: 5px;"></span> £0
                            <span style="display: inline-block; width: 12px; height: 12px; background: #fbbf24; border-radius: 2px; margin: 0 5px 0 15px;"></span> £1-50
                            <span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin: 0 5px 0 15px;"></span> £51-150
                            <span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 2px; margin: 0 5px 0 15px;"></span> £150+
                        </p>
                `;
                
                allProps.forEach(prop => {
                    let shortfallClass = 'perfect';
                    let badgeClass = 'perfect';
                    let badgeText = '£0 ✓';
                    
                    if (prop.shortfall > 0 && prop.shortfall <= 50) {
                        shortfallClass = 'low-shortfall';
                        badgeClass = 'low-shortfall';
                        badgeText = `£${prop.shortfall.toFixed(0)}`;
                    } else if (prop.shortfall > 50 && prop.shortfall <= 150) {
                        shortfallClass = 'high-shortfall';
                        badgeClass = 'low-shortfall';
                        badgeText = `£${prop.shortfall.toFixed(0)}`;
                    } else if (prop.shortfall > 150) {
                        shortfallClass = 'high-shortfall';
                        badgeClass = 'high-shortfall';
                        badgeText = `£${prop.shortfall.toFixed(0)}`;
                    }
                    
                    const costs = calculateUpfrontCosts(prop.rent);
                    
                    html += `
                        <div class="suggestion-item ${shortfallClass}">
                            <div class="suggestion-header">
                                <div class="suggestion-name">
                                    ${prop.name}
                                    ${prop.gender === 'female' ? '<span class="gender-badge">👩 Women</span>' : ''}
                                </div>
                                <div class="suggestion-rent">£${prop.rent}/mo</div>
                            </div>
                            <div class="suggestion-address">${prop.address}</div>
                            <div class="suggestion-details">
                                <div>${prop.borough}</div>
                                <div><span class="suggestion-badge ${badgeClass}">${badgeText}</span></div>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                                Coverage: ${prop.coveragePercent}% • Upfront: £${costs.total.toFixed(0)}
                            </div>
                            <div class="suggestion-actions">
                                <button class="quick-book-btn" onclick="quickBookProperty(${prop.id})">
                                    <i class="fas fa-calendar-plus"></i> Quick Book
                                </button>
                                <button class="view-details-btn" onclick="viewPropertyDetails(${prop.id})">
                                    <i class="fas fa-map-marker-alt"></i> Map
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                container.innerHTML = html;
            }

            window.quickBookProperty = function(propertyId) {
                selectedProperty = propertyId;
                if (!selectedDate) {
                    selectedDate = new Date();
                    selectedDate.setDate(selectedDate.getDate() + 1);
                }
                
                switchToBookingTab();
                renderCalendar();
                renderTimeSlots();
                renderBookingForm();
                
                if (currentClientData && currentClientData.name) {
                    setTimeout(() => {
                        const nameField = document.getElementById('visitor-name');
                        if (nameField) nameField.value = currentClientData.name;
                    }, 100);
                }
            };

            window.viewPropertyDetails = function(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (property) {
                    map.setView([property.lat, property.lng], 16);
                    const marker = Object.values(markers).find(m => {
                        const latlng = m.getLatLng();
                        return Math.abs(latlng.lat - property.lat) < 0.0001 && Math.abs(latlng.lng - property.lng) < 0.0001;
                    });
                    if (marker) marker.openPopup();
                }
            };

            function getPropertyViewings(propertyId) {
                return viewings.filter(v => v.propertyId === propertyId);
            }

            function renderPropertyList() {
                const listDiv = document.getElementById('property-list');
                if (!listDiv) {
                    // property-list doesn't exist in new tabbed UI - that's OK
                    console.log('[UI] property-list not found - using tabbed sidebar instead');
                    return;
                }
                
                listDiv.innerHTML = '';
                
                // Filter properties
                let filteredProps = properties.filter(p => {
                    if (currentFilter === 'available') return !takenProperties.has(p.id);
                    if (currentFilter === 'taken') return takenProperties.has(p.id);
                    return true;
                });
                
                // Sort properties based on current sort order
                let sortedProps = [...filteredProps];
                
                switch(currentSortOrder) {
                    case 'recent':
                        sortedProps.sort((a, b) => {
                            const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
                            const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
                            return dateB - dateA; // Most recent first
                        });
                        break;
                    case 'oldest':
                        sortedProps.sort((a, b) => {
                            const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
                            const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
                            return dateA - dateB; // Oldest first
                        });
                        break;
                    case 'alpha-asc':
                        sortedProps.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'alpha-desc':
                        sortedProps.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'price-high':
                        sortedProps.sort((a, b) => b.rent - a.rent);
                        break;
                    case 'price-low':
                        sortedProps.sort((a, b) => a.rent - b.rent);
                        break;
                    case 'borough':
                        sortedProps.sort((a, b) => a.borough.localeCompare(b.borough));
                        break;
                }
                
                // Group by borough if sort is by borough
                if (currentSortOrder === 'borough') {
                    const boroughs = [...new Set(sortedProps.map(p => p.borough))].sort();
                    
                    boroughs.forEach(borough => {
                        const boroughProps = sortedProps.filter(p => p.borough === borough);
                        if (boroughProps.length === 0) return;

                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'borough-group';
                        const available = boroughProps.filter(p => !takenProperties.has(p.id)).length;
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'borough-header';
                        if (boroughCollapsedState[borough]) {
                            headerDiv.classList.add('collapsed');
                        }
                        headerDiv.setAttribute('data-borough', borough);
                        headerDiv.onclick = () => toggleBorough(borough);
                        headerDiv.innerHTML = `
                            <div class="legend-color" style="background-color: ${boroughColors[borough] || '#999'}"></div>
                            <span>${borough}</span>
                            <span class="borough-count">${available}/${boroughProps.length}</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        `;
                        groupDiv.appendChild(headerDiv);

                        const propertiesContainer = document.createElement('div');
                        propertiesContainer.className = 'borough-properties';
                        propertiesContainer.id = `borough-properties-${borough}`;
                        if (boroughCollapsedState[borough]) {
                            propertiesContainer.classList.add('collapsed');
                        }

                        boroughProps.forEach(property => {
                            propertiesContainer.appendChild(createPropertyCard(property));
                        });
                        
                        groupDiv.appendChild(propertiesContainer);
                        listDiv.appendChild(groupDiv);
                    });
                } else {
                    // Flat list for other sort orders
                    sortedProps.forEach(property => {
                        listDiv.appendChild(createPropertyCard(property));
                    });
                }

                const availableCount = properties.filter(p => !takenProperties.has(p.id)).length;
                
                // Update header stats
                document.getElementById('available-count').textContent = availableCount;
                
                // Update sidebar stats  
                const totalEl = document.getElementById('total-properties-sidebar');
                const availableEl = document.getElementById('available-properties-sidebar');
                const takenEl = document.getElementById('taken-properties-sidebar');
                
                if (totalEl) totalEl.textContent = properties.length;
                if (availableEl) availableEl.textContent = availableCount;
                if (takenEl) takenEl.textContent = takenProperties.size;
            }
            
            // Create property card with age indicator
            function createPropertyCard(property) {
                const propViewings = getPropertyViewings(property.id);
                const hasViewing = propViewings.length > 0;
                const hasVirtual = propViewings.some(v => v.viewingType === 'virtual');
                const propStatus = getPropertyStatus(property.id);
                const propHistory = getPropertyHistory(property.id);
                
                // Calculate property age
                const age = getPropertyAge(property);
                const ageColor = getPropertyAgeColor(age);
                const ageLabel = getPropertyAgeLabel(age);
                
                // Extract studio number from property name
                const studioMatch = property.name.match(/Studio\s+(\w+)/i);
                const studioNumber = studioMatch ? studioMatch[1] : 'N/A';
                
                // Format date added
                const dateAdded = property.dateAdded ? new Date(property.dateAdded).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Unknown';
                
                // Status badge HTML
                let statusBadge = '';
                switch(propStatus) {
                    case 'taken':
                        statusBadge = '<div class="status-badge taken">✓ TAKEN</div>';
                        break;
                    case 'viewing-scheduled':
                        statusBadge = '<div class="status-badge viewing">📅 VIEWING</div>';
                        break;
                    case 'maintenance':
                        statusBadge = '<div class="status-badge maintenance">🔧 MAINTENANCE</div>';
                        break;
                    default:
                        statusBadge = '<div class="status-badge available">✓ AVAILABLE</div>';
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `property-item ${takenProperties.has(property.id) ? 'taken' : ''} ${hasViewing ? 'has-viewing' : ''} ${property.gender === 'female' ? 'women-only' : ''} ${propStatus === 'taken' ? 'prop-taken' : ''}`;
                itemDiv.style.borderLeft = `4px solid ${ageColor}`;
                
                itemDiv.innerHTML = `
                    <div class="property-actions">
                        <button class="property-action-btn history-btn" onclick="showPropertyHistory(${property.id}); event.stopPropagation();" title="View History (${propHistory.length})">
                            <i class="fas fa-history"></i>
                            ${propHistory.length > 0 ? `<span class="history-count">${propHistory.length}</span>` : ''}
                        </button>
                        <button class="property-action-btn edit-btn" onclick="openEditPropertyModal(${property.id}); event.stopPropagation();" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="property-action-btn delete-btn" onclick="deleteProperty(${property.id}); event.stopPropagation();" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    ${statusBadge}
                    
                    <!-- Age Indicator Badge -->
                    <div style="position: absolute; top: 35px; right: 8px; background: ${ageColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: 700; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        ${age}d ${age > 35 ? '⚠️' : ''}
                    </div>
                    
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="checkbox" ${takenProperties.has(property.id) ? 'checked' : ''} 
                            onchange="toggleProperty(${property.id})" onclick="event.stopPropagation()">
                    </div>
                    <div class="property-details" onclick="showPropertyDetails(${property.id}); event.stopPropagation();" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div>
                                <div style="font-weight: 700; font-size: 13px; color: var(--primary-orange);">Studio ${studioNumber}</div>
                                <div style="font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px;">${property.floor || 'N/A'} ${property.lift ? '• LIFT' : ''}</div>
                            </div>
                            <div style="font-size: 12px; color: #2ecc71; font-weight: 700;">£${property.rent}/mo</div>
                        </div>
                        
                        <!-- Date Added with Age -->
                        <div style="font-size: 9px; color: #666; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <span style="display: inline-block; width: 6px; height: 6px; background: ${ageColor}; border-radius: 50%;"></span>
                            <span>Added: ${dateAdded} (${ageLabel})</span>
                        </div>
                        
                        <div class="property-address" style="font-size: 11px; color: #666; margin-bottom: 5px; line-height: 1.3;">${property.address}</div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                            ${property.link ? `<a href="${property.link}" target="_blank" class="property-link" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i> Photos</a>` : ''}
                            ${hasViewing ? `<div class="viewing-badge">📅 ${propViewings.length}</div>` : ''}
                            ${hasVirtual ? `<div class="virtual-badge">📹 Virtual</div>` : ''}
                            ${property.gender === 'female' ? '<div class="gender-badge">👩 Women</div>' : ''}
                        </div>
                        ${propStatus !== 'taken' && propStatus !== 'maintenance' ? `<button class="book-btn" onclick="selectPropertyForBooking(${property.id}); event.stopPropagation()">📅 Book Viewing</button>` : ''}
                    </div>
                `;
                
                return itemDiv;
            }

            function updateMarkers() {
                if (!map) {
                    console.warn('[MAP] Map not initialized yet, skipping marker update');
                    return;
                }
                
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};
                
                const addressGroups = {};
                properties.forEach(property => {
                    if (takenProperties.has(property.id)) return;
                    const key = property.address;
                    if (!addressGroups[key]) addressGroups[key] = [];
                    addressGroups[key].push(property);
                });

                let markerCount = 0;
                Object.values(addressGroups).forEach(group => {
                    const firstProp = group[0];
                    
                    // Calculate age of property for color coding
                    const dateAdded = new Date(firstProp.dateAdded || Date.now());
                    const age = Math.floor((Date.now() - dateAdded) / (1000 * 60 * 60 * 24));
                    
                    // Age-based SHAPE coding for markers
                    let markerHtml, iconSize, iconAnchor;
                    
                    if (age <= 14) {
                        // GREEN CIRCLE - New properties (0-14 days)
                        markerHtml = `<div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; animation: pulse-green 2s infinite;">${group.length}</div>`;
                        iconSize = [36, 36];
                        iconAnchor = [18, 18];
                    } else if (age <= 28) {
                        // YELLOW DIAMOND - Medium age (15-28 days)
                        markerHtml = `<div style="position: relative; width: 36px; height: 36px;">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b, #d97706); transform: rotate(45deg); border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.4); animation: pulse-yellow 2s infinite;"></div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 14px; pointer-events: none;">${group.length}</div>
                        </div>`;
                        iconSize = [36, 36];
                        iconAnchor = [18, 18];
                    } else {
                        // RED TRIANGLE - Old properties (28+ days)
                        markerHtml = `<div style="position: relative; width: 44px; height: 38px; display: flex; align-items: center; justify-content: center;">
                            <svg width="44" height="38" viewBox="0 0 44 38" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); animation: pulse-red 2s infinite;">
                                <polygon points="22,2 42,36 2,36" fill="url(#redGrad)" stroke="white" stroke-width="3"/>
                                <defs>
                                    <linearGradient id="redGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div style="position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 14px; pointer-events: none;">${group.length}</div>
                        </div>`;
                        iconSize = [44, 38];
                        iconAnchor = [22, 36];
                    }
                    
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: markerHtml,
                        iconSize: iconSize,
                        iconAnchor: iconAnchor
                    });

                    let popupContent = `<div style="padding: 15px; min-width: 250px;">`;
                    if (group.length > 1) {
                        popupContent += `<div style="font-weight: 700; margin-bottom: 8px; color: white; font-size: 15px;">${firstProp.address}</div>`;
                        const availableInGroup = group.filter(p => !takenProperties.has(p.id)).length;
                        popupContent += `<div style="font-size: 18px; font-weight: 700; color: var(--primary-red); margin: 10px 0;">£${firstProp.rent}/mo</div>`;
                        popupContent += `<div style="display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap;">`;
                        popupContent += `<span style="padding: 6px 12px; background: ${age <= 14 ? '#10b981' : age <= 30 ? '#f59e0b' : '#ef4444'}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${age}d ${age <= 14 ? 'New' : age <= 30 ? 'Medium' : 'Old'}</span>`;
                        popupContent += `<span style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${group.length} units</span>`;
                        popupContent += `<span style="padding: 6px 12px; background: ${availableInGroup > 0 ? '#10b981' : '#ef4444'}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">${availableInGroup} available</span>`;
                        popupContent += `</div>`;
                        if (group.length > 1) {
                            popupContent += `<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin: 10px 0;">`;
                            popupContent += `<div style="font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); margin-bottom: 6px;">Studios at this location:</div>`;
                            group.forEach(p => {
                                const isTaken = takenProperties.has(p.id);
                                popupContent += `<div style="font-size: 11px; color: ${isTaken ? '#999' : '#10b981'}; margin-bottom: 3px;">${isTaken ? '✗' : '✓'} ${p.name} - ${p.floor || 'GF'} Floor</div>`;
                            });
                            popupContent += `</div>`;
                        }
                    } else {
                        popupContent += `<div style="font-weight: 700; color: white; font-size: 16px;">${firstProp.name}</div>`;
                        popupContent += `<div style="font-size: 13px; color: rgba(255,255,255,0.9); margin: 8px 0;">${firstProp.address}</div>`;
                        popupContent += `<div style="font-size: 18px; font-weight: 700; color: var(--primary-red); margin: 8px 0;">£${firstProp.rent}/month</div>`;
                        popupContent += `<div style="display: flex; gap: 8px; align-items: center; margin: 8px 0;">`;
                        popupContent += `<div style="padding: 4px 10px; background: ${age <= 14 ? '#10b981' : age <= 30 ? '#f59e0b' : '#ef4444'}; color: white; border-radius: 12px; font-size: 11px; font-weight: 600;">${age}d old</div>`;
                        if (firstProp.gender === 'female') {
                            popupContent += `<div style="font-size: 11px; color: #fbbf24; font-weight: 600;">👩 Women Only</div>`;
                        }
                        popupContent += `</div>`;
                    }
                    if (firstProp.link) {
                        popupContent += `<a href="${firstProp.link}" target="_blank" style="font-size: 12px; color: var(--primary-red); text-decoration: none; font-weight: 600; display: inline-block; margin: 8px 0;">📸 View Photos →</a><br>`;
                    }
                    popupContent += `
                            <button onclick="openEditPropertyModal(${firstProp.id}); event.stopPropagation();" style="width: 100%; margin-top: 12px; padding: 12px; background: var(--primary-red); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                ✏️ Edit Property
                            </button>
                        </div>`;

                    const marker = L.marker([firstProp.lat, firstProp.lng], { icon: icon })
                        .bindPopup(popupContent, {
                            className: 'custom-popup',
                            maxWidth: 300
                        })
                        .addTo(map);
                    markers[firstProp.address] = marker;
                    markerCount++;
                });
                
                const totalProps = Object.values(addressGroups).reduce((sum, group) => sum + group.length, 0);
                console.log('[MAP] Added', markerCount, 'marker groups representing', totalProps, 'properties');
            }

            function renderCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                document.getElementById('month-year').textContent = `${monthNames[month]} ${year}`;

                const calendar = document.getElementById('calendar');
                calendar.innerHTML = '';
                
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.textContent = day;
                    calendar.appendChild(header);
                });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell other-month';
                    calendar.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = formatDateForStorage(date);
                    const dayViewings = viewings.filter(v => v.date === dateStr);
                    
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.textContent = day;
                    
                    const cellDate = new Date(year, month, day);
                    cellDate.setHours(0, 0, 0, 0);
                    
                    if (cellDate.getTime() === today.getTime()) {
                        cell.classList.add('today');
                    }
                    if (selectedDate && formatDateForStorage(selectedDate) === dateStr) {
                        cell.classList.add('selected');
                    }
                    if (dayViewings.length > 0) {
                        cell.classList.add('has-viewings');
                        const badge = document.createElement('div');
                        badge.className = 'viewing-count';
                        badge.textContent = dayViewings.length;
                        cell.appendChild(badge);
                    }
                    if (cellDate >= today) {
                        cell.onclick = () => selectDate(date);
                    } else {
                        cell.style.opacity = '0.3';
                        cell.style.cursor = 'not-allowed';
                    }
                    calendar.appendChild(cell);
                }
            }

            // FIXED: Proper date formatting to avoid timezone issues
            function formatDateForStorage(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function selectDate(date) {
                selectedDate = date;
                renderCalendar();
                renderTimeSlots();
            }

            function renderTimeSlots() {
                const container = document.getElementById('time-slots-container');
                if (!selectedDate) {
                    container.innerHTML = '';
                    return;
                }

                const dateStr = formatDateForStorage(selectedDate);
                container.innerHTML = '<h4 style="font-size: 14px; margin-bottom: 10px; color: #333;">Select Time</h4>';
                
                const slotsDiv = document.createElement('div');
                slotsDiv.className = 'time-slots';

                timeSlots.forEach(time => {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    
                    const isPropertyBooked = selectedProperty ? 
                        viewings.some(v => v.date === dateStr && v.time === time && v.propertyId === selectedProperty) : 
                        false;
                    
                    const viewingsAtThisTime = viewings.filter(v => v.date === dateStr && v.time === time).length;
                    
                    if (isPropertyBooked) {
                        slot.classList.add('booked');
                        slot.innerHTML = `${time}<br><small>Booked</small>`;
                    } else {
                        if (viewingsAtThisTime > 0) {
                            slot.innerHTML = `${time}<br><small style="color: #2ecc71; font-size: 9px;">${viewingsAtThisTime} other${viewingsAtThisTime > 1 ? 's' : ''}</small>`;
                        } else {
                            slot.textContent = time;
                        }
                        
                        if (selectedTime === time) {
                            slot.classList.add('selected');
                        }
                        slot.onclick = () => {
                            selectedTime = time;
                            renderTimeSlots();
                            renderBookingForm();
                        };
                    }
                    slotsDiv.appendChild(slot);
                });
                container.appendChild(slotsDiv);
            }

            function renderBookingForm() {
                const container = document.getElementById('booking-form-container');
                if (!selectedDate || !selectedTime) {
                    container.innerHTML = '';
                    return;
                }

                const property = selectedProperty ? properties.find(p => p.id === selectedProperty) : null;
                const prefilledName = currentClientData ? currentClientData.name : '';
                
                container.innerHTML = `
                    <div class="booking-form">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: #333;">Booking Details</h4>
                        <div class="form-group">
                            <label>Property *</label>
                            <select id="property-select" onchange="selectedProperty = parseInt(this.value)">
                                <option value="">Select property</option>
                                ${properties.filter(p => !takenProperties.has(p.id)).map(p => 
                                    `<option value="${p.id}" ${property && p.id === property.id ? 'selected' : ''}>${p.name} - £${p.rent}/mo${p.gender === 'female' ? ' (Women Only)' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Viewing Type *</label>
                            <select id="viewing-type" required>
                                <option value="">Select...</option>
                                <option value="in-person">🏠 In-Person Viewing</option>
                                <option value="virtual">📹 Virtual Viewing (Video Call)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Your Name *</label>
                            <input type="text" id="visitor-name" placeholder="John Doe" value="${prefilledName}">
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="visitor-email" placeholder="john@example.com">
                        </div>
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" id="visitor-phone" placeholder="+44 7xxx xxxxxx">
                        </div>
                        <div class="form-group">
                            <label>How did you hear about us? (Referral Source)</label>
                            <select id="referral-source">
                                <option value="">Select...</option>
                                <option value="google">🔍 Google Search</option>
                                <option value="facebook">📘 Facebook</option>
                                <option value="instagram">📸 Instagram</option>
                                <option value="rightmove">🏡 Rightmove</option>
                                <option value="zoopla">🏠 Zoopla</option>
                                <option value="openrent">📋 OpenRent</option>
                                <option value="spareroom">🚪 SpareRoom</option>
                                <option value="friend">👥 Friend/Family Referral</option>
                                <option value="previous-tenant">🔁 Previous Tenant</option>
                                <option value="council">🏛️ Council Referral</option>
                                <option value="charity">❤️ Charity/Support Service</option>
                                <option value="walk-in">🚶 Walk-in/Saw Sign</option>
                                <option value="other">📝 Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <input type="text" id="visitor-notes" placeholder="Any special requirements">
                        </div>
                        <button class="submit-btn" onclick="confirmBooking()"><i class="fas fa-calendar-check"></i> Confirm</button>
                    </div>
                `;
            }

            window.selectPropertyForBooking = function(propertyId) {
                selectedProperty = propertyId;
                if (!selectedDate) {
                    selectedDate = new Date();
                    selectedDate.setDate(selectedDate.getDate() + 1);
                }
                
                switchToBookingTab();
                renderCalendar();
                renderTimeSlots();
                renderBookingForm();
            };

            function switchToBookingTab() {
                currentTab = 'booking';
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const bookingBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent.includes('Booking'));
                if (bookingBtn) bookingBtn.classList.add('active');
                
                document.getElementById('booking-tab').classList.add('active');
            }

            // ============================================
            // INTELLIGENT ROUTING & SCHEDULING SYSTEM
            // ============================================
            
            // Driver configuration - split London into North/South zones
            const DRIVERS = {
                north: {
                    name: "Driver 1 (North)",
                    zone: "north",
                    maxViewings: 8, // per day
                    workHours: { start: "09:00", end: "17:00" }
                },
                south: {
                    name: "Driver 2 (South)",
                    zone: "south", 
                    maxViewings: 8,
                    workHours: { start: "09:00", end: "17:00" }
                }
            };
            
            // UK Fuel Prices (pence per litre) - Updated daily
            const UK_FUEL_PRICES = {
                unleaded: 134.82,        // p/litre
                diesel: 142.37,          // p/litre
                superUnleaded: 151.31,   // p/litre
                premiumDiesel: 163.05    // p/litre
            };
            
            // Vehicle assumptions for UK
            const VEHICLE_CONFIG = {
                fuelType: 'diesel',      // Most company vehicles use diesel
                mpg: 45,                 // Miles per gallon (UK average)
                avgSpeedLondon: 20,      // km/h in London (reduced from 25 for accuracy)
                avgSpeedMotorway: 100,   // km/h on motorways
                parkingBuffer: 5,        // minutes for parking/navigation
                viewingDuration: 30      // minutes per viewing
            };
            
            // Calculate fuel cost based on UK prices
            function calculateFuelCost(distanceKm) {
                const distanceMiles = distanceKm * 0.621371; // Convert km to miles
                const litresUsed = distanceMiles / VEHICLE_CONFIG.mpg * 4.54609; // Convert MPG to litres
                const fuelPricePerLitre = UK_FUEL_PRICES[VEHICLE_CONFIG.fuelType] / 100; // Convert pence to pounds
                return litresUsed * fuelPricePerLitre;
            }
            
            // London center: roughly divides North/South
            const LONDON_CENTER_LAT = 51.5074;
            
            // Classify property into North or South zone
            function getPropertyZone(property) {
                return property.lat >= LONDON_CENTER_LAT ? 'north' : 'south';
            }
            
            // Calculate distance between two points using Haversine formula (in km)
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            // Calculate estimated travel time between properties (minutes)
            function calculateTravelTime(property1, property2) {
                const distance = calculateDistance(
                    property1.lat, property1.lng,
                    property2.lat, property2.lng
                );
                // Use UK London traffic speed
                const travelMinutes = (distance / VEHICLE_CONFIG.avgSpeedLondon) * 60;
                // Add parking/navigation buffer
                return Math.ceil(travelMinutes + VEHICLE_CONFIG.parkingBuffer);
            }
            
            // Parse time string to minutes since midnight
            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            // Convert minutes to time string
            function minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            }
            
            // Check if two time slots conflict (with travel time buffer)
            function hasTimeConflict(viewing1, viewing2, travelBuffer = 30) {
                if (viewing1.date !== viewing2.date) return false;
                
                const time1 = timeToMinutes(viewing1.time);
                const time2 = timeToMinutes(viewing2.time);
                
                // Each viewing takes 30 minutes + travel time buffer
                const viewingDuration = 30;
                const totalBuffer = viewingDuration + travelBuffer;
                
                return Math.abs(time1 - time2) < totalBuffer;
            }
            
            // Get all viewings for a specific driver on a date
            function getDriverViewings(driver, date) {
                const dateStr = formatDateForStorage(date);
                return viewings.filter(v => {
                    const property = properties.find(p => p.id === v.propertyId);
                    if (!property) return false;
                    const propertyZone = getPropertyZone(property);
                    return v.date === dateStr && propertyZone === driver.zone;
                }).sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            }
            
            // Detect conflicts for a new viewing
            function detectConflicts(newViewing) {
                const conflicts = [];
                const newProperty = properties.find(p => p.id === newViewing.propertyId);
                if (!newProperty) return conflicts;
                
                const newZone = getPropertyZone(newProperty);
                const driver = DRIVERS[newZone];
                const existingViewings = getDriverViewings(driver, new Date(newViewing.date));
                
                // Check driver capacity
                if (existingViewings.length >= driver.maxViewings) {
                    conflicts.push({
                        type: 'capacity',
                        message: `${driver.name} is fully booked (${driver.maxViewings} viewings max)`,
                        severity: 'high'
                    });
                }
                
                // Check work hours
                const viewingTime = timeToMinutes(newViewing.time);
                const workStart = timeToMinutes(driver.workHours.start);
                const workEnd = timeToMinutes(driver.workHours.end);
                
                if (viewingTime < workStart || viewingTime > workEnd - 30) {
                    conflicts.push({
                        type: 'hours',
                        message: `Outside work hours (${driver.workHours.start}-${driver.workHours.end})`,
                        severity: 'high'
                    });
                }
                
                // Check time conflicts with existing viewings
                for (const existing of existingViewings) {
                    const existingProperty = properties.find(p => p.id === existing.propertyId);
                    if (!existingProperty) continue;
                    
                    const travelTime = calculateTravelTime(existingProperty, newProperty);
                    
                    if (hasTimeConflict(newViewing, existing, travelTime)) {
                        conflicts.push({
                            type: 'timing',
                            message: `Too close to ${existing.propertyName} at ${existing.time} (needs ${travelTime} min travel)`,
                            severity: 'high',
                            conflictingViewing: existing
                        });
                    }
                }
                
                return conflicts;
            }
            
            // Optimize route using nearest neighbor algorithm (simplified TSP)
            function optimizeRoute(viewingsList, startLocation = null) {
                if (viewingsList.length <= 1) return viewingsList;
                
                const optimized = [];
                const remaining = [...viewingsList];
                
                // Start from given location or first viewing
                let current = startLocation ? 
                    findNearestViewing(remaining, startLocation) : 
                    remaining.shift();
                
                optimized.push(current);
                
                // Nearest neighbor: always go to closest unvisited property
                while (remaining.length > 0) {
                    const currentProperty = properties.find(p => p.id === current.propertyId);
                    if (!currentProperty) break;
                    
                    let nearestIndex = 0;
                    let shortestDistance = Infinity;
                    
                    for (let i = 0; i < remaining.length; i++) {
                        const nextProperty = properties.find(p => p.id === remaining[i].propertyId);
                        if (!nextProperty) continue;
                        
                        const distance = calculateDistance(
                            currentProperty.lat, currentProperty.lng,
                            nextProperty.lat, nextProperty.lng
                        );
                        
                        if (distance < shortestDistance) {
                            shortestDistance = distance;
                            nearestIndex = i;
                        }
                    }
                    
                    current = remaining.splice(nearestIndex, 1)[0];
                    optimized.push(current);
                }
                
                return optimized;
            }
            
            // Find nearest viewing to a location
            function findNearestViewing(viewingsList, location) {
                let nearest = viewingsList[0];
                let shortestDistance = Infinity;
                
                for (const viewing of viewingsList) {
                    const property = properties.find(p => p.id === viewing.propertyId);
                    if (!property) continue;
                    
                    const distance = calculateDistance(
                        location.lat, location.lng,
                        property.lat, property.lng
                    );
                    
                    if (distance < shortestDistance) {
                        shortestDistance = distance;
                        nearest = viewing;
                    }
                }
                
                return nearest;
            }
            
            // Calculate total route statistics
            function calculateRouteStats(viewingsList) {
                if (viewingsList.length === 0) return null;
                
                let totalDistance = 0;
                let totalTravelTime = 0;
                
                for (let i = 0; i < viewingsList.length - 1; i++) {
                    const prop1 = properties.find(p => p.id === viewingsList[i].propertyId);
                    const prop2 = properties.find(p => p.id === viewingsList[i + 1].propertyId);
                    
                    if (prop1 && prop2) {
                        const distance = calculateDistance(prop1.lat, prop1.lng, prop2.lat, prop2.lng);
                        const travelTime = calculateTravelTime(prop1, prop2);
                        
                        totalDistance += distance;
                        totalTravelTime += travelTime;
                    }
                }
                
                // Calculate fuel cost using UK prices
                const fuelCost = calculateFuelCost(totalDistance);
                const totalDistanceMiles = totalDistance * 0.621371;
                
                return {
                    totalDistance: totalDistance.toFixed(2),
                    totalDistanceMiles: totalDistanceMiles.toFixed(2),
                    totalTravelTime: Math.ceil(totalTravelTime),
                    totalViewingTime: viewingsList.length * VEHICLE_CONFIG.viewingDuration,
                    totalTime: Math.ceil(totalTravelTime) + (viewingsList.length * VEHICLE_CONFIG.viewingDuration),
                    estimatedFuelCost: fuelCost.toFixed(2),
                    numberOfViewings: viewingsList.length,
                    fuelType: VEHICLE_CONFIG.fuelType,
                    pricePerLitre: (UK_FUEL_PRICES[VEHICLE_CONFIG.fuelType] / 100).toFixed(2)
                };
            }
            
            // Suggest optimal time slot for a property
            function suggestOptimalTimeSlot(propertyId, date) {
                const property = properties.find(p => p.id === propertyId);
                if (!property) return null;
                
                const zone = getPropertyZone(property);
                const driver = DRIVERS[zone];
                const existingViewings = getDriverViewings(driver, date);
                
                if (existingViewings.length === 0) {
                    // No viewings yet - suggest morning start
                    return driver.workHours.start;
                }
                
                // Find best insertion point in route
                const optimizedRoute = optimizeRoute(existingViewings);
                let bestTime = null;
                let minExtraDistance = Infinity;
                
                for (let i = 0; i <= optimizedRoute.length; i++) {
                    const prevViewing = i > 0 ? optimizedRoute[i - 1] : null;
                    const nextViewing = i < optimizedRoute.length ? optimizedRoute[i] : null;
                    
                    let extraDistance = 0;
                    let suggestedTime = null;
                    
                    if (!prevViewing) {
                        // Insert at beginning
                        suggestedTime = driver.workHours.start;
                        if (nextViewing) {
                            const nextProp = properties.find(p => p.id === nextViewing.propertyId);
                            if (nextProp) {
                                extraDistance = calculateDistance(property.lat, property.lng, nextProp.lat, nextProp.lng);
                            }
                        }
                    } else if (!nextViewing) {
                        // Insert at end
                        const prevProp = properties.find(p => p.id === prevViewing.propertyId);
                        if (prevProp) {
                            const travelTime = calculateTravelTime(prevProp, property);
                            const prevTime = timeToMinutes(prevViewing.time);
                            suggestedTime = minutesToTime(prevTime + 30 + travelTime);
                            extraDistance = calculateDistance(prevProp.lat, prevProp.lng, property.lat, property.lng);
                        }
                    } else {
                        // Insert between two viewings
                        const prevProp = properties.find(p => p.id === prevViewing.propertyId);
                        const nextProp = properties.find(p => p.id === nextViewing.propertyId);
                        
                        if (prevProp && nextProp) {
                            const travelFromPrev = calculateTravelTime(prevProp, property);
                            const travelToNext = calculateTravelTime(property, nextProp);
                            const prevTime = timeToMinutes(prevViewing.time);
                            
                            suggestedTime = minutesToTime(prevTime + 30 + travelFromPrev);
                            
                            // Calculate extra distance (detour)
                            const originalDistance = calculateDistance(prevProp.lat, prevProp.lng, nextProp.lat, nextProp.lng);
                            const newDistance = calculateDistance(prevProp.lat, prevProp.lng, property.lat, property.lng) +
                                              calculateDistance(property.lat, property.lng, nextProp.lat, nextProp.lng);
                            extraDistance = newDistance - originalDistance;
                        }
                    }
                    
                    if (suggestedTime && extraDistance < minExtraDistance) {
                        // Check if this time is valid (not conflicting and within work hours)
                        const testViewing = { propertyId, date: formatDateForStorage(date), time: suggestedTime };
                        const conflicts = detectConflicts(testViewing);
                        
                        if (conflicts.length === 0) {
                            minExtraDistance = extraDistance;
                            bestTime = suggestedTime;
                        }
                    }
                }
                
                return bestTime;
            }
            
            // Auto-optimize all viewings for a date when properties change
            window.recalculateRoutesForDate = function(date) {
                const dateStr = formatDateForStorage(date);
                
                // Get viewings for each driver
                const northViewings = getDriverViewings(DRIVERS.north, date);
                const southViewings = getDriverViewings(DRIVERS.south, date);
                
                // Optimize each route
                const optimizedNorth = optimizeRoute(northViewings);
                const optimizedSouth = optimizeRoute(southViewings);
                
                return {
                    north: {
                        driver: DRIVERS.north,
                        viewings: optimizedNorth,
                        stats: calculateRouteStats(optimizedNorth)
                    },
                    south: {
                        driver: DRIVERS.south,
                        viewings: optimizedSouth,
                        stats: calculateRouteStats(optimizedSouth)
                    }
                };
            };
            
            // Make routing functions globally accessible
            window.routingSystem = {
                detectConflicts,
                suggestOptimalTimeSlot,
                calculateRouteStats,
                getDriverViewings,
                recalculateRoutesForDate,
                optimizeRoute,
                getPropertyZone,
                DRIVERS
            };
            
            // Show route optimizer modal with today's routes
            window.showRouteOptimizer = function() {
                const today = new Date();
                const routes = recalculateRoutesForDate(today);
                
                let html = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: white; border-radius: 12px; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                <h2 style="margin: 0; color: #333; font-size: 24px;">
                                    <i class="fas fa-route"></i> Route Optimization - ${today.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}
                                </h2>
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                            </div>
                `;
                
                // North Route
                if (routes.north.viewings.length > 0) {
                    html += renderRouteSection(routes.north, 'NORTH', '#8E1616');
                } else {
                    html += `<div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; text-align: center; color: #666;">
                        <i class="fas fa-info-circle"></i> No viewings scheduled in North London today
                    </div>`;
                }
                
                // South Route
                if (routes.south.viewings.length > 0) {
                    html += renderRouteSection(routes.south, 'SOUTH', '#e74c3c');
                } else {
                    html += `<div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666;">
                        <i class="fas fa-info-circle"></i> No viewings scheduled in South London today
                    </div>`;
                }
                
                html += `
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                                        <input type="checkbox" id="conflict-checking-toggle" ${routingSettings.conflictCheckingEnabled ? 'checked' : ''} onchange="toggleConflictChecking(this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                        <span style="font-size: 13px; font-weight: 500;">Enable Conflict Checking</span>
                                    </label>
                                    <div style="font-size: 11px; color: #666; max-width: 200px;">
                                        ${routingSettings.conflictCheckingEnabled ? '✓ Conflicts will be detected' : '⚠️ Conflicts won\'t be checked'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="applyOptimizedRoutes()" style="padding: 12px 24px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(46,204,113,0.3);">
                                        <i class="fas fa-check-circle"></i> Accept & Apply Optimized Routes
                                    </button>
                                    <button onclick="exportOptimizedRoutes()" style="padding: 12px 24px; background: var(--primary-orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-download"></i> Export Routes
                                    </button>
                                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            };
            
            function renderRouteSection(routeData, zoneName, color) {
                const stats = routeData.stats;
                if (!stats) return '';
                
                return `
                    <div style="background: linear-gradient(135deg, ${color}15 0%, ${color}05 100%); border-left: 4px solid ${color}; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: ${color}; font-size: 18px;">
                            <i class="fas fa-compass"></i> ${zoneName} LONDON - ${routeData.driver.name}
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div style="background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Viewings</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${color};">${stats.numberOfViewings}</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Distance</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${color};">${stats.totalDistanceMiles} mi</div>
                                <div style="font-size: 10px; color: #999;">${stats.totalDistance} km</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Travel Time</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${color};">${stats.totalTravelTime} min</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Total Time</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${color};">${Math.floor(stats.totalTime / 60)}h ${stats.totalTime % 60}m</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Fuel Cost</div>
                                <div style="font-size: 20px; font-weight: 700; color: #2ecc71;">£${stats.estimatedFuelCost}</div>
                                <div style="font-size: 10px; color: #999; text-transform: capitalize;">${stats.fuelType} @ £${stats.pricePerLitre}/L</div>
                            </div>
                        </div>
                        
                        <div style="background: white; border-radius: 8px; padding: 15px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">
                                <i class="fas fa-list-ol"></i> Optimized Route Order:
                            </h4>
                            ${routeData.viewings.map((v, i) => {
                                const prop = properties.find(p => p.id === v.propertyId);
                                const nextViewing = routeData.viewings[i + 1];
                                let travelInfo = '';
                                
                                if (nextViewing && prop) {
                                    const nextProp = properties.find(p => p.id === nextViewing.propertyId);
                                    if (nextProp) {
                                        const distance = calculateDistance(prop.lat, prop.lng, nextProp.lat, nextProp.lng);
                                        const distanceMiles = (distance * 0.621371).toFixed(1);
                                        const travelTime = calculateTravelTime(prop, nextProp);
                                        travelInfo = `<div style="margin: 8px 0 8px 40px; padding: 8px; background: #f0f7ff; border-left: 3px solid var(--primary-orange); font-size: 11px; border-radius: 4px;">
                                            <i class="fas fa-car"></i> Drive ${distanceMiles} mi (${distance.toFixed(1)} km) to next property (~${travelTime} min)
                                        </div>`;
                                    }
                                }
                                
                                return `
                                    <div style="margin-bottom: ${i < routeData.viewings.length - 1 ? '12px' : '0'};">
                                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                            <div style="width: 32px; height: 32px; background: ${color}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">
                                                ${i + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; font-size: 13px; color: #333;">${v.time} - ${v.propertyName}</div>
                                                <div style="font-size: 11px; color: #666;">${v.address}</div>
                                                <div style="font-size: 11px; color: var(--primary-orange); margin-top: 2px;">
                                                    <i class="fas fa-user"></i> ${v.name} ${v.viewingType === 'virtual' ? '📹 Virtual' : '🏠 In-Person'}
                                                </div>
                                            </div>
                                        </div>
                                        ${travelInfo}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Export optimized routes
            window.exportOptimizedRoutes = function() {
                const today = new Date();
                const routes = recalculateRoutesForDate(today);
                
                let text = `OPTIMIZED VIEWING ROUTES\n`;
                text += `Date: ${today.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}\n`;
                text += `${'='.repeat(70)}\n\n`;
                
                // North Route
                if (routes.north.viewings.length > 0) {
                    text += exportRouteText(routes.north, 'NORTH LONDON');
                }
                
                // South Route
                if (routes.south.viewings.length > 0) {
                    text += exportRouteText(routes.south, 'SOUTH LONDON');
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Exported!', 'Optimized routes copied to clipboard');
                }).catch(() => {
                    showToast('Error', 'Failed to export routes', true);
                });
            };
            
            function exportRouteText(routeData, zoneName) {
                const stats = routeData.stats;
                let text = `${zoneName} - ${routeData.driver.name}\n`;
                text += `${'-'.repeat(70)}\n`;
                text += `Viewings: ${stats.numberOfViewings} | Distance: ${stats.totalDistance} km | Travel: ${stats.totalTravelTime} min | Total: ${Math.floor(stats.totalTime/60)}h ${stats.totalTime%60}m | Fuel: £${stats.estimatedFuelCost}\n\n`;
                
                routeData.viewings.forEach((v, i) => {
                    text += `${i + 1}. ${v.time} - ${v.propertyName}\n`;
                    text += `   Address: ${v.address}\n`;
                    text += `   Client: ${v.name} (${v.phone})\n`;
                    text += `   Type: ${v.viewingType === 'virtual' ? 'Virtual Viewing 📹' : 'In-Person Viewing 🏠'}\n`;
                    
                    const nextViewing = routeData.viewings[i + 1];
                    if (nextViewing) {
                        const prop = properties.find(p => p.id === v.propertyId);
                        const nextProp = properties.find(p => p.id === nextViewing.propertyId);
                        if (prop && nextProp) {
                            const distance = calculateDistance(prop.lat, prop.lng, nextProp.lat, nextProp.lng);
                            const travelTime = calculateTravelTime(prop, nextProp);
                            text += `   → Drive ${distance.toFixed(1)} km to next property (~${travelTime} min)\n`;
                        }
                    }
                    text += `\n`;
                });
                
                text += `\n`;
                return text;
            }
            
            // Toggle conflict checking on/off
            window.toggleConflictChecking = function(enabled) {
                routingSettings.conflictCheckingEnabled = enabled;
                localStorage.setItem('routingSettings', JSON.stringify(routingSettings));
                const status = enabled ? '✓ Enabled' : '⚠️ Disabled';
                showToast('Conflict Checking', `${status} - ${enabled ? 'Conflicts will be detected' : 'Booking without checks'}`, !enabled);
            };
            
            // Apply optimized routes - reorders viewing times
            window.applyOptimizedRoutes = function() {
                const today = new Date();
                const routes = recalculateRoutesForDate(today);
                
                let changesApplied = 0;
                let totalSavings = 0;
                
                // Apply North route
                if (routes.north.viewings.length > 0) {
                    const result = applyRouteOrder(routes.north);
                    changesApplied += result.changes;
                    if (routes.north.stats) totalSavings += parseFloat(routes.north.stats.estimatedFuelCost);
                }
                
                // Apply South route
                if (routes.south.viewings.length > 0) {
                    const result = applyRouteOrder(routes.south);
                    changesApplied += result.changes;
                    if (routes.south.stats) totalSavings += parseFloat(routes.south.stats.estimatedFuelCost);
                }
                
                if (changesApplied > 0) {
                    // Save changes
                    saveViewingsToStorage();
                    
                    // Close modal
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                    
                    // Refresh viewings list
                    renderViewingsList();
                    
                    // Show success message
                    showToast('Routes Optimized!', `${changesApplied} viewing times adjusted for optimal routing. Est. fuel cost: £${totalSavings.toFixed(2)}`);
                } else {
                    showToast('Already Optimal', 'Current schedule is already optimized!');
                }
            };
            
            // Apply optimized order to a route
            function applyRouteOrder(routeData) {
                let changes = 0;
                const driverWorkStart = timeToMinutes(routeData.driver.workHours.start);
                let currentTime = driverWorkStart;
                
                routeData.viewings.forEach((viewing, index) => {
                    const suggestedTime = minutesToTime(currentTime);
                    
                    // Only update if time changed significantly (>5 minutes)
                    if (Math.abs(timeToMinutes(viewing.time) - currentTime) > 5) {
                        const originalViewing = viewings.find(v => v.id === viewing.id);
                        if (originalViewing) {
                            originalViewing.time = suggestedTime;
                            viewing.time = suggestedTime; // Update in optimized list too
                            changes++;
                        }
                    }
                    
                    // Calculate time for next viewing
                    currentTime += VEHICLE_CONFIG.viewingDuration; // Viewing duration
                    
                    // Add travel time to next property
                    if (index < routeData.viewings.length - 1) {
                        const currentProp = properties.find(p => p.id === viewing.propertyId);
                        const nextViewing = routeData.viewings[index + 1];
                        const nextProp = properties.find(p => p.id === nextViewing.propertyId);
                        
                        if (currentProp && nextProp) {
                            const travelTime = calculateTravelTime(currentProp, nextProp);
                            currentTime += travelTime;
                        }
                    }
                });
                
                return { changes, route: routeData.viewings };
            }
            
            // END OF ROUTING SYSTEM
            // ============================================
            
            // ============================================
            // PROPERTY HISTORY & DETAILS SYSTEM
            // ============================================
            
            // Show property full details modal
            window.showPropertyDetails = function(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const status = getPropertyStatus(propertyId);
                const history = getPropertyHistory(propertyId);
                const zone = getPropertyZone(property);
                
                let statusBadgeHtml = '';
                switch(status) {
                    case 'taken':
                        statusBadgeHtml = '<span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">✓ TAKEN</span>';
                        break;
                    case 'viewing-scheduled':
                        statusBadgeHtml = '<span style="background: var(--primary-orange); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">📅 VIEWING SCHEDULED</span>';
                        break;
                    case 'maintenance':
                        statusBadgeHtml = '<span style="background: #f39c12; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">🔧 MAINTENANCE</span>';
                        break;
                    default:
                        statusBadgeHtml = '<span style="background: #2ecc71; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">✓ AVAILABLE</span>';
                }
                
                const html = `
                    <div class="property-detail-modal" onclick="this.remove()">
                        <div class="property-detail-content" onclick="event.stopPropagation()">
                            <div class="property-detail-header">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h2 style="margin: 0 0 8px 0; font-size: 22px;">${property.name}</h2>
                                        <div style="font-size: 13px; opacity: 0.9;">${property.address}</div>
                                    </div>
                                    <button onclick="this.closest('.property-detail-modal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px;">×</button>
                                </div>
                                <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                                    ${statusBadgeHtml}
                                    <span style="color: rgba(255,255,255,0.9); font-size: 12px;">${zone.toUpperCase()} Zone</span>
                                </div>
                            </div>
                            
                            <div class="property-detail-body">
                                <div class="detail-section">
                                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"><i class="fas fa-info-circle"></i> Property Details</h3>
                                    <div class="detail-row">
                                        <span class="detail-label">Monthly Rent:</span>
                                        <span class="detail-value" style="color: #2ecc71; font-size: 16px;">£${property.rent}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Borough:</span>
                                        <span class="detail-value">${property.borough}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Floor:</span>
                                        <span class="detail-value">${property.floor || 'N/A'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Bedrooms:</span>
                                        <span class="detail-value">${property.bedrooms || 1}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Max Occupancy:</span>
                                        <span class="detail-value">${property.maxOccupancy || 1} person${property.maxOccupancy > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Lift:</span>
                                        <span class="detail-value">${property.lift ? '✓ Yes' : '✗ No'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Bills Included:</span>
                                        <span class="detail-value">${property.billsIncluded ? '✓ Yes' : '✗ No'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Pets Allowed:</span>
                                        <span class="detail-value">${property.petsAllowed ? '✓ Yes' : '✗ No'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Gender Restriction:</span>
                                        <span class="detail-value">${property.gender === 'female' ? '👩 Women Only' : 'Any'}</span>
                                    </div>
                                </div>
                                
                                <div class="detail-section">
                                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;"><i class="fas fa-pound-sign"></i> Financial Summary</h3>
                                    ${(() => {
                                        const costs = calculateUpfrontCosts(property.rent);
                                        return `
                                            <div class="detail-row">
                                                <span class="detail-label">First Month Rent:</span>
                                                <span class="detail-value">£${costs.monthlyRent.toFixed(2)}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Deposit (5 weeks):</span>
                                                <span class="detail-value">£${costs.deposit.toFixed(2)}</span>
                                            </div>
                                            <div class="detail-row" style="border-top: 2px solid var(--primary-orange); padding-top: 8px; margin-top: 8px;">
                                                <span class="detail-label" style="font-weight: 700;">Total Upfront Cost:</span>
                                                <span class="detail-value" style="color: var(--primary-orange); font-size: 18px;">£${costs.total.toFixed(2)}</span>
                                            </div>
                                        `;
                                    })()}
                                </div>
                                
                                <div class="detail-section" style="border: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="margin: 0; font-size: 16px; color: #333;"><i class="fas fa-history"></i> Viewing History (${history.length})</h3>
                                        <button onclick="showPropertyHistory(${propertyId}); this.closest('.property-detail-modal').remove();" style="padding: 6px 12px; background: var(--primary-orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                            View Full History
                                        </button>
                                    </div>
                                    ${history.length > 0 ? `
                                        <div style="font-size: 12px; color: #666;">
                                            Last viewing: ${new Date(history[history.length - 1].date).toLocaleDateString('en-GB')} - ${history[history.length - 1].clientName}
                                        </div>
                                    ` : '<div style="font-size: 12px; color: #999; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 6px;">No viewing history yet</div>'}
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 25px;">
                                    ${status !== 'taken' && status !== 'maintenance' ? `
                                        <button onclick="selectPropertyForBooking(${propertyId}); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-calendar-plus"></i> Book Viewing
                                        </button>
                                    ` : ''}
                                    <button onclick="openEditPropertyModal(${propertyId}); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 12px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-edit"></i> Edit Property
                                    </button>
                                    ${property.link ? `
                                        <a href="${property.link}" target="_blank" style="flex: 1; padding: 12px; background: white; color: var(--primary-orange); border: 2px solid var(--primary-orange); border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            <i class="fas fa-external-link-alt"></i> View Photos
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            };
            
            // Show property history modal
            window.showPropertyHistory = function(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const history = getPropertyHistory(propertyId);
                const status = getPropertyStatus(propertyId);
                
                const html = `
                    <div class="property-detail-modal" onclick="this.remove()">
                        <div class="property-detail-content" onclick="event.stopPropagation()">
                            <div class="property-detail-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h2 style="margin: 0 0 5px 0; font-size: 20px;"><i class="fas fa-history"></i> Viewing History</h2>
                                        <div style="font-size: 13px; opacity: 0.9;">${property.name} - ${property.address}</div>
                                    </div>
                                    <button onclick="this.closest('.property-detail-modal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px;">×</button>
                                </div>
                            </div>
                            
                            <div class="property-detail-body">
                                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                    <button onclick="setPropertyStatus(${propertyId}, 'available'); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 8px; background: ${status === 'available' ? '#2ecc71' : '#e0e0e0'}; color: ${status === 'available' ? 'white' : '#666'}; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                        ✓ Available
                                    </button>
                                    <button onclick="setPropertyStatus(${propertyId}, 'viewing-scheduled'); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 8px; background: ${status === 'viewing-scheduled' ? 'var(--primary-orange)' : '#e0e0e0'}; color: ${status === 'viewing-scheduled' ? 'white' : '#666'}; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                        📅 Viewing
                                    </button>
                                    <button onclick="setPropertyStatus(${propertyId}, 'taken'); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 8px; background: ${status === 'taken' ? '#e74c3c' : '#e0e0e0'}; color: ${status === 'taken' ? 'white' : '#666'}; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                        ✓ Taken
                                    </button>
                                    <button onclick="setPropertyStatus(${propertyId}, 'maintenance'); this.closest('.property-detail-modal').remove();" style="flex: 1; padding: 8px; background: ${status === 'maintenance' ? '#f39c12' : '#e0e0e0'}; color: ${status === 'maintenance' ? 'white' : '#666'}; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                        🔧 Maintenance
                                    </button>
                                </div>
                                
                                ${history.length > 0 ? `
                                    <div class="history-timeline">
                                        ${history.map((item, index) => {
                                            const outcomeColor = {
                                                'scheduled': 'var(--primary-orange)',
                                                'completed': '#2ecc71',
                                                'cancelled': '#95a5a6',
                                                'no-show': '#e67e22',
                                                'interested': '#8E1616',
                                                'taken': '#e74c3c'
                                            }[item.outcome] || 'var(--primary-orange)';
                                            
                                            const outcomeText = {
                                                'scheduled': '📅 Scheduled',
                                                'completed': '✓ Completed',
                                                'cancelled': '✗ Cancelled',
                                                'no-show': '⚠️ No Show',
                                                'interested': '👍 Interested',
                                                'taken': '✓ TAKEN'
                                            }[item.outcome] || item.outcome;
                                            
                                            return `
                                                <div class="history-item outcome-${item.outcome}">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                        <div>
                                                            <div style="font-weight: 700; font-size: 13px; color: #333;">${item.clientName}</div>
                                                            <div style="font-size: 11px; color: #666;">${item.clientPhone}</div>
                                                        </div>
                                                        <span style="background: ${outcomeColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">
                                                            ${outcomeText}
                                                        </span>
                                                    </div>
                                                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                                        <i class="fas fa-calendar"></i> ${new Date(item.date).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })} at ${item.time}
                                                    </div>
                                                    <div style="font-size: 11px; color: #666;">
                                                        ${item.viewingType === 'virtual' ? '📹 Virtual Viewing' : '🏠 In-Person Viewing'}
                                                    </div>
                                                    ${item.notes ? `<div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 11px; color: #666; font-style: italic;">${item.notes}</div>` : ''}
                                                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                                                        <button onclick="updateViewingOutcome(${propertyId}, ${item.viewingId}, 'completed'); showPropertyHistory(${propertyId});" style="flex: 1; padding: 4px 8px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                            ✓ Completed
                                                        </button>
                                                        <button onclick="updateViewingOutcome(${propertyId}, ${item.viewingId}, 'no-show'); showPropertyHistory(${propertyId});" style="flex: 1; padding: 4px 8px; background: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                            No Show
                                                        </button>
                                                        <button onclick="updateViewingOutcome(${propertyId}, ${item.viewingId}, 'interested'); showPropertyHistory(${propertyId});" style="flex: 1; padding: 4px 8px; background: #8E1616; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                            Interested
                                                        </button>
                                                        <button onclick="updateViewingOutcome(${propertyId}, ${item.viewingId}, 'taken'); showPropertyHistory(${propertyId});" style="flex: 1; padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                            TAKEN
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).reverse().join('')}
                                    </div>
                                ` : `
                                    <div style="text-align: center; padding: 40px; color: #999;">
                                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <div style="font-size: 14px;">No viewing history for this property yet</div>
                                    </div>
                                `}
                                
                                <div style="margin-top: 25px; display: flex; gap: 10px;">
                                    <button onclick="exportPropertyHistory(${propertyId})" style="flex: 1; padding: 12px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-download"></i> Export History
                                    </button>
                                    <button onclick="this.closest('.property-detail-modal').remove()" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
            };
            
            // Export property history
            window.exportPropertyHistory = function(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (!property) return;
                
                const history = getPropertyHistory(propertyId);
                if (history.length === 0) {
                    showToast('No History', 'No viewing history to export', true);
                    return;
                }
                
                let text = `VIEWING HISTORY - ${property.name}\n`;
                text += `Address: ${property.address}\n`;
                text += `Total Viewings: ${history.length}\n`;
                text += `${'='.repeat(60)}\n\n`;
                
                history.forEach((item, index) => {
                    text += `${index + 1}. ${item.clientName}\n`;
                    text += `   Date: ${new Date(item.date).toLocaleDateString('en-GB')} at ${item.time}\n`;
                    text += `   Phone: ${item.clientPhone}\n`;
                    text += `   Type: ${item.viewingType === 'virtual' ? 'Virtual' : 'In-Person'}\n`;
                    text += `   Status: ${item.outcome}\n`;
                    if (item.notes) text += `   Notes: ${item.notes}\n`;
                    text += `\n`;
                });
                
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Exported!', `History for ${property.name} copied to clipboard`);
                }).catch(() => {
                    showToast('Error', 'Failed to export history', true);
                });
            };
            
            // END OF PROPERTY HISTORY SYSTEM
            // ============================================

            // FIXED: Confirm booking with proper date handling
            window.confirmBooking = function() {
                const propertyId = parseInt(document.getElementById('property-select').value);
                const viewingType = document.getElementById('viewing-type').value;
                const name = document.getElementById('visitor-name').value.trim();
                const email = document.getElementById('visitor-email').value.trim();
                const phone = document.getElementById('visitor-phone').value.trim();
                const referralSource = document.getElementById('referral-source').value;
                const notes = document.getElementById('visitor-notes').value.trim();

                if (!propertyId || !viewingType || !name || !email || !phone) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (!selectedDate || !selectedTime) {
                    alert('Please select a date and time');
                    return;
                }

                const property = properties.find(p => p.id === propertyId);
                if (!property) {
                    alert('Property not found');
                    return;
                }

                const dateStr = formatDateForStorage(selectedDate);
                
                const newViewing = {
                    id: Date.now(),
                    propertyId,
                    propertyName: property.name,
                    address: property.address,
                    rent: property.rent,
                    date: dateStr,
                    time: selectedTime,
                    viewingType,
                    name,
                    email,
                    phone,
                    referralSource,
                    notes
                };

                // Check for conflicts before booking (if enabled)
                if (routingSettings.conflictCheckingEnabled) {
                    const conflicts = detectConflicts(newViewing);
                    
                    if (conflicts.length > 0) {
                        // Show conflict warnings
                        let conflictMsg = '⚠️ SCHEDULING CONFLICTS DETECTED:\n\n';
                        conflicts.forEach((conflict, i) => {
                            conflictMsg += `${i + 1}. ${conflict.message}\n`;
                        });
                        conflictMsg += '\n';
                        
                        // Suggest optimal time if enabled
                        if (routingSettings.showSuggestedTimes) {
                            const optimalTime = suggestOptimalTimeSlot(propertyId, new Date(dateStr));
                            if (optimalTime) {
                                conflictMsg += `💡 Suggested optimal time: ${optimalTime}\n\n`;
                            }
                        }
                        
                        const zone = getPropertyZone(property);
                        conflictMsg += `This property is in ${zone.toUpperCase()} zone (${DRIVERS[zone].name})\n\n`;
                        conflictMsg += 'Do you still want to book this time?';
                        
                        if (!confirm(conflictMsg)) {
                            return; // User cancelled
                        }
                    }
                }

                viewings.push(newViewing);
                
                // Add to property history with full details
                addToPropertyHistory(propertyId, newViewing, 'scheduled');
                
                if (saveViewingsToStorage()) {
                    const typeIcon = viewingType === 'virtual' ? '📹' : '🏠';
                    const typeText = viewingType === 'virtual' ? 'Virtual Viewing' : 'In-Person Viewing';
                    const zone = getPropertyZone(property);
                    
                    // Show WhatsApp-enabled confirmation popup
                    showViewingConfirmation(name, property, dateStr, selectedTime, typeText, newViewing);
                    
                    selectedDate = null;
                    selectedTime = null;
                    selectedProperty = null;
                    
                    renderPropertyList();
                    populateEligibilityPropertySelector();
                    renderCalendar();
                    renderTimeSlots();
                    renderBookingForm();
                    renderViewingsList();
                } else {
                    viewings.pop();
                    alert('Failed to save viewing');
                }
            };
            
            // WhatsApp-enabled viewing confirmation popup
            function showViewingConfirmation(name, property, date, time, type, viewing) {
                // Create WhatsApp message without emojis
                const message = `Viewing Confirmed!\n\nClient: ${name}\nProperty: ${property.name}\nAddress: ${property.address}\nDate: ${date}\nTime: ${time}\nType: ${type}\n\nSee you there!`;
                
                // Get formatted phone from viewing data
                const clientPhone = formatPhoneForWhatsApp(viewing.phone || '');
                
                // Create popup modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    animation: fadeIn 0.3s;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; border: 3px solid var(--primary-red); box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideUp 0.3s;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="width: 70px; height: 70px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                                <i class="fas fa-check" style="font-size: 35px; color: white;"></i>
                            </div>
                            <h2 style="font-size: 24px; color: #1a0a0a; margin-bottom: 10px;">Viewing Confirmed!</h2>
                            <p style="color: #6b5544; font-size: 14px;">The viewing has been successfully booked</p>
                        </div>
                        
                        <div style="background: #F8EEDF; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid var(--primary-red);">
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <div style="color: #6b5544; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Client</div>
                                    <div style="color: #1a0a0a; font-size: 16px; font-weight: 600;"><i class="fas fa-user" style="color: #8E1616; margin-right: 8px;"></i>${name}</div>
                                </div>
                                <div>
                                    <div style="color: #6b5544; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Property</div>
                                    <div style="color: #1a0a0a; font-size: 15px; font-weight: 600;"><i class="fas fa-home" style="color: #8E1616; margin-right: 8px;"></i>${property.name}</div>
                                    <div style="color: #6b5544; font-size: 13px; margin-top: 2px; padding-left: 24px;">${property.address}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <div style="color: #6b5544; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Date</div>
                                        <div style="color: #1a0a0a; font-size: 14px; font-weight: 600;"><i class="fas fa-calendar" style="color: #8E1616; margin-right: 8px;"></i>${date}</div>
                                    </div>
                                    <div>
                                        <div style="color: #6b5544; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Time</div>
                                        <div style="color: #1a0a0a; font-size: 14px; font-weight: 600;"><i class="fas fa-clock" style="color: #8E1616; margin-right: 8px;"></i>${time}</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="color: #6b5544; font-size: 11px; text-transform: uppercase; margin-bottom: 4px;">Type</div>
                                    <div style="color: #1a0a0a; font-size: 14px; font-weight: 600;"><i class="fas ${type === 'Virtual Viewing' ? 'fa-video' : 'fa-walking'}" style="color: #8E1616; margin-right: 8px;"></i>${type}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f0f9f4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #25d366;">
                            <label style="display: block; color: #1a0a0a; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fab fa-whatsapp" style="color: #25d366; margin-right: 6px;"></i>Send to client's WhatsApp
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="tel" id="whatsapp-phone-input" value="${clientPhone}" placeholder="Enter phone number (e.g. 447123456789)" style="flex: 1; padding: 12px; border: 2px solid #d4b485; border-radius: 8px; font-size: 14px; color: #1a0a0a;">
                                <button onclick="sendWhatsAppDirect()" style="padding: 12px 20px; background: linear-gradient(135deg, #25d366, #128c7e); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                    <i class="fab fa-whatsapp"></i> Send
                                </button>
                            </div>
                            <div style="color: #6b5544; font-size: 11px; margin-top: 8px;">Enter number with country code, no + or spaces</div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="copyViewingDetails()" style="flex: 1; padding: 15px; background: #E8C999; color: #1a0a0a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-copy"></i> Copy Details
                            </button>
                            <button onclick="this.closest('div[style*=\\'fixed\\']').remove()" style="padding: 15px 25px; background: var(--primary-red); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store message for WhatsApp send
                window.currentViewingMessage = message;
                
                // Send WhatsApp directly to entered number
                window.sendWhatsAppDirect = function() {
                    const phoneInput = document.getElementById('whatsapp-phone-input');
                    let phone = phoneInput.value.replace(/[^0-9]/g, '');
                    
                    // Apply UK formatting if starts with 0
                    if (phone.startsWith('0')) {
                        phone = '44' + phone.substring(1);
                    }
                    
                    if (!phone || phone.length < 10) {
                        alert('Please enter a valid phone number');
                        return;
                    }
                    
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(window.currentViewingMessage)}`;
                    window.open(whatsappUrl, '_blank');
                };
                
                // Copy viewing details to clipboard
                window.copyViewingDetails = function() {
                    navigator.clipboard.writeText(window.currentViewingMessage).then(() => {
                        showToast('Copied!', 'Viewing details copied to clipboard');
                    }).catch(() => {
                        alert('Failed to copy. Message:\\n\\n' + window.currentViewingMessage);
                    });
                };
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // NEW: Export viewings functionality
            window.exportViewings = function() {
                if (viewings.length === 0) {
                    showToast('No Data', 'No viewings to export', true);
                    return;
                }

                const upcomingViewings = viewings
                    .filter(v => new Date(v.date) >= new Date())
                    .sort((a, b) => {
                        const dateCompare = new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time);
                        return dateCompare;
                    });

                let text = `PROPERTY VIEWINGS EXPORT\n`;
                text += `Generated: ${new Date().toLocaleString('en-GB')}\n`;
                text += `Total Viewings: ${upcomingViewings.length}\n`;
                text += `${'='.repeat(60)}\n\n`;

                upcomingViewings.forEach((viewing, index) => {
                    const typeText = viewing.viewingType === 'virtual' ? 'Virtual Viewing' : 'In-Person Viewing';
                    const dateObj = new Date(viewing.date);
                    text += `${index + 1}. ${viewing.propertyName}\n`;
                    text += `   Type: ${typeText}\n`;
                    text += `   Date: ${dateObj.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
                    text += `   Time: ${viewing.time}\n`;
                    text += `   Address: ${viewing.address}\n`;
                    text += `   Rent: £${viewing.rent}/month\n`;
                    text += `   Visitor: ${viewing.name}\n`;
                    text += `   Phone: ${viewing.phone}\n`;
                    text += `   Email: ${viewing.email}\n`;
                    if (viewing.notes) text += `   Notes: ${viewing.notes}\n`;
                    text += `\n`;
                });

                navigator.clipboard.writeText(text).then(() => {
                    showToast('Exported!', `${upcomingViewings.length} viewings copied to clipboard`);
                }).catch(() => {
                    showToast('Error', 'Failed to export', true);
                });
            };

            // NEW: Flush old viewings functionality
            window.flushOldViewings = function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const oldViewings = viewings.filter(v => new Date(v.date) < today);
                
                if (oldViewings.length === 0) {
                    showToast('No Old Data', 'No past viewings to flush');
                    return;
                }

                if (confirm(`Delete ${oldViewings.length} past viewing(s)?`)) {
                    viewings = viewings.filter(v => new Date(v.date) >= today);
                    if (saveViewingsToStorage()) {
                        showToast('Flushed!', `${oldViewings.length} past viewings removed`);
                        renderPropertyList();
                        renderCalendar();
                        renderViewingsList();
                    }
                }
            };

            // NEW: Sort viewings functionality
            window.sortViewings = function(order) {
                viewingSortOrder = order;
                renderViewingsList();
            };

            // NEW: Export past viewings
            window.exportPastViewings = function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const pastViewings = viewings
                    .filter(v => new Date(v.date) < today)
                    .sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateB - dateA; // Most recent first
                    });

                if (pastViewings.length === 0) {
                    showToast('No Data', 'No past viewings to export', true);
                    return;
                }

                let text = `PAST PROPERTY VIEWINGS EXPORT\n`;
                text += `Generated: ${new Date().toLocaleString('en-GB')}\n`;
                text += `Total Past Viewings: ${pastViewings.length}\n`;
                text += `${'='.repeat(60)}\n\n`;

                pastViewings.forEach((viewing, index) => {
                    const typeText = viewing.viewingType === 'virtual' ? 'Virtual Viewing' : 'In-Person Viewing';
                    const dateObj = new Date(viewing.date);
                    text += `${index + 1}. ${viewing.propertyName}\n`;
                    text += `   Type: ${typeText}\n`;
                    text += `   Date: ${dateObj.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
                    text += `   Time: ${viewing.time}\n`;
                    text += `   Address: ${viewing.address}\n`;
                    text += `   Rent: £${viewing.rent}/month\n`;
                    text += `   Visitor: ${viewing.name}\n`;
                    text += `   Phone: ${viewing.phone}\n`;
                    text += `   Email: ${viewing.email}\n`;
                    if (viewing.notes) text += `   Notes: ${viewing.notes}\n`;
                    text += `\n`;
                });

                navigator.clipboard.writeText(text).then(() => {
                    showToast('Exported!', `${pastViewings.length} past viewings copied to clipboard`);
                }).catch(() => {
                    showToast('Error', 'Failed to export', true);
                });
            };

            
            // Add viewing to property history
            function addToPropertyHistory(propertyId, viewing, status) {
                // This function tracks viewing history for properties
                // For now it's a placeholder - history is tracked in viewings array
                console.log('[HISTORY] Added to property', propertyId, 'viewing', viewing.id, 'status', status);
            }
            
            function renderViewingsList() {
                const container = document.getElementById('viewings-list');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let todaysViewings = viewings.filter(v => {
                    const viewingDate = new Date(v.date);
                    viewingDate.setHours(0, 0, 0, 0);
                    return viewingDate.getTime() === today.getTime();
                });
                
                let upcomingViewings = viewings.filter(v => {
                    const viewingDate = new Date(v.date);
                    viewingDate.setHours(0, 0, 0, 0);
                    return viewingDate > today;
                });
                
                let pastViewings = viewings.filter(v => {
                    const viewingDate = new Date(v.date);
                    viewingDate.setHours(0, 0, 0, 0);
                    return viewingDate < today;
                });

                // Apply sorting based on property name
                const sortFunction = (a, b) => {
                    if (viewingSortOrder === 'date-asc') {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateA - dateB;
                    } else if (viewingSortOrder === 'date-desc') {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateB - dateA;
                    } else if (viewingSortOrder === 'property') {
                        return a.propertyName.localeCompare(b.propertyName);
                    }
                };

                todaysViewings.sort(sortFunction);
                upcomingViewings.sort(sortFunction);
                pastViewings.sort((a, b) => {
                    if (viewingSortOrder === 'property') {
                        return a.propertyName.localeCompare(b.propertyName);
                    }
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;
                });

                if (todaysViewings.length === 0 && upcomingViewings.length === 0 && pastViewings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <p>No viewings</p>
                        </div>
                    `;
                    return;
                }

                const allUpcoming = todaysViewings.length + upcomingViewings.length;
                container.innerHTML = `
                    <div style="padding: 0 20px 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="font-size: 16px; color: #333; margin: 0;">
                                ${todaysViewings.length > 0 ? `Today (${todaysViewings.length}) • ` : ''}Upcoming (${allUpcoming}) • Past (${pastViewings.length})
                            </h3>
                        </div>
                        
                        <div class="viewings-controls">
                            <button class="sort-btn ${viewingSortOrder === 'date-asc' ? 'active' : ''}" onclick="sortViewings('date-asc')">
                                <i class="fas fa-sort-up"></i> Date ↑
                            </button>
                            <button class="sort-btn ${viewingSortOrder === 'date-desc' ? 'active' : ''}" onclick="sortViewings('date-desc')">
                                <i class="fas fa-sort-down"></i> Date ↓
                            </button>
                            <button class="sort-btn ${viewingSortOrder === 'property' ? 'active' : ''}" onclick="sortViewings('property')">
                                <i class="fas fa-building"></i> Property
                            </button>
                        </div>
                        
                        <div class="action-btn-group" style="margin-top: 10px;">
                            <button class="action-btn export-btn" onclick="exportViewings()">
                                <i class="fas fa-download"></i> Export Upcoming
                            </button>
                            <button class="action-btn" onclick="showRouteOptimizer()" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white;">
                                <i class="fas fa-route"></i> Optimize Routes
                            </button>
                        </div>
                        <div class="action-btn-group" style="margin-top: 8px;">
                            <button class="action-btn" onclick="shareTodaysViewings()" style="background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); color: white; width: 100%;">
                                <i class="fab fa-whatsapp"></i> Share Today's Viewings (${todaysViewings.length})
                            </button>
                        </div>
                        <div class="action-btn-group" style="margin-top: 8px;">
                            <button class="action-btn flush-btn" onclick="flushOldViewings()">
                                <i class="fas fa-broom"></i> Flush Old
                            </button>
                            <button class="action-btn clear-btn" onclick="clearAllViewings()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        ${pastViewings.length > 0 ? `
                        <div class="action-btn-group" style="margin-top: 8px;">
                            <button class="action-btn export-btn" onclick="exportPastViewings()" style="width: 100%;">
                                <i class="fas fa-history"></i> Export Past Viewings (${pastViewings.length})
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Render today's viewings with special styling
                if (todaysViewings.length > 0) {
                    const todayHeader = document.createElement('div');
                    todayHeader.style.cssText = 'padding: 10px 20px; background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%); color: white; font-weight: 600; font-size: 13px; border-left: 4px solid #5568d3; animation: pulse 2s infinite;';
                    todayHeader.innerHTML = '<i class="fas fa-star"></i> TODAY\'S VIEWINGS - ' + new Date().toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric' });
                    container.appendChild(todayHeader);

                    todaysViewings.forEach(viewing => {
                        const card = createViewingCard(viewing, false, true);
                        container.appendChild(card);
                    });
                }

                // Render upcoming viewings
                if (upcomingViewings.length > 0) {
                    const upcomingHeader = document.createElement('div');
                    upcomingHeader.style.cssText = 'padding: 10px 20px; background: #d4edda; color: #155724; font-weight: 600; font-size: 13px; border-left: 4px solid #2ecc71;' + (todaysViewings.length > 0 ? ' margin-top: 15px;' : '');
                    upcomingHeader.innerHTML = '<i class="fas fa-calendar-check"></i> UPCOMING VIEWINGS';
                    container.appendChild(upcomingHeader);

                    upcomingViewings.forEach(viewing => {
                        const card = createViewingCard(viewing, false, false);
                        container.appendChild(card);
                    });
                }

                // Render past viewings
                if (pastViewings.length > 0) {
                    const pastHeader = document.createElement('div');
                    pastHeader.style.cssText = 'padding: 10px 20px; background: #f8d7da; color: #721c24; font-weight: 600; font-size: 13px; border-left: 4px solid #e74c3c; margin-top: 15px;';
                    pastHeader.innerHTML = '<i class="fas fa-history"></i> PAST VIEWINGS';
                    container.appendChild(pastHeader);

                    pastViewings.forEach(viewing => {
                        const card = createViewingCard(viewing, true, false);
                        container.appendChild(card);
                    });
                }
            }

            function getReferralSourceLabel(source) {
                const labels = {
                    'google': '🔍 Google Search',
                    'facebook': '📘 Facebook',
                    'instagram': '📸 Instagram',
                    'rightmove': '🏡 Rightmove',
                    'zoopla': '🏠 Zoopla',
                    'openrent': '📋 OpenRent',
                    'spareroom': '🚪 SpareRoom',
                    'friend': '👥 Friend/Family Referral',
                    'previous-tenant': '🔁 Previous Tenant',
                    'council': '🏛️ Council Referral',
                    'charity': '❤️ Charity/Support Service',
                    'walk-in': '🚶 Walk-in/Saw Sign',
                    'other': '📝 Other'
                };
                return labels[source] || source;
            }

            function createViewingCard(viewing, isPast, isToday) {
                const card = document.createElement('div');
                card.className = `viewing-card ${viewing.viewingType === 'virtual' ? 'virtual' : ''}`;
                if (isPast) {
                    card.style.opacity = '0.7';
                    card.style.borderLeftColor = '#999';
                } else if (isToday) {
                    card.style.borderLeftColor = '#f59e0b';
                    card.style.borderLeftWidth = '6px';
                    card.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.15) 100%)';
                    card.style.boxShadow = '0 4px 16px rgba(245, 158, 11, 0.3)';
                }
                card.style.cursor = 'pointer';
                card.onclick = (e) => {
                    if (!e.target.closest('button')) {
                        copyViewingToClipboard(viewing);
                    }
                };
                const typeText = viewing.viewingType === 'virtual' ? 'Virtual' : 'In-Person';
                const viewingDate = new Date(viewing.date);
                const formattedDate = viewingDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <h4 style="margin: 0; color: white !important; font-size: 16px; font-weight: 700;">${viewing.propertyName} <i class="fas ${viewing.viewingType === 'virtual' ? 'fa-video' : 'fa-home'}" style="color: #E8C999;"></i></h4>
                        ${isPast ? '<span style="background: var(--text-grey); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">PAST</span>' : isToday ? '<span style="background: linear-gradient(135deg, var(--warning-yellow) 0%, #f39c12 100%); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">TODAY</span>' : ''}
                    </div>
                    <div class="viewing-info"><strong>Type:</strong> ${typeText}</div>
                    <div class="viewing-info"><strong>Date:</strong> ${formattedDate}</div>
                    <div class="viewing-info"><strong>Time:</strong> ${viewing.time}</div>
                    <div class="viewing-info"><strong>Visitor:</strong> ${viewing.name || 'N/A'}</div>
                    <div class="viewing-info"><strong>Phone:</strong> ${viewing.phone || 'N/A'}</div>
                    ${viewing.email ? `<div class="viewing-info"><strong>Email:</strong> ${viewing.email}</div>` : ''}
                    ${viewing.referralSource ? `<div class="viewing-info"><strong>Referral Source:</strong> ${getReferralSourceLabel(viewing.referralSource)}</div>` : ''}
                    ${viewing.notes ? `<div class="viewing-info" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);"><strong>Notes:</strong> ${viewing.notes}</div>` : ''}
                    <div style="margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.7); font-style: italic; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-copy"></i> Click to copy details
                    </div>
                    ${!isPast ? `
                    <div style="display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="share-btn" onclick="event.stopPropagation(); shareViewingWhatsApp(${viewing.id})" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #25d366, #128c7e); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="fab fa-whatsapp"></i> Share
                        </button>
                        <button class="edit-btn" onclick="event.stopPropagation(); editViewing(${viewing.id})" style="flex: 1; min-width: 80px; background: linear-gradient(135deg, #E8C999 0%, #d4b485 100%); color: #1a0a0a; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="cancel-btn" onclick="event.stopPropagation(); cancelViewing(${viewing.id})" style="flex: 1; min-width: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    ` : ''}
                `;
                return card;
            }

            // Format UK phone number for WhatsApp (drops leading 0, adds 44)
            function formatPhoneForWhatsApp(phone) {
                if (!phone) return '';
                
                // Remove all non-digits
                let cleaned = phone.replace(/[^0-9]/g, '');
                
                // If starts with 0, replace with 44 (UK country code)
                if (cleaned.startsWith('0')) {
                    cleaned = '44' + cleaned.substring(1);
                }
                // If starts with +44, just remove the +
                else if (cleaned.startsWith('44')) {
                    // Already correct format
                }
                // If it's a short number without country code, assume UK
                else if (cleaned.length === 10) {
                    cleaned = '44' + cleaned;
                }
                
                return cleaned;
            }

            // Share today's viewings list via WhatsApp
            window.shareTodaysViewings = function() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const todaysViewings = viewings.filter(v => {
                    const viewingDate = new Date(v.date);
                    viewingDate.setHours(0, 0, 0, 0);
                    return viewingDate.getTime() === today.getTime();
                }).sort((a, b) => {
                    return a.time.localeCompare(b.time);
                });
                
                if (todaysViewings.length === 0) {
                    showToast('No Viewings', 'No viewings scheduled for today', true);
                    return;
                }
                
                const dateStr = today.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                let message = `VIEWINGS FOR TODAY\n${dateStr}\n${'─'.repeat(25)}\n\n`;
                message += `Total: ${todaysViewings.length} viewing${todaysViewings.length > 1 ? 's' : ''}\n\n`;
                
                todaysViewings.forEach((viewing, index) => {
                    const typeText = viewing.viewingType === 'virtual' ? 'Virtual' : 'In-Person';
                    message += `${index + 1}. ${viewing.time} - ${viewing.propertyName}\n`;
                    message += `   ${viewing.address}\n`;
                    message += `   Client: ${viewing.name}\n`;
                    message += `   Phone: ${viewing.phone || 'N/A'}\n`;
                    message += `   Type: ${typeText}\n`;
                    if (viewing.notes) {
                        message += `   Notes: ${viewing.notes}\n`;
                    }
                    message += `\n`;
                });
                
                message += `${'─'.repeat(25)}\nSent from Property Management System`;
                
                // Show share modal
                showTodaysViewingsShareModal(message, todaysViewings.length);
            };
            
            // Modal for sharing today's viewings
            function showTodaysViewingsShareModal(message, count) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; border: 3px solid #25d366; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; background: #25d366; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                                <i class="fab fa-whatsapp" style="font-size: 30px; color: white;"></i>
                            </div>
                            <h2 style="font-size: 20px; color: #1a0a0a; margin-bottom: 5px;">Share Today's Viewings</h2>
                            <p style="color: #6b5544; font-size: 13px;">${count} viewing${count > 1 ? 's' : ''} scheduled for today</p>
                        </div>
                        
                        <div style="background: #F8EEDF; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <label style="display: block; color: #1a0a0a; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                Send to colleague's number
                            </label>
                            <input type="tel" id="colleague-phone-input" placeholder="e.g. 07123456789 or 447123456789" style="width: 100%; padding: 12px; border: 2px solid #d4b485; border-radius: 8px; font-size: 16px; color: #1a0a0a; box-sizing: border-box;">
                            <div style="color: #6b5544; font-size: 11px; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> UK numbers starting with 0 will be auto-formatted
                            </div>
                        </div>
                        
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                            <div style="color: #6b5544; font-size: 10px; text-transform: uppercase; margin-bottom: 6px;">Message Preview</div>
                            <pre style="color: #1a0a0a; font-size: 11px; white-space: pre-wrap; font-family: monospace; margin: 0;">${message}</pre>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="sendTodaysViewingsWhatsApp()" style="flex: 1; min-width: 140px; padding: 14px; background: linear-gradient(135deg, #25d366, #128c7e); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fab fa-whatsapp"></i> Send
                            </button>
                            <button onclick="copyTodaysViewings()" style="flex: 1; min-width: 100px; padding: 14px; background: #E8C999; color: #1a0a0a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button onclick="this.closest('div[style*=\\'fixed\\']').remove()" style="padding: 14px 20px; background: #e0e0e0; color: #1a0a0a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store message
                window.todaysViewingsMessage = message;
                
                // Send function
                window.sendTodaysViewingsWhatsApp = function() {
                    const phoneInput = document.getElementById('colleague-phone-input');
                    let phone = phoneInput.value.replace(/[^0-9]/g, '');
                    
                    // Apply UK formatting if starts with 0
                    if (phone.startsWith('0')) {
                        phone = '44' + phone.substring(1);
                    }
                    
                    if (!phone || phone.length < 10) {
                        alert('Please enter a valid phone number');
                        return;
                    }
                    
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(window.todaysViewingsMessage)}`;
                    window.open(whatsappUrl, '_blank');
                    modal.remove();
                    showToast('Sent!', 'WhatsApp opened with today\'s viewings');
                };
                
                // Copy function
                window.copyTodaysViewings = function() {
                    navigator.clipboard.writeText(window.todaysViewingsMessage).then(() => {
                        showToast('Copied!', 'Today\'s viewings copied to clipboard');
                    }).catch(() => {
                        alert('Message:\n\n' + window.todaysViewingsMessage);
                    });
                };
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // Share viewing via WhatsApp
            window.shareViewingWhatsApp = function(viewingId) {
                const viewing = viewings.find(v => v.id === viewingId);
                if (!viewing) {
                    showToast('Error', 'Viewing not found', true);
                    return;
                }
                
                const typeText = viewing.viewingType === 'virtual' ? 'Virtual Viewing' : 'In-Person Viewing';
                const viewingDate = new Date(viewing.date);
                const formattedDate = viewingDate.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const message = `Viewing Confirmation

Property: ${viewing.propertyName}
Address: ${viewing.address}

Date: ${formattedDate}
Time: ${viewing.time}
Type: ${typeText}

Please confirm your attendance. See you there!`;

                // Get formatted phone number
                const formattedPhone = formatPhoneForWhatsApp(viewing.phone);
                
                // Show share modal with phone input
                showShareModal(viewing, message, formattedPhone);
            };

            // Show share modal
            function showShareModal(viewing, message, formattedPhone) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; border: 3px solid #25d366; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; background: #25d366; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                                <i class="fab fa-whatsapp" style="font-size: 30px; color: white;"></i>
                            </div>
                            <h2 style="font-size: 20px; color: #1a0a0a; margin-bottom: 5px;">Share via WhatsApp</h2>
                            <p style="color: #6b5544; font-size: 13px;">Send viewing details to ${viewing.name}</p>
                        </div>
                        
                        <div style="background: #F8EEDF; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <label style="display: block; color: #1a0a0a; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                Client's Phone Number
                            </label>
                            <input type="tel" id="share-phone-input" value="${formattedPhone}" placeholder="447123456789" style="width: 100%; padding: 12px; border: 2px solid #d4b485; border-radius: 8px; font-size: 16px; color: #1a0a0a; box-sizing: border-box;">
                            <div style="color: #6b5544; font-size: 11px; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> UK numbers: Leading 0 is auto-replaced with 44
                            </div>
                            ${viewing.phone ? `<div style="color: #8E1616; font-size: 11px; margin-top: 4px;"><i class="fas fa-phone"></i> Original: ${viewing.phone}</div>` : ''}
                        </div>
                        
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 20px; max-height: 150px; overflow-y: auto;">
                            <div style="color: #6b5544; font-size: 10px; text-transform: uppercase; margin-bottom: 6px;">Message Preview</div>
                            <div style="color: #1a0a0a; font-size: 12px; white-space: pre-wrap; font-family: monospace;">${message}</div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="sendShareWhatsApp()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #25d366, #128c7e); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fab fa-whatsapp"></i> Send on WhatsApp
                            </button>
                            <button onclick="this.closest('div[style*=\\'fixed\\']').remove()" style="padding: 14px 20px; background: #e0e0e0; color: #1a0a0a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store message for sending
                window.currentShareMessage = message;
                
                // Send function
                window.sendShareWhatsApp = function() {
                    const phoneInput = document.getElementById('share-phone-input');
                    let phone = phoneInput.value.replace(/[^0-9]/g, '');
                    
                    // Apply UK formatting if starts with 0
                    if (phone.startsWith('0')) {
                        phone = '44' + phone.substring(1);
                    }
                    
                    if (!phone || phone.length < 10) {
                        alert('Please enter a valid phone number');
                        return;
                    }
                    
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(window.currentShareMessage)}`;
                    window.open(whatsappUrl, '_blank');
                    modal.remove();
                    showToast('Sent!', 'WhatsApp opened with message');
                };
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            function copyViewingToClipboard(viewing) {
                const typeText = viewing.viewingType === 'virtual' ? 'Virtual Viewing' : 'In-Person Viewing';
                const viewingDate = new Date(viewing.date);
                const formattedDate = viewingDate.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const text = `PROPERTY VIEWING DETAILS

Property: ${viewing.address}
Address: ${viewing.address}
Rent: £${viewing.rent}/month

Type: ${typeText}
Date: ${formattedDate}
Time: ${viewing.time}

Visitor: ${viewing.name}
Phone: ${viewing.phone}
Email: ${viewing.email}
${viewing.referralSource ? `Referral Source: ${getReferralSourceLabel(viewing.referralSource)}` : ''}
${viewing.notes ? `Notes: ${viewing.notes}` : ''}`;

                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied!', 'Viewing details copied to clipboard');
                }).catch(() => {
                    showToast('Error', 'Failed to copy', true);
                });
            }

            window.exportEligibilityResults = function() {
                if (!currentClientData) {
                    showToast('Error', 'No eligibility data to export', true);
                    return;
                }

                const data = currentClientData;
                let text = `HOUSING ELIGIBILITY ASSESSMENT RESULTS
=====================================

CLIENT INFORMATION:
------------------
Name: ${data.name}
Age: ${data.age} years
Gender: ${data.gender.charAt(0).toUpperCase() + data.gender.slice(1)}
Employment Status: ${data.employmentStatus.replace(/-/g, ' ').toUpperCase()}
Household Size: ${data.householdSize} person(s)
Children: ${data.childrenCount}
Monthly Rent Budget: £${data.rentBudget.toFixed(2)}

BENEFITS INFORMATION:
--------------------
Receiving Benefits: ${data.receivingBenefits === 'yes' ? 'YES' : 'NO'}
`;

                if (data.receivingBenefits === 'yes') {
                    text += `Benefit Type: ${data.benefitType.replace(/-/g, ' ').toUpperCase()}
Monthly Benefit (Housing Element): £${data.benefitAmount.toFixed(2)}

BENEFIT CAP STATUS:
------------------
Cap Status: ${data.actuallyUncapped ? '✓ UNCAPPED (NO UPPER LIMIT)' : '✗ CAPPED (£1,050/month limit)'}
Reason: ${data.capReason}
Effective Benefit Amount: £${data.effectiveBenefitAmount.toFixed(2)}/month
`;

                    if (data.cappedAmount > 0) {
                        text += `Benefit Reduction Due to Cap: £${data.cappedAmount.toFixed(2)}/month
`;
                    }

                    if (data.additionalBenefits && data.additionalBenefits.length > 0) {
                        text += `\nAdditional Benefits:
`;
                        data.additionalBenefits.forEach(benefit => {
                            text += `  • ${benefit.replace(/-/g, ' ').toUpperCase()}\n`;
                        });
                    }
                }

                text += `
ELIGIBILITY STATUS:
------------------
Overall Status: ${data.age >= 18 ? '✓ ELIGIBLE' : '✗ NOT ELIGIBLE (Must be 18+)'}

FULL ENTITLEMENT SUMMARY:
------------------------
`;

                let allProperties = [];
                properties.forEach(prop => {
                    if (takenProperties.has(prop.id)) return;
                    if (prop.gender === 'female' && data.gender !== 'female') return;
                    
                    const shortfall = data.receivingBenefits === 'yes' 
                        ? Math.max(0, prop.rent - data.effectiveBenefitAmount)
                        : prop.rent;
                    
                    allProperties.push({ ...prop, shortfall });
                });
                allProperties.sort((a, b) => a.shortfall - b.shortfall);

                const perfectMatches = allProperties.filter(p => p.shortfall === 0).length;
                const lowShortfall = allProperties.filter(p => p.shortfall > 0 && p.shortfall <= 50).length;
                const mediumShortfall = allProperties.filter(p => p.shortfall > 50 && p.shortfall <= 150).length;

                text += `Total Available Properties: ${allProperties.length}
`;
                if (perfectMatches > 0) {
                    text += `  • ${perfectMatches} properties with FULL benefit coverage (£0 shortfall)
`;
                }
                if (lowShortfall > 0) {
                    text += `  • ${lowShortfall} properties with LOW shortfall (£1-50/month)
`;
                }
                if (mediumShortfall > 0) {
                    text += `  • ${mediumShortfall} properties with MEDIUM shortfall (£51-150/month)
`;
                }

                if (allProperties.length > 0) {
                    text += `\nTOP PROPERTY MATCHES:
--------------------
`;
                    allProperties.slice(0, 5).forEach((prop, index) => {
                        text += `${index + 1}. ${prop.name}
   Address: ${prop.address}
   Rent: £${prop.rent}/month
   Shortfall: £${prop.shortfall.toFixed(2)}/month
   Borough: ${prop.borough}
${prop.gender === 'female' ? '   ⚠️ Women Only Property\n' : ''}
`;
                    });
                }

                text += `
RECOMMENDATION:
--------------
${data.age >= 18 ? 'Client is eligible for housing support. ' : 'Client must be 18 or older. '}`;

                if (data.receivingBenefits === 'yes') {
                    if (data.actuallyUncapped) {
                        text += `Client has UNCAPPED benefits, meaning there is NO UPPER LIMIT on their housing element. `;
                    } else {
                        text += `Client is subject to the benefit cap of £1,050/month. `;
                    }
                }

                if (perfectMatches > 0) {
                    text += `We have ${perfectMatches} properties available with FULL benefit coverage where the client would have NO monthly shortfall.`;
                } else if (lowShortfall > 0) {
                    text += `We have ${lowShortfall} properties available with minimal shortfall (£1-50/month).`;
                } else {
                    text += `All available properties would require the client to contribute additional funds beyond their benefit amount.`;
                }

                text += `

Report generated: ${new Date().toLocaleString('en-GB')}
=====================================
`;

                navigator.clipboard.writeText(text).then(() => {
                    showToast('Copied!', 'Full entitlement details copied to clipboard - ready to paste into email');
                }).catch(() => {
                    showToast('Error', 'Failed to copy', true);
                });
            };

            function clearAllViewings() {
                if (confirm('Delete all viewings?')) {
                    viewings = [];
                    saveViewingsToStorage();
                    renderPropertyList();
                    renderCalendar();
                    renderViewingsList();
                    showToast('Cleared', 'All viewings deleted');
                }
            }

            function zoomToProperty(propertyId) {
                const property = properties.find(p => p.id === propertyId);
                if (property) {
                    map.setView([property.lat, property.lng], 16);
                    const marker = Object.values(markers).find(m => {
                        const latlng = m.getLatLng();
                        return Math.abs(latlng.lat - property.lat) < 0.0001 && Math.abs(latlng.lng - property.lng) < 0.0001;
                    });
                    if (marker) marker.openPopup();
                }
            }

            window.cancelViewing = function(id) {
                if (confirm('Cancel this viewing?')) {
                    viewings = viewings.filter(v => v.id !== id);
                    if (saveViewingsToStorage()) {
                        renderPropertyList();
                        renderCalendar();
                        renderViewingsList();
                        showToast('Cancelled', 'Viewing removed');
                    }
                }
            };

            window.editViewing = function(id) {
                const viewing = viewings.find(v => v.id === id);
                if (!viewing) return;
                
                const typeText = viewing.viewingType === 'virtual' ? 'Virtual' : 'In-Person';
                
                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 20px;">
                            <i class="fas fa-edit"></i> Edit Viewing
                        </h2>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px;">
                            <strong>${viewing.propertyName}</strong><br>
                            ${viewing.address}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Name</label>
                            <input type="text" id="edit-name" value="${viewing.name}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;" />
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Phone</label>
                            <input type="tel" id="edit-phone" value="${viewing.phone}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;" />
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Email</label>
                            <input type="email" id="edit-email" value="${viewing.email}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;" />
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Date</label>
                            <input type="date" id="edit-date" value="${viewing.date}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;" />
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Time</label>
                            <select id="edit-time" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                ${['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00'].map(time => 
                                    `<option value="${time}" ${viewing.time === time ? 'selected' : ''}>${time}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Type</label>
                            <select id="edit-type" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                <option value="in-person" ${viewing.viewingType === 'in-person' ? 'selected' : ''}>🏠 In-Person</option>
                                <option value="virtual" ${viewing.viewingType === 'virtual' ? 'selected' : ''}>📹 Virtual</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;">Notes (optional)</label>
                            <textarea id="edit-notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical;">${viewing.notes || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="saveEditedViewing(${id})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            };

            window.saveEditedViewing = function(id) {
                const viewing = viewings.find(v => v.id === id);
                if (!viewing) return;
                
                const name = document.getElementById('edit-name').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                const email = document.getElementById('edit-email').value.trim();
                const date = document.getElementById('edit-date').value;
                const time = document.getElementById('edit-time').value;
                const viewingType = document.getElementById('edit-type').value;
                const notes = document.getElementById('edit-notes').value.trim();
                
                if (!name || !phone || !email || !date || !time) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Update viewing
                viewing.name = name;
                viewing.phone = phone;
                viewing.email = email;
                viewing.date = date;
                viewing.time = time;
                viewing.viewingType = viewingType;
                viewing.notes = notes;
                
                if (saveViewingsToStorage()) {
                    document.querySelector('div[style*="fixed"]').remove();
                    renderPropertyList();
                    renderCalendar();
                    renderViewingsList();
                    showToast('Updated!', 'Viewing details saved');
                } else {
                    alert('Failed to save changes');
                }
            };

            window.clearAllViewings = clearAllViewings;

            window.toggleProperty = function(id) {
                if (takenProperties.has(id)) {
                    takenProperties.delete(id);
                    console.log('[TOGGLE] Property', id, 'marked as AVAILABLE');
                } else {
                    takenProperties.add(id);
                    console.log('[TOGGLE] Property', id, 'marked as TAKEN');
                }
                
                // Keep window reference in sync
                window.takenProperties = takenProperties;
                
                // CRITICAL: Save to localStorage immediately
                savePropertiesToStorage();
                
                renderPropertyList();
                renderLegend();
                updateMarkers();
            };

            window.filterProperties = function(filter) {
                currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                renderPropertyList();
            };

            function filterByBorough(borough) {
                const boroughProps = properties.filter(p => p.borough === borough && !takenProperties.has(p.id));
                if (boroughProps.length > 0) {
                    const bounds = L.latLngBounds(boroughProps.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds.pad(0.2));
                    // Update markers to show only this borough
                    if (typeof updateMapMarkers === 'function') {
                        updateMapMarkers(boroughProps);
                    }
                    showToast('Borough Filter', `Showing ${boroughProps.length} properties in ${borough}`);
                }
            }

            window.filterByBorough = filterByBorough;

            // === TABBED SIDEBAR FUNCTIONS ===
            let currentSidebarTab = 'overview';
            let browseFilter = 'all';
            let browseSort = 'recent';

            function updateSidebarStats() {
                const total = properties.length;
                const available = properties.filter(p => !takenProperties.has(p.id)).length;
                const taken = total - available;
                const viewingsCount = viewings.length;
                
                // Calculate financial totals WITH STUDIO TRACKING
                let totalMonthlyRent = 0;
                let availableMonthlyRent = 0;
                let occupiedMonthlyRent = 0;
                
                properties.forEach(p => {
                    if (p.studioData && p.studioData.total > 1) {
                        // Property has multiple studios tracked
                        const rentPerStudio = p.rentPerStudio || p.rent;
                        const occupiedStudios = p.studioData.occupied || 0;
                        const vacantStudios = p.studioData.total - occupiedStudios;
                        
                        const propertyOccupiedIncome = rentPerStudio * occupiedStudios;
                        const propertyVacantIncome = rentPerStudio * vacantStudios;
                        
                        totalMonthlyRent += rentPerStudio * p.studioData.total;
                        occupiedMonthlyRent += propertyOccupiedIncome;
                        availableMonthlyRent += propertyVacantIncome;
                    } else {
                        // Single studio or no tracking - use old method
                        totalMonthlyRent += p.rent || 0;
                        if (!takenProperties.has(p.id)) {
                            availableMonthlyRent += p.rent || 0;
                        } else {
                            occupiedMonthlyRent += p.rent || 0;
                        }
                    }
                });
                
                const annualIncome = totalMonthlyRent * 12;
                
                // Update all stat displays
                ['total-properties-sidebar', 'total-properties'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = total;
                });
                
                ['available-properties-sidebar', 'available-count'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = available;
                });
                
                ['taken-properties-sidebar'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = taken;
                });
                
                ['viewings-count-sidebar'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = viewingsCount;
                });
                
                // Update financial displays
                const totalIncomeEl = document.getElementById('total-monthly-income');
                if (totalIncomeEl) totalIncomeEl.textContent = `£${totalMonthlyRent.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                const availIncomeEl = document.getElementById('available-monthly-income');
                if (availIncomeEl) availIncomeEl.textContent = `£${availableMonthlyRent.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                const occIncomeEl = document.getElementById('occupied-monthly-income');
                if (occIncomeEl) occIncomeEl.textContent = `£${occupiedMonthlyRent.toLocaleString('en-GB', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                const annualIncomeEl = document.getElementById('annual-income');
                if (annualIncomeEl) annualIncomeEl.textContent = `£${annualIncome.toLocaleString('en-GB', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            }

            window.switchSidebarTab = function(tabName) {
                currentSidebarTab = tabName;
                
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
                
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                if (tabName === 'browse') {
                    console.log('[TABS] Rendering browse list...');
                    renderPropertiesBrowseList();
                } else if (tabName === 'map') {
                    renderMapTabLegend();
                } else if (tabName === 'overview') {
                    updateSidebarStats();
                    renderLegend();
                }
            };

            window.addPropertyFromTab = async function() {
                const name = document.getElementById('new-prop-name').value.trim();
                const address = document.getElementById('new-prop-address').value.trim();
                const borough = document.getElementById('new-prop-borough').value;
                const rent = parseFloat(document.getElementById('new-prop-rent').value);
                const floor = document.getElementById('new-prop-floor').value.trim();
                const lift = document.getElementById('new-prop-lift').value === 'true';
                const gender = document.getElementById('new-prop-gender').value;
                const link = document.getElementById('new-prop-link').value.trim();
                
                if (!name || !address || !borough || !rent) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                showToast('Adding...', 'Geocoding address...');
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                    const data = await response.json();
                    
                    if (data.length === 0) {
                        alert('Could not find coordinates. Try a more specific address.');
                        return;
                    }
                    
                    const { lat, lon } = data[0];
                    
                    const newProperty = {
                        id: Date.now(),
                        name, address, borough, rent,
                        lat: parseFloat(lat),
                        lng: parseFloat(lon),
                        floor, lift, gender, link,
                        status: 'available',
                        dateAdded: new Date().toISOString()
                    };
                    
                    properties.push(newProperty);
                    window.properties = properties;
                    
                    if (savePropertiesToStorage()) {
                        showToast('Added!', name + ' added successfully');
                        
                        document.getElementById('new-prop-name').value = '';
                        document.getElementById('new-prop-address').value = '';
                        document.getElementById('new-prop-borough').value = '';
                        document.getElementById('new-prop-rent').value = '';
                        document.getElementById('new-prop-floor').value = '';
                        document.getElementById('new-prop-lift').value = 'false';
                        document.getElementById('new-prop-gender').value = 'any';
                        document.getElementById('new-prop-link').value = '';
                        
                        renderPropertyList();
                        updateMarkers();
                        renderLegend();
                        switchSidebarTab('browse');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            };

            window.setPropertyFilter = function(filter) {
                browseFilter = filter;
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.toggle('active', chip.dataset.filter === filter);
                });
                renderPropertiesBrowseList();
            };

            window.filterPropertiesList = function() {
                renderPropertiesBrowseList();
            };

            window.sortPropertiesBrowse = function(sortType) {
                browseSort = sortType;
                renderPropertiesBrowseList();
            };

            window.togglePropertyAndSync = function(id) {
                toggleProperty(id);
            };

            window.editPropertyDetails = function(id) {
                const prop = properties.find(p => p.id === id);
                if (prop) {
                    // Populate form
                    document.getElementById('edit-property-id').value = prop.id;
                    document.getElementById('edit-property-name').value = prop.name;
                    document.getElementById('edit-property-address').value = prop.address;
                    document.getElementById('edit-property-borough').value = prop.borough;
                    document.getElementById('edit-property-rent').value = prop.rent;
                    document.getElementById('edit-property-notes').value = prop.notes || '';
                    document.getElementById('edit-client-name').value = prop.assignedTo || '';
                    
                    // Set date added (formatted for display)
                    const dateAdded = prop.dateAdded ? new Date(prop.dateAdded).toLocaleDateString('en-GB', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    }) : 'Not set';
                    document.getElementById('edit-property-date').value = dateAdded;
                    
                    // Set status
                    const isTaken = takenProperties.has(prop.id);
                    document.getElementById('status-available').checked = !isTaken;
                    document.getElementById('status-taken').checked = isTaken;
                    
                    // Show/hide client section
                    document.getElementById('client-assignment-section').style.display = isTaken ? 'block' : 'none';
                    
                    // Update title
                    document.getElementById('edit-modal-title').textContent = 'Edit: ' + prop.name;
                    
                    // Show modal
                    document.getElementById('edit-modal').style.display = 'flex';
                }
            };

            function renderPropertiesBrowseList() {
                const container = document.getElementById('properties-browse-list');
                if (!container) return;
                
                const searchTerm = (document.getElementById('property-search')?.value || '').toLowerCase();
                
                // Group properties by main address (extract base address without studio number)
                const addressGroups = {};
                properties.forEach(prop => {
                    // Extract main address (everything after studio number)
                    const mainAddress = prop.address.replace(/^(Studio \d+[a-z]?|Flat \d+)\s*/i, '').trim();
                    
                    if (!addressGroups[mainAddress]) {
                        addressGroups[mainAddress] = {
                            mainAddress: mainAddress,
                            borough: prop.borough,
                            properties: [],
                            lat: prop.lat,
                            lng: prop.lng
                        };
                    }
                    addressGroups[mainAddress].properties.push(prop);
                });
                
                // Filter groups
                let filteredGroups = Object.values(addressGroups).filter(group => {
                    const matchesSearch = !searchTerm || 
                        group.mainAddress.toLowerCase().includes(searchTerm) ||
                        group.borough.toLowerCase().includes(searchTerm) ||
                        group.properties.some(p => p.name.toLowerCase().includes(searchTerm));
                    
                    const hasMatchingFilter = group.properties.some(p => {
                        const isTaken = takenProperties.has(p.id);
                        return browseFilter === 'all' || 
                            (browseFilter === 'available' && !isTaken) ||
                            (browseFilter === 'taken' && isTaken);
                    });
                    
                    return matchesSearch && hasMatchingFilter;
                });
                
                // Sort groups
                filteredGroups.sort((a, b) => {
                    switch(browseSort) {
                        case 'recent': 
                            const maxDateA = Math.max(...a.properties.map(p => new Date(p.dateAdded || 0)));
                            const maxDateB = Math.max(...b.properties.map(p => new Date(p.dateAdded || 0)));
                            return maxDateB - maxDateA;
                        case 'oldest':
                            const minDateA = Math.min(...a.properties.map(p => new Date(p.dateAdded || 0)));
                            const minDateB = Math.min(...b.properties.map(p => new Date(p.dateAdded || 0)));
                            return minDateA - minDateB;
                        case 'alpha-asc': 
                            return a.mainAddress.localeCompare(b.mainAddress);
                        case 'price-high':
                            const avgRentA = a.properties.reduce((sum, p) => sum + p.rent, 0) / a.properties.length;
                            const avgRentB = b.properties.reduce((sum, p) => sum + p.rent, 0) / b.properties.length;
                            return avgRentB - avgRentA;
                        case 'borough': 
                            return a.borough.localeCompare(b.borough);
                        default: return 0;
                    }
                });
                
                const allCount = properties.length;
                const availableCount = properties.filter(p => !takenProperties.has(p.id)).length;
                const takenCount = allCount - availableCount;
                
                if (document.getElementById('filter-all-count')) document.getElementById('filter-all-count').textContent = allCount;
                if (document.getElementById('filter-available-count')) document.getElementById('filter-available-count').textContent = availableCount;
                if (document.getElementById('filter-taken-count')) document.getElementById('filter-taken-count').textContent = takenCount;
                
                container.innerHTML = filteredGroups.map(group => {
                    const availableInGroup = group.properties.filter(p => !takenProperties.has(p.id)).length;
                    const takenInGroup = group.properties.length - availableInGroup;
                    const avgRent = (group.properties.reduce((sum, p) => sum + p.rent, 0) / group.properties.length).toFixed(2);
                    
                    // Get oldest property age in group
                    const oldestAge = Math.max(...group.properties.map(p => getPropertyAge(p)));
                    const ageColor = getPropertyAgeColor(oldestAge);
                    const ageLabel = getPropertyAgeLabel(oldestAge);
                    
                    const allTaken = availableInGroup === 0;
                    const allAvailable = takenInGroup === 0;
                    
                    return `
                        <div class="property-browse-card ${allTaken ? 'taken' : ''}" style="border-left: 4px solid ${ageColor};">
                            <div class="property-card-header">
                                <div class="property-card-title">
                                    <i class="fas fa-building"></i> ${group.mainAddress}
                                    <span style="font-size: 12px; color: var(--text-grey); margin-left: 8px;">(${group.properties.length} studio${group.properties.length > 1 ? 's' : ''})</span>
                                </div>
                                <div class="property-card-rent">£${avgRent} <span style="font-size: 11px; opacity: 0.7;">avg</span></div>
                            </div>
                            
                            <div class="property-card-address">
                                <i class="fas fa-map-marker-alt"></i> ${group.mainAddress}
                            </div>
                            
                            <div class="property-card-meta">
                                <div class="property-meta-tag">
                                    <i class="fas fa-map"></i> ${group.borough}
                                </div>
                                <div class="property-meta-tag" style="background: ${allAvailable ? '#10b981' : allTaken ? '#ef4444' : '#f59e0b'}; color: white;">
                                    <i class="fas fa-chart-pie"></i> ${availableInGroup} Available / ${takenInGroup} Taken
                                </div>
                                <div class="property-meta-tag" style="border-left: 3px solid ${ageColor};">
                                    <i class="fas fa-clock"></i> ${ageLabel}
                                </div>
                            </div>
                            
                            <!-- Individual Studios -->
                            <div style="margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                                    ${group.properties.map(prop => {
                                        const isTaken = takenProperties.has(prop.id);
                                        return `
                                            <div style="padding: 8px; background: ${isTaken ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)'}; border-radius: 6px; border-left: 3px solid ${isTaken ? '#ef4444' : '#10b981'};">
                                                <div style="font-size: 13px; font-weight: 600; color: var(--text-white); margin-bottom: 4px;">
                                                    ${prop.name}
                                                </div>
                                                <div style="font-size: 11px; color: var(--text-grey);">
                                                    ${prop.floor ? `<i class="fas fa-layer-group"></i> ${prop.floor} • ` : ''}£${prop.rent}/mo
                                                </div>
                                                <div style="margin-top: 6px; display: flex; gap: 4px;">
                                                    <button class="property-mini-btn ${isTaken ? 'taken' : 'available'}" 
                                                            onclick="event.stopPropagation(); togglePropertyAndSync(${prop.id})"
                                                            style="flex: 1; padding: 4px 8px; font-size: 10px; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; background: ${isTaken ? '#10b981' : '#ef4444'}; color: white;">
                                                        <i class="fas fa-${isTaken ? 'check' : 'times'}-circle"></i> ${isTaken ? 'Available' : 'Taken'}
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Bulk Actions -->
                            <div class="property-card-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="property-action-btn" onclick="event.stopPropagation(); bulkEditAddress('${group.mainAddress}')" style="flex: 1; background: linear-gradient(135deg, #8E1616, #1d4ed8);">
                                    <i class="fas fa-edit"></i> Edit All Studios
                                </button>
                                <button class="property-action-btn" onclick="event.stopPropagation(); bulkToggleAddress('${group.mainAddress}', ${!allTaken})" style="background: ${allTaken ? '#10b981' : '#ef4444'};">
                                    <i class="fas fa-${allTaken ? 'check' : 'times'}-circle"></i> Mark All ${allTaken ? 'Available' : 'Taken'}
                                </button>
                                <button class="property-action-btn" onclick="event.stopPropagation(); viewOnMap(${group.lat}, ${group.lng})" style="background: #8E1616;">
                                    <i class="fas fa-map-marked-alt"></i> View on Map
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (filteredGroups.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p style="font-size: 14px; margin: 0;">No properties found</p>
                        </div>
                    `;
                }
            }
            
            // Bulk edit all studios at an address
            window.bulkEditAddress = function(mainAddress) {
                const group = properties.filter(p => p.address.replace(/^(Studio \d+[a-z]?|Flat \d+)\s*/i, '').trim() === mainAddress);
                if (group.length === 0) return;
                
                const firstProp = group[0];
                const newBorough = prompt('Enter new borough for all studios at ' + mainAddress + ':', firstProp.borough);
                if (!newBorough) return;
                
                const newRent = prompt('Enter new monthly rent for all studios:', firstProp.rent);
                if (!newRent || isNaN(parseFloat(newRent))) return;
                
                const confirmed = confirm(`Update ${group.length} studios at ${mainAddress}?\n\nNew Borough: ${newBorough}\nNew Rent: £${newRent}/month`);
                if (!confirmed) return;
                
                group.forEach(prop => {
                    prop.borough = newBorough;
                    prop.rent = parseFloat(newRent);
                });
                
                savePropertiesToStorage();
                renderPropertyList();
                updateMarkers();
                showToast('Success', `Updated ${group.length} studios at ${mainAddress}`);
            };
            
            // Bulk toggle all studios at an address
            window.bulkToggleAddress = function(mainAddress, markAsTaken) {
                const group = properties.filter(p => p.address.replace(/^(Studio \d+[a-z]?|Flat \d+)\s*/i, '').trim() === mainAddress);
                if (group.length === 0) return;
                
                const confirmed = confirm(`Mark all ${group.length} studios at ${mainAddress} as ${markAsTaken ? 'TAKEN' : 'AVAILABLE'}?`);
                if (!confirmed) return;
                
                group.forEach(prop => {
                    if (markAsTaken) {
                        takenProperties.add(prop.id);
                    } else {
                        takenProperties.delete(prop.id);
                    }
                });
                
                savePropertiesToStorage();
                renderPropertyList();
                updateMarkers();
                showToast('Success', `Marked ${group.length} studios as ${markAsTaken ? 'taken' : 'available'}`);
            };
            
            // View location on map
            window.viewOnMap = function(lat, lng) {
                if (map && lat && lng) {
                    map.setView([lat, lng], 16);
                    switchSidebarTab('overview');
                    showToast('Map Updated', 'Zoomed to property location');
                }
            };

            function renderMapTabLegend() {
                const legendContainer = document.getElementById('legend-map-tab');
                if (!legendContainer) return;
                
                legendContainer.innerHTML = '';
                
                Object.keys(boroughColors).forEach(borough => {
                    const total = properties.filter(p => p.borough === borough).length;
                    const available = properties.filter(p => p.borough === borough && !takenProperties.has(p.id)).length;
                    
                    const item = document.createElement('div');
                    item.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; background: var(--dark-navy);';
                    item.onmouseover = () => item.style.background = 'var(--border-color)';
                    item.onmouseout = () => item.style.background = 'var(--dark-navy)';
                    item.onclick = () => filterByBorough(borough);
                    
                    item.innerHTML = `
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${boroughColors[borough]}; flex-shrink: 0; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                        <span style="font-size: 11px; color: var(--text-light); flex: 1;">${borough}</span>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-light);">${available}/${total}</span>
                    `;
                    
                    legendContainer.appendChild(item);
                });
            }
            // === END TABBED SIDEBAR FUNCTIONS ===

            window.changeMonth = function(delta) {
                currentDate.setMonth(currentDate.getMonth() + delta);
                renderCalendar();
            };

            function renderLegend() {
                const legendDiv = document.getElementById('legend');
                const legendMapTab = document.getElementById('legend-map-tab');
                
                if (!legendDiv && !legendMapTab) return;
                
                const legendContent = [];
                
                Object.keys(boroughColors).forEach(borough => {
                    const total = properties.filter(p => p.borough === borough).length;
                    const available = properties.filter(p => p.borough === borough && !takenProperties.has(p.id)).length;
                    
                    const itemHTML = `
                        <div style="display: flex; align-items: center; gap: 6px; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; background: var(--dark-navy);" 
                             onmouseover="this.style.background='var(--border-color)'" 
                             onmouseout="this.style.background='var(--dark-navy)'"
                             onclick="filterByBorough('${borough}')">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${boroughColors[borough]}; flex-shrink: 0; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                            <span style="font-size: 11px; color: var(--text-light); flex: 1;">${borough}</span>
                            <span style="font-size: 11px; font-weight: 700; color: var(--text-light);">${available}/${total}</span>
                        </div>
                    `;
                    legendContent.push(itemHTML);
                });
                
                const html = legendContent.join('');
                if (legendDiv) legendDiv.innerHTML = html;
                if (legendMapTab) legendMapTab.innerHTML = html;
                
                // Update sidebar stats
                updateSidebarStats();
            }

            initMap();
            renderLegend();
            renderPropertyList();
            
            // Wait for map to be fully initialized before adding markers
            setTimeout(() => {
                console.log('[INIT] Adding markers to map...');
                updateMarkers();
            }, 500);
            
            // Initialize the active tab (overview)
            setTimeout(() => {
                updateSidebarStats();
                console.log('[INIT] Sidebar initialized');
            }, 100);
            
            renderCalendar();
            renderViewingsList();
            populateUpfrontCalculator();
            populateEligibilityPropertySelector();
            
            // ========== RESIZABLE SIDEBARS ==========
            let isResizing = null;
            let startX = 0;
            let startWidth = 0;
            
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const leftHandle = document.getElementById('left-resize-handle');
            const rightHandle = document.getElementById('right-resize-handle');
            const leftToggle = document.querySelector('.sidebar-toggle.left');
            
            function startResize(e, sidebar, handle) {
                e.preventDefault();
                isResizing = sidebar;
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(sidebar).width);
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
            }
            
            function doResize(e) {
                if (!isResizing) return;
                
                const delta = isResizing === leftSidebar ? e.clientX - startX : startX - e.clientX;
                const newWidth = Math.max(280, Math.min(800, startWidth + delta));
                
                isResizing.style.width = newWidth + 'px';
                isResizing.style.flexBasis = newWidth + 'px';
                
                // Update toggle button position for left sidebar
                if (isResizing === leftSidebar && leftToggle) {
                    leftToggle.style.left = newWidth + 'px';
                }
                
                // Force map to resize
                if (map) {
                    setTimeout(() => map.invalidateSize(), 50);
                }
            }
            
            function stopResize() {
                if (isResizing) {
                    isResizing = null;
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';
                    if (map) map.invalidateSize();
                }
            }
            
            // Add event listeners for resize handles
            if (leftHandle) {
                leftHandle.addEventListener('mousedown', (e) => startResize(e, leftSidebar, leftHandle));
            }
            if (rightHandle) {
                rightHandle.addEventListener('mousedown', (e) => startResize(e, rightSidebar, rightHandle));
            }
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            // ========== END RESIZABLE SIDEBARS ==========
        });
    </script>

    <!-- Property Modal -->
    <div id="property-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> <span id="modal-title">Add Property</span></h2>
                <button class="modal-close" onclick="closePropertyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="property-form" onsubmit="saveProperty(event); return false;">
                    <input type="hidden" id="property-id">
                    
                    <!-- Basic Information -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-info-circle"></i> Basic Information
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Studio/Unit Name *</label>
                                <input type="text" id="property-name" placeholder="e.g., Studio 3" required>
                                <small style="font-size: 11px; color: #666;">The unit identifier (e.g., Studio 3, Flat 2A)</small>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Property Type *</label>
                                <select id="property-type" required>
                                    <option value="">Select...</option>
                                    <option value="Studio">Studio</option>
                                    <option value="1-Bed">1-Bedroom Flat</option>
                                    <option value="2-Bed">2-Bedroom Flat</option>
                                    <option value="3-Bed">3-Bedroom House</option>
                                    <option value="Room">Single Room</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Full Address * <span style="font-size: 11px; color: #999;">(Building name/number, Street, Postcode, Borough)</span></label>
                            <input type="text" id="property-address" placeholder="e.g., 48 Copley Park SW16 3DP Lambeth" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Borough *</label>
                                <select id="property-borough" required>
                                    <option value="">Select London Borough...</option>
                                    <option value="Barking and Dagenham">Barking and Dagenham</option>
                                    <option value="Barnet">Barnet</option>
                                    <option value="Bexley">Bexley</option>
                                    <option value="Brent">Brent</option>
                                    <option value="Bromley">Bromley</option>
                                    <option value="Camden">Camden</option>
                                    <option value="Croydon">Croydon</option>
                                    <option value="Ealing">Ealing</option>
                                    <option value="Enfield">Enfield</option>
                                    <option value="Greenwich">Greenwich</option>
                                    <option value="Hackney">Hackney</option>
                                    <option value="Hammersmith and Fulham">Hammersmith and Fulham</option>
                                    <option value="Haringey">Haringey</option>
                                    <option value="Harrow">Harrow</option>
                                    <option value="Havering">Havering</option>
                                    <option value="Hillingdon">Hillingdon</option>
                                    <option value="Hounslow">Hounslow</option>
                                    <option value="Islington">Islington</option>
                                    <option value="Kensington and Chelsea">Kensington and Chelsea</option>
                                    <option value="Kingston upon Thames">Kingston upon Thames</option>
                                    <option value="Lambeth">Lambeth</option>
                                    <option value="Lewisham">Lewisham</option>
                                    <option value="Merton">Merton</option>
                                    <option value="Newham">Newham</option>
                                    <option value="Redbridge">Redbridge</option>
                                    <option value="Richmond upon Thames">Richmond upon Thames</option>
                                    <option value="Southwark">Southwark</option>
                                    <option value="Sutton">Sutton</option>
                                    <option value="Tower Hamlets">Tower Hamlets</option>
                                    <option value="Waltham Forest">Waltham Forest</option>
                                    <option value="Wandsworth">Wandsworth</option>
                                    <option value="Westminster">Westminster</option>
                                    <option value="City of London">City of London</option>
                                    <optgroup label="Greater London Areas">
                                        <option value="Epsom">Epsom (Surrey)</option>
                                        <option value="Epsom and Ewell">Epsom and Ewell (Surrey)</option>
                                        <option value="Hertsmere">Hertsmere (Hertfordshire)</option>
                                        <option value="Hertfordshire">Hertfordshire</option>
                                        <option value="Potters Bar">Potters Bar (Hertfordshire)</option>
                                        <option value="Thurrock">Thurrock (Essex)</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Floor *</label>
                                <select id="property-floor" required>
                                    <option value="">Select...</option>
                                    <option value="Basement">Basement</option>
                                    <option value="GF">Ground Floor (GF)</option>
                                    <option value="1st">1st Floor</option>
                                    <option value="2nd">2nd Floor</option>
                                    <option value="3rd">3rd Floor</option>
                                    <option value="4th">4th Floor</option>
                                    <option value="5th">5th Floor</option>
                                    <option value="6th+">6th Floor or Higher</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial & Occupancy -->
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-pound-sign"></i> Financial & Occupancy
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Monthly Rent (£) *</label>
                                <input type="number" id="property-rent" placeholder="e.g., 1291.98" step="0.01" required>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Bedrooms *</label>
                                <input type="number" id="property-bedrooms" min="0" max="10" value="1" required>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Max Occupancy *</label>
                                <input type="number" id="property-occupancy" min="1" max="10" value="1" required>
                            </div>
                        </div>
                        
                        <!-- STUDIO TRACKING -->
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Total Studios at Address</label>
                                <input type="number" id="property-total-studios" min="1" max="20" value="1" onchange="generateStudioGrid()" placeholder="How many studios here?">
                                <small style="font-size: 11px; color: #666;">If multiple studios share this address</small>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Rent Per Studio (£)</label>
                                <input type="number" id="property-rent-per-studio" step="0.01" placeholder="Same as monthly rent">
                                <small style="font-size: 11px; color: #666;">Leave blank if same as above</small>
                            </div>
                        </div>
                        
                        <!-- Studio Grid -->
                        <div id="studio-grid-container" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; margin: 0;">Studios Status</label>
                                <span id="studio-occupancy-summary" style="font-size: 12px; color: #666;"></span>
                            </div>
                            <div id="studio-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px;">
                                <!-- Studios will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Features & Restrictions -->
                    <div style="background: #fff4e6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-star"></i> Features & Restrictions
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Gender Restriction</label>
                                <select id="property-gender">
                                    <option value="any">Any Gender</option>
                                    <option value="female">Women Only</option>
                                    <option value="male">Men Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="property-lift" style="width: 20px; height: 20px;">
                                    <span>Lift Available?</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="property-bills" checked style="width: 20px; height: 20px;">
                                    <span>Bills Included?</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="property-pets" style="width: 20px; height: 20px;">
                                    <span>Pets Allowed?</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status & Availability -->
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-check-circle"></i> Status & Availability
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Property Status *</label>
                                <select id="property-status" onchange="toggleTakenFields()" required>
                                    <option value="available">✓ Available</option>
                                    <option value="reserved">⏳ Reserved</option>
                                    <option value="taken">✗ Taken</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Date Added *</label>
                                <input type="date" id="property-date" required>
                                <small style="font-size: 11px; color: #666;">When was this property added?</small>
                            </div>
                        </div>
                        
                        <div class="form-row" id="taken-by-field" style="display: none;">
                            <div class="form-group" style="flex: 1;">
                                <label>Taken By (Client Name)</label>
                                <input type="text" id="property-taken-by" placeholder="Client who took the property">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location & Links -->
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-map-marker-alt"></i> Location & Links
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Latitude *</label>
                                <input type="number" id="property-lat" placeholder="e.g., 51.4362" step="0.000001" required>
                                <small style="font-size: 11px; color: #666;">Use Google Maps to find coordinates</small>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label>Longitude *</label>
                                <input type="number" id="property-lng" placeholder="e.g., -0.0153" step="0.000001" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Property Listing URL <span style="font-size: 11px; color: #999;">(optional)</span></label>
                            <input type="url" id="property-link" placeholder="https://your-website.com/property/...">
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div style="background: #fce4ec; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-sticky-note"></i> Additional Notes
                        </h3>
                        
                        <div class="form-group">
                            <textarea id="property-notes" rows="3" placeholder="Any additional information about this property (e.g., special features, nearby amenities, condition notes)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit;"></textarea>
                        </div>
                    </div>
                    
                    <!-- Viewing History (only show when editing) -->
                    <div id="viewing-history-section" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">
                            <i class="fas fa-history"></i> Viewing History
                        </h3>
                        <div id="viewing-history-list"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePropertyModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('property-form').requestSubmit()">
                    <i class="fas fa-save"></i> Save Property
                </button>
            </div>
        </div>
    </div>
<!-- PASTE THIS ENTIRE BLOCK AT THE BOTTOM OF YOUR HTML FILE, RIGHT BEFORE </body> -->

<style>
/* Referral System Styles */
/* FLOATING ACTION MENU SYSTEM */
.floating-menu {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9998;
}

.floating-main-btn {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red) 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
    cursor: pointer;
    font-size: 24px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.floating-main-btn:hover {
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 6px 30px rgba(37, 99, 235, 0.6);
}

.floating-menu.active .floating-main-btn {
    transform: rotate(45deg);
}

.floating-menu-items {
    position: absolute;
    bottom: 85px;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s;
}

.floating-menu.active .floating-menu-items {
    opacity: 1;
    pointer-events: all;
}

.floating-menu-item {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    animation: slideIn 0.3s ease forwards;
    opacity: 0;
}

.floating-menu.active .floating-menu-item:nth-child(1) { animation-delay: 0.05s; }
.floating-menu.active .floating-menu-item:nth-child(2) { animation-delay: 0.1s; }
.floating-menu.active .floating-menu-item:nth-child(3) { animation-delay: 0.15s; }
.floating-menu.active .floating-menu-item:nth-child(4) { animation-delay: 0.2s; }
.floating-menu.active .floating-menu-item:nth-child(5) { animation-delay: 0.25s; }

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
    from {
        opacity: 0;
        transform: translateY(10px);
    }
}

.floating-menu-label {
    background: rgba(30, 58, 95, 0.95);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.floating-menu-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red) 100%);
    color: white;
    border: none;
    box-shadow: 0 3px 12px rgba(37, 99, 235, 0.35);
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.floating-menu-btn:hover {
    transform: scale(1.15);
    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
}

.floating-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--dark-navy);
}

/* Legacy support */
#referrals-floating-btn {
    display: none;
}
.ref-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    border: 2px solid white;
}
#referrals-panel {
    position: fixed;
    top: 0;
    right: -450px;
    width: 450px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 20px rgba(0,0,0,0.2);
    z-index: 9999;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}
#referrals-panel.open {
    right: 0;
}
.ref-panel-header {
    background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ref-panel-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.2s;
}
.ref-panel-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}
.ref-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.ref-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}
.ref-stat-card {
    background: linear-gradient(135deg, var(--primary-orange) 0%, var(--secondary-orange) 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}
.ref-stat-card.new { background: linear-gradient(135deg, #8E1616, #6b0f0f); }
.ref-stat-card.active { background: linear-gradient(135deg, #f39c12, #e67e22); }
.ref-stat-card.housed { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.ref-stat-value {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 3px;
}
.ref-stat-label {
    font-size: 10px;
    opacity: 0.9;
    text-transform: uppercase;
}
.ref-quick-form {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.ref-form-group {
    margin-bottom: 10px;
}
.ref-form-group input,
.ref-form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}
.ref-btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.ref-btn-primary {
    background: #2ecc71;
    color: white;
}
.ref-btn-primary:hover {
    background: #27ae60;
}
.ref-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
}
.ref-filter-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background: #e0e0e0;
    color: #333;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.ref-filter-btn:hover {
    background: #d0d0d0;
}
.ref-filter-btn.active {
    background: var(--primary-orange);
    color: white;
}
.ref-card {
    background: white;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 4px solid var(--primary-orange);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}
.ref-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.ref-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
}
.ref-card-name {
    font-weight: 600;
    font-size: 14px;
    color: #333;
}
.ref-status-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}
.ref-card-info {
    font-size: 11px;
    color: #666;
    margin-bottom: 8px;
}
.ref-card-actions {
    display: flex;
    gap: 4px;
}
.ref-card-btn {
    flex: 1;
    padding: 5px;
    border: none;
    border-radius: 3px;
    font-size: 10px;
    cursor: pointer;
    color: white;
    font-weight: 600;
    transition: all 0.2s;
}
.ref-card-btn:hover {
    opacity: 0.8;
}
</style>

<!-- Floating Button -->
<!-- FLOATING ACTION MENU -->
<div class="floating-menu" id="floatingMenu">
    <button class="floating-main-btn" onclick="toggleFloatingMenu()">
        <i class="fas fa-plus"></i>
    </button>
    <div class="floating-menu-items">
        <div class="floating-menu-item">
            <span class="floating-menu-label">Eligibility Check</span>
            <button class="floating-menu-btn" onclick="quickOpenEligibility()" title="Eligibility">
                <i class="fas fa-check-circle"></i>
            </button>
        </div>
        <div class="floating-menu-item">
            <span class="floating-menu-label">Book Viewing</span>
            <button class="floating-menu-btn" onclick="quickOpenBooking()" title="Booking">
                <i class="fas fa-calendar-alt"></i>
            </button>
        </div>
        <div class="floating-menu-item">
            <span class="floating-menu-label">View Pipeline</span>
            <button class="floating-menu-btn" onclick="quickOpenPipeline()" title="Pipeline">
                <i class="fas fa-chart-line"></i>
                <span class="floating-badge" id="pipeline-badge">0</span>
            </button>
        </div>
        <div class="floating-menu-item">
            <span class="floating-menu-label">Referrals</span>
            <button class="floating-menu-btn" onclick="toggleReferralsPanel()" title="Referrals">
                <i class="fas fa-user-friends"></i>
                <span class="floating-badge" id="referrals-badge">0</span>
            </button>
        </div>
        <div class="floating-menu-item">
            <span class="floating-menu-label">Add Property</span>
            <button class="floating-menu-btn" onclick="quickAddProperty()" title="Add Property">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Floating Menu Toggle
function toggleFloatingMenu() {
    const menu = document.getElementById('floatingMenu');
    menu.classList.toggle('active');
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('floatingMenu');
    if (!menu.contains(event.target) && menu.classList.contains('active')) {
        menu.classList.remove('active');
    }
});

// Quick action functions
function quickOpenEligibility() {
    switchToRightTab('eligibility');
    document.getElementById('floatingMenu').classList.remove('active');
}

function quickOpenBooking() {
    switchToRightTab('booking');
    document.getElementById('floatingMenu').classList.remove('active');
}

function quickOpenPipeline() {
    switchToRightTab('pipeline');
    document.getElementById('floatingMenu').classList.remove('active');
}

function quickAddProperty() {
    openAddPropertyModal();
    document.getElementById('floatingMenu').classList.remove('active');
}

// Update badges dynamically
function updateFloatingBadges() {
    const pipelineData = loadPipelineData();
    const referralsData = loadReferralsData();
    
    const pipelineBadge = document.getElementById('pipeline-badge');
    const referralsBadge = document.getElementById('referrals-badge');
    
    if (pipelineBadge) {
        const activeCount = pipelineData.filter(p => p.status !== 'Signed Up').length;
        pipelineBadge.textContent = activeCount;
        pipelineBadge.style.display = activeCount > 0 ? 'flex' : 'none';
    }
    
    if (referralsBadge) {
        const activeRefs = referralsData.filter(r => r.status === 'Active').length;
        referralsBadge.textContent = activeRefs;
        referralsBadge.style.display = activeRefs > 0 ? 'flex' : 'none';
    }
}

// Update badges on load and periodically
setInterval(updateFloatingBadges, 5000);
setTimeout(updateFloatingBadges, 1000);

// ==================== MISSING FUNCTIONS - NOW ADDED ====================

// Switch to right sidebar tab
function switchToRightTab(tabName) {
    // Right sidebar tabs system
    const tab = document.querySelector(`[onclick*="switchTab('${tabName}')"]`);
    if (tab) {
        tab.click();
    } else {
        console.log('Switching to tab:', tabName);
        // If no tab button found, try showing the content directly
        showTab(tabName);
    }
}

// Switch to left sidebar tab
function switchToLeftTab(tabName) {
    if (typeof switchSidebarTab === 'function') {
        switchSidebarTab(tabName);
    }
}

// Get property age in days
function getPropertyAge(property) {
    if (!property.dateAdded) return 999; // Very old if no date
    const addedDate = new Date(property.dateAdded);
    const now = new Date();
    const diffTime = Math.abs(now - addedDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

// Get property age color
function getPropertyAgeColor(days) {
    if (days <= 28) return '#10b981'; // Green - new (0-28 days)
    if (days <= 60) return '#f59e0b'; // Yellow - medium (29-60 days)
    if (days <= 90) return '#ef4444'; // Red - old (61-90 days)
    return '#9ca3af'; // Grey - very old (90+ days)
}

// Get property age label
function getPropertyAgeLabel(days) {
    if (days <= 28) return '0-28 days (New)';
    if (days <= 60) return '29-60 days';
    if (days <= 90) return '61-90 days';
    return '90+ days (Old)';
}

// Toggle referrals panel
function toggleReferralsPanel() {
    const panel = document.getElementById('referrals-panel');
    if (panel) {
        panel.classList.toggle('active');
    }
}

// ==================== END MISSING FUNCTIONS ====================

// ==================== LOCATION INTELLIGENCE SYSTEM ====================
let currentLocationProperty = null;
let amenityMarkers = [];

// Populate property selectors on load
function populateLocationSelectors() {
    const select = document.getElementById('location-property-select');
    if (!select) return;
    
    select.innerHTML = '<option value="">Choose property to analyze...</option>';
    properties.forEach(p => {
        select.innerHTML += `<option value="${p.id}">${p.name} - ${p.address}</option>`;
    });
}

// Load location intelligence for selected property
window.loadLocationIntelligence = function(propertyId) {
    if (!propertyId) {
        currentLocationProperty = null;
        return;
    }
    
    const property = properties.find(p => p.id == propertyId);
    if (!property) return;
    
    currentLocationProperty = property;
    
    // Zoom map to property
    if (map && property.lat && property.lng) {
        map.setView([property.lat, property.lng], 15);
    }
    
    showToast('Property Selected', `Analyzing location for ${property.name}`);
};

// Calculate commute times
window.calculateCommutes = function() {
    if (!currentLocationProperty) {
        alert('Please select a property first');
        return;
    }
    
    const destinations = [
        document.getElementById('commute-dest-1').value.trim(),
        document.getElementById('commute-dest-2').value.trim(),
        document.getElementById('commute-dest-3').value.trim()
    ].filter(d => d);
    
    if (destinations.length === 0) {
        alert('Please enter at least one destination');
        return;
    }
    
    const resultsDiv = document.getElementById('commute-results');
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-grey);"><i class="fas fa-spinner fa-spin"></i> Calculating routes...</div>';
    
    // Simulate API call (replace with real TfL/Google Maps API)
    setTimeout(() => {
        let html = '<div style="background: var(--dark-bg); border-radius: 8px; padding: 15px;">';
        html += `<div style="font-size: 12px; color: var(--text-grey); margin-bottom: 12px;"><i class="fas fa-map-marker-alt"></i> From: ${currentLocationProperty.address}</div>`;
        
        destinations.forEach((dest, i) => {
            // Mock travel times (replace with actual API data)
            const tube = Math.floor(Math.random() * 30 + 20);
            const bus = Math.floor(Math.random() * 20 + tube);
            const walk = Math.floor(Math.random() * 40 + 60);
            
            html += `
                <div style="background: var(--medium-bg); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--primary-red);">
                    <div style="font-weight: 600; margin-bottom: 8px; color: white;"><i class="fas fa-map-pin"></i> ${dest}</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 80px; text-align: center; padding: 8px; background: var(--dark-bg); border-radius: 4px;">
                            <div style="color: var(--primary-red); font-size: 20px; font-weight: 700;">${tube}m</div>
                            <div style="font-size: 10px; color: var(--text-grey); margin-top: 2px;"><i class="fas fa-subway"></i> Tube</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; text-align: center; padding: 8px; background: var(--dark-bg); border-radius: 4px;">
                            <div style="color: #f59e0b; font-size: 20px; font-weight: 700;">${bus}m</div>
                            <div style="font-size: 10px; color: var(--text-grey); margin-top: 2px;"><i class="fas fa-bus"></i> Bus</div>
                        </div>
                        <div style="flex: 1; min-width: 80px; text-align: center; padding: 8px; background: var(--dark-bg); border-radius: 4px;">
                            <div style="color: #10b981; font-size: 20px; font-weight: 700;">${walk}m</div>
                            <div style="font-size: 10px; color: var(--text-grey); margin-top: 2px;"><i class="fas fa-walking"></i> Walk</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '<div style="font-size: 11px; color: var(--text-grey); text-align: center; margin-top: 10px;"><i class="fas fa-info-circle"></i> Times are approximate</div>';
        html += '</div>';
        resultsDiv.innerHTML = html;
    }, 1000);
};

// Search nearby amenities
window.searchNearby = function(type) {
    if (!currentLocationProperty) {
        alert('Please select a property first');
        return;
    }
    
    // Clear previous markers
    amenityMarkers.forEach(m => map.removeLayer(m));
    amenityMarkers = [];
    
    // Highlight active button
    document.querySelectorAll('.amenity-btn').forEach(btn => {
        if (btn.getAttribute('data-type') === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const resultsDiv = document.getElementById('amenities-results');
    const walkMins = parseInt(document.getElementById('walk-distance').value);
    
    resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-grey);"><i class="fas fa-spinner fa-spin"></i> Searching nearby...</div>';
    
    // Simulate API call (replace with real Overpass/Google Places API)
    setTimeout(() => {
        const icons = {
            supermarket: '🛒',
            gym: '🏋️',
            school: '🎓',
            restaurant: '🍽️',
            pharmacy: '💊',
            park: '🌳'
        };
        
        const names = {
            supermarket: ['Tesco Express', 'Sainsbury\'s Local', 'Co-op', 'Lidl', 'Aldi'],
            gym: ['PureGym', 'The Gym', 'Anytime Fitness', 'Fitness First', 'Virgin Active'],
            school: ['Primary School', 'Secondary School', 'Academy', 'Grammar School'],
            restaurant: ['Pizza Express', 'Nando\'s', 'Wagamama', 'Five Guys', 'Local Cafe'],
            pharmacy: ['Boots', 'Superdrug', 'LloydsPharmacy', 'Well Pharmacy'],
            park: ['Local Park', 'Recreation Ground', 'Community Garden', 'Playing Fields']
        };
        
        const count = Math.floor(Math.random() * 5 + 3);
        let html = '<div style="background: var(--dark-bg); border-radius: 8px; padding: 15px;">';
        html += `<div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: white;">${icons[type]} ${count} ${type}s within ${walkMins} min walk</div>`;
        
        for (let i = 0; i < count; i++) {
            const distance = Math.floor(Math.random() * (walkMins * 80) + 50);
            const walkTime = Math.floor(distance / 80);
            const name = names[type][Math.floor(Math.random() * names[type].length)];
            
            html += `
                <div style="background: var(--medium-bg); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; font-size: 13px; color: white;">${name}</div>
                        <div style="font-size: 11px; color: var(--text-grey); margin-top: 2px;">${distance}m away • ${walkTime} min walk</div>
                    </div>
                    <div style="color: var(--primary-red); font-size: 18px;">${icons[type]}</div>
                </div>
            `;
            
            // Add marker to map (mock location near property)
            if (currentLocationProperty.lat && currentLocationProperty.lng) {
                const lat = currentLocationProperty.lat + (Math.random() - 0.5) * 0.01;
                const lng = currentLocationProperty.lng + (Math.random() - 0.5) * 0.01;
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'amenity-marker',
                        html: `<div style="background: var(--primary-red); color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 12px;">${icons[type]}</div>`,
                        iconSize: [25, 25]
                    })
                }).addTo(map);
                
                marker.bindPopup(`<b>${name}</b><br>${distance}m • ${walkTime} min`);
                amenityMarkers.push(marker);
            }
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
        
        showToast('Amenities Found', `Found ${count} ${type}s nearby`);
    }, 800);
};

// Update amenities when walk distance changes
window.updateAmenities = function() {
    const activeBtn = document.querySelector('.amenity-btn.active');
    if (activeBtn) {
        const type = activeBtn.getAttribute('data-type');
        searchNearby(type);
    }
};

// Open Street View
window.openStreetView = function() {
    if (!currentLocationProperty) {
        alert('Please select a property first');
        return;
    }
    
    const container = document.getElementById('streetview-container');
    const lat = currentLocationProperty.lat;
    const lng = currentLocationProperty.lng;
    
    // Open Google Street View in new window
    const url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}`;
    window.open(url, '_blank');
    
    showToast('Street View', 'Opening Google Street View in new tab');
};

// Export location report as PDF
window.exportLocationReport = function() {
    if (!currentLocationProperty) {
        alert('Please select a property first');
        return;
    }
    
    showToast('Generating Report', 'Creating PDF report...');
    
    // Create report content
    const report = {
        property: currentLocationProperty,
        date: new Date().toLocaleDateString('en-GB'),
        commutes: document.getElementById('commute-results').innerText || 'No commute data',
        amenities: document.getElementById('amenities-results').innerText || 'No amenities data'
    };
    
    // Simulate PDF generation (in production, use jsPDF or similar)
    setTimeout(() => {
        const content = `
LOCATION INTELLIGENCE REPORT
Generated: ${report.date}

PROPERTY
${currentLocationProperty.name}
${currentLocationProperty.address}
${currentLocationProperty.borough}

COMMUTE TIMES
${report.commutes}

NEARBY AMENITIES
${report.amenities}

GENERATED BY RIDWAN HARIR'S PROPERTY MANAGEMENT
        `;
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `location-report-${currentLocationProperty.name.replace(/\s+/g, '-')}-${report.date}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Report Ready', 'Location report downloaded');
    }, 1000);
};

// Print location report
window.printLocationReport = function() {
    if (!currentLocationProperty) {
        alert('Please select a property first');
        return;
    }
    
    const printWindow = window.open('', '', 'width=800,height=600');
    const commutes = document.getElementById('commute-results').innerHTML || '<p>No commute data</p>';
    const amenities = document.getElementById('amenities-results').innerHTML || '<p>No amenities data</p>';
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Location Report - ${currentLocationProperty.name}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #dc143c; border-bottom: 3px solid #dc143c; padding-bottom: 10px; }
                h2 { color: #333; margin-top: 30px; }
                .property-info { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
                .date { color: #666; font-size: 14px; }
                @media print {
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            <h1>Location Intelligence Report</h1>
            <div class="date">Generated: ${new Date().toLocaleDateString('en-GB')}</div>
            
            <div class="property-info">
                <h2>Property Details</h2>
                <p><strong>${currentLocationProperty.name}</strong></p>
                <p>${currentLocationProperty.address}</p>
                <p>${currentLocationProperty.borough}</p>
                <p>Monthly Rent: £${currentLocationProperty.rent}</p>
            </div>
            
            <h2>Commute Times</h2>
            ${commutes}
            
            <h2>Nearby Amenities</h2>
            ${amenities}
            
            <div style="margin-top: 50px; text-align: center; color: #999; font-size: 12px;">
                <p>Generated by Ridwan Harir's Property Management System</p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
    }, 500);
    
    showToast('Print Ready', 'Opening print dialog');
};

// Initialize location intelligence on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        populateLocationSelectors();
    }, 1000);
});
// ==================== END LOCATION INTELLIGENCE ====================
</script>

<!-- Legacy button hidden -->
<button id="referrals-floating-btn" onclick="toggleReferralsPanel()" style="display: none;">
    <i class="fas fa-users"></i>
    <span id="ref-floating-badge" class="ref-badge" style="display: none;">0</span>
</button>

<!-- Slide-in Panel -->
<div id="referrals-panel">
    <div class="ref-panel-header">
        <div>
            <h2 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-user-friends"></i> DSS Referrals
            </h2>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">Track referrals from social workers & agencies</p>
        </div>
        <button class="ref-panel-close" onclick="toggleReferralsPanel()">×</button>
    </div>
    
    <div class="ref-panel-body">
        <!-- Stats -->
        <div class="ref-stats">
            <div class="ref-stat-card new">
                <div class="ref-stat-value" id="ref-stat-new">0</div>
                <div class="ref-stat-label">New</div>
            </div>
            <div class="ref-stat-card active">
                <div class="ref-stat-value" id="ref-stat-active">0</div>
                <div class="ref-stat-label">Active</div>
            </div>
            <div class="ref-stat-card housed">
                <div class="ref-stat-value" id="ref-stat-housed">0</div>
                <div class="ref-stat-label">Housed</div>
            </div>
        </div>
        
        <!-- Quick Add Form -->
        <div class="ref-quick-form">
            <h3 style="font-size: 14px; margin-bottom: 10px; color: #333;">
                <i class="fas fa-plus-circle"></i> Quick Add
            </h3>
            <form id="ref-quick-form" onsubmit="quickAddReferral(event); return false;">
                <div class="ref-form-group">
                    <input type="text" id="ref-name" placeholder="Client Name *" required>
                </div>
                <div class="ref-form-group">
                    <input type="tel" id="ref-phone" placeholder="Phone Number *" required>
                </div>
                <div class="ref-form-group">
                    <select id="ref-source" required>
                        <option value="">Referral Source *</option>
                        <option value="Social Worker">Social Worker</option>
                        <option value="Local Authority">Local Authority</option>
                        <option value="Housing Charity">Housing Charity</option>
                        <option value="Mental Health">Mental Health Service</option>
                        <option value="Probation">Probation Service</option>
                        <option value="Homeless Charity">Homeless Charity</option>
                        <option value="Self">Self-Referral</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="ref-form-group">
                    <select id="ref-benefit" required>
                        <option value="">Benefit Type *</option>
                        <option value="UC">Universal Credit</option>
                        <option value="HB">Housing Benefit</option>
                        <option value="PIP">PIP</option>
                        <option value="ESA">ESA</option>
                        <option value="LCWRA">LCWRA</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="ref-form-group">
                    <input type="text" id="ref-notes" placeholder="Quick notes (optional)">
                </div>
                <button type="submit" class="ref-btn ref-btn-primary">
                    <i class="fas fa-plus"></i> Add Referral
                </button>
            </form>
        </div>
        
        <!-- Filters -->
        <div class="ref-filters">
            <button class="ref-filter-btn active" onclick="filterReferrals('all')">All</button>
            <button class="ref-filter-btn" onclick="filterReferrals('new')">New</button>
            <button class="ref-filter-btn" onclick="filterReferrals('active')">Active</button>
            <button class="ref-filter-btn" onclick="filterReferrals('housed')">Housed</button>
        </div>
        
        <!-- Export Button -->
        <button onclick="exportAllReferrals()" style="width: 100%; padding: 8px; background: #8E1616; color: white; border: none; border-radius: 4px; font-size: 12px; margin-bottom: 15px; cursor: pointer;">
            <i class="fas fa-download"></i> Export All
        </button>
        
        <!-- Referral List -->
        <div id="ref-list"></div>
    </div>
</div>

<script>
// Referral System
(function() {
    // Make referrals global so database can update it!
    window.referrals = [];
    let referrals = window.referrals; // Local alias
    let refFilter = 'all';
    let panelOpen = false;
    
    // Load referrals
    function loadReferrals() {
        const stored = localStorage.getItem('dssReferrals');
        if (stored) {
            window.referrals = JSON.parse(stored);
            referrals = window.referrals; // Update local alias
            updateRefStats();
            renderReferrals();
        }
    }
    
    // Save referrals
    function saveReferrals() {
        localStorage.setItem('dssReferrals', JSON.stringify(referrals));
        updateRefStats();
    }
    
    // Toggle panel
    window.toggleReferralsPanel = function() {
        panelOpen = !panelOpen;
        const panel = document.getElementById('referrals-panel');
        if (panelOpen) {
            panel.classList.add('open');
        } else {
            panel.classList.remove('open');
        }
    };
    
    // Quick add referral
    window.quickAddReferral = function(event) {
        event.preventDefault();
        
        const newRef = {
            id: Date.now(),
            name: document.getElementById('ref-name').value.trim(),
            phone: document.getElementById('ref-phone').value.trim(),
            source: document.getElementById('ref-source').value,
            benefit: document.getElementById('ref-benefit').value,
            notes: document.getElementById('ref-notes').value.trim(),
            status: 'new',
            created: new Date().toISOString(),
            history: [`${new Date().toLocaleDateString('en-GB')} - Referral received`]
        };
        
        referrals.unshift(newRef);
        saveReferrals();
        document.getElementById('ref-quick-form').reset();
        renderReferrals();
        showToast('Added!', `${newRef.name} added to referrals`);
    };
    
    // Update stats
    function updateRefStats() {
        const newCount = referrals.filter(r => r.status === 'new').length;
        const activeCount = referrals.filter(r => r.status === 'contacted' || r.status === 'viewing').length;
        const housedCount = referrals.filter(r => r.status === 'housed').length;
        
        document.getElementById('ref-stat-new').textContent = newCount;
        document.getElementById('ref-stat-active').textContent = activeCount;
        document.getElementById('ref-stat-housed').textContent = housedCount;
        
        const badge = document.getElementById('ref-floating-badge');
        badge.textContent = newCount;
        badge.style.display = newCount > 0 ? 'flex' : 'none';
    }
    
    // Filter referrals
    window.filterReferrals = function(filter) {
        refFilter = filter;
        document.querySelectorAll('.ref-filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderReferrals();
    };
    
    // Render referrals
    function renderReferrals() {
        const container = document.getElementById('ref-list');
        let filtered = referrals;
        
        if (refFilter === 'new') {
            filtered = referrals.filter(r => r.status === 'new');
        } else if (refFilter === 'active') {
            filtered = referrals.filter(r => r.status === 'contacted' || r.status === 'viewing');
        } else if (refFilter === 'housed') {
            filtered = referrals.filter(r => r.status === 'housed');
        }
        
        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><i class="fas fa-inbox" style="font-size: 36px; opacity: 0.3; margin-bottom: 10px;"></i><p style="font-size: 13px;">No referrals</p></div>';
            return;
        }
        
        container.innerHTML = '';
        filtered.forEach(ref => {
            const card = document.createElement('div');
            card.className = 'ref-card';
            
            const statusColors = {
                new: '#8E1616',
                contacted: '#f39c12',
                viewing: '#9b59b6',
                housed: '#2ecc71',
                rejected: '#e74c3c'
            };
            card.style.borderLeftColor = statusColors[ref.status] || 'var(--primary-orange)';
            
            const date = new Date(ref.created).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            
            card.innerHTML = `
                <div class="ref-card-header">
                    <div class="ref-card-name">${ref.name}</div>
                    <span class="ref-status-badge" style="background: ${statusColors[ref.status]}20; color: ${statusColors[ref.status]};">
                        ${ref.status}
                    </span>
                </div>
                <div class="ref-card-info">
                    <div>📞 ${ref.phone}</div>
                    <div>📋 ${ref.source} • ${ref.benefit}</div>
                    <div>📅 ${date}</div>
                    ${ref.notes ? `<div style="margin-top: 4px; padding: 6px; background: #f8f9fa; border-radius: 4px;">💬 ${ref.notes}</div>` : ''}
                </div>
                <div class="ref-card-actions">
                    ${ref.status === 'new' ? `<button class="ref-card-btn" style="background: #f39c12;" onclick="updateRefStatus(${ref.id}, 'contacted')">📞 Contact</button>` : ''}
                    ${ref.status === 'contacted' ? `<button class="ref-card-btn" style="background: #9b59b6;" onclick="updateRefStatus(${ref.id}, 'viewing')">📅 Viewing</button>` : ''}
                    ${ref.status !== 'housed' && ref.status !== 'rejected' ? `<button class="ref-card-btn" style="background: #2ecc71;" onclick="updateRefStatus(${ref.id}, 'housed')">✅ Housed</button>` : ''}
                    <button class="ref-card-btn" style="background: var(--primary-orange);" onclick="copyRefDetails(${ref.id})">📋</button>
                    <button class="ref-card-btn" style="background: #e74c3c; flex: 0 0 auto; padding: 5px 8px;" onclick="deleteRef(${ref.id})">🗑️</button>
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    // Update status
    window.updateRefStatus = function(id, newStatus) {
        const ref = referrals.find(r => r.id === id);
        if (!ref) return;
        
        ref.status = newStatus;
        ref.history.push(`${new Date().toLocaleDateString('en-GB')} - Status: ${newStatus}`);
        
        saveReferrals();
        renderReferrals();
        
        const messages = {
            contacted: 'Marked as contacted',
            viewing: 'Viewing scheduled',
            housed: '🎉 Client housed!',
            rejected: 'Marked as declined'
        };
        showToast('Updated', messages[newStatus]);
    };
    
    // Copy details
    window.copyRefDetails = function(id) {
        const ref = referrals.find(r => r.id === id);
        if (!ref) return;
        
        const text = `DSS REFERRAL

Name: ${ref.name}
Phone: ${ref.phone}
Source: ${ref.source}
Benefit: ${ref.benefit}
Status: ${ref.status.toUpperCase()}
Received: ${new Date(ref.created).toLocaleDateString('en-GB')}
${ref.notes ? `Notes: ${ref.notes}\n` : ''}
History:
${ref.history.join('\n')}`;
        
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied!', 'Details copied to clipboard');
        });
    };
    
    // Delete referral
    window.deleteRef = function(id) {
        const ref = referrals.find(r => r.id === id);
        if (!ref) return;
        
        if (confirm(`Delete referral for ${ref.name}?`)) {
            referrals = referrals.filter(r => r.id !== id);
            saveReferrals();
            renderReferrals();
            showToast('Deleted', 'Referral removed');
        }
    };
    
    // Export all
    window.exportAllReferrals = function() {
        if (referrals.length === 0) {
            showToast('No Data', 'No referrals to export', true);
            return;
        }
        
        let text = `DSS REFERRALS EXPORT
${'='.repeat(60)}
Generated: ${new Date().toLocaleString('en-GB')}
Total: ${referrals.length}

`;
        
        const groups = {
            new: referrals.filter(r => r.status === 'new'),
            contacted: referrals.filter(r => r.status === 'contacted'),
            viewing: referrals.filter(r => r.status === 'viewing'),
            housed: referrals.filter(r => r.status === 'housed'),
            rejected: referrals.filter(r => r.status === 'rejected')
        };
        
        Object.keys(groups).forEach(status => {
            const items = groups[status];
            if (items.length === 0) return;
            
            text += `\n${status.toUpperCase()} (${items.length})\n${'-'.repeat(60)}\n`;
            items.forEach((ref, i) => {
                text += `\n${i + 1}. ${ref.name}\n`;
                text += `   Phone: ${ref.phone}\n`;
                text += `   Source: ${ref.source} | Benefit: ${ref.benefit}\n`;
                text += `   Date: ${new Date(ref.created).toLocaleDateString('en-GB')}\n`;
                if (ref.notes) text += `   Notes: ${ref.notes}\n`;
            });
        });
        
        navigator.clipboard.writeText(text).then(() => {
            showToast('Exported!', `${referrals.length} referrals copied`);
        });
    };
    
    // Expose loadReferrals globally so database load can call it
    window.loadReferrals = loadReferrals;
    
    // Initialize
    loadReferrals();
})();
</script>



<!-- OLD CONTROLS REMOVED - NOW USING NEW FLOATING MENU -->

<!-- Edit Property Modal -->
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: linear-gradient(135deg, var(--medium-bg) 0%, var(--card-bg) 100%); border-radius: 16px; padding: 0; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; border: 2px solid var(--primary-red);">
        <div style="padding: 25px; background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red) 100%); border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: white; font-size: 22px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-edit"></i>
                <span id="edit-modal-title">Edit Property</span>
            </h2>
            <button onclick="closeEditModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; transition: all 0.3s;">
                ×
            </button>
        </div>
        <form id="edit-property-form" onsubmit="savePropertyEdit(event)" style="padding: 25px; color: white;">
            <input type="hidden" id="edit-property-id">
            
            <!-- Property Status -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 15px; color: var(--primary-tan);">
                    <i class="fas fa-toggle-on"></i> Property Status
                </label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="property-status" value="available" id="status-available" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;">✅ Available</span>
                    </label>
                    <label style="flex: 1; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="property-status" value="taken" id="status-taken" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600;">🔴 Taken</span>
                    </label>
                </div>
            </div>
            
            <!-- Client Assignment (only shown when taken) -->
            <div id="client-assignment-section" style="display: none; margin-bottom: 20px; padding: 15px; background: var(--dark-bg); border-radius: 8px; border-left: 4px solid var(--warning-yellow);">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 14px; color: var(--warning-yellow);">
                    <i class="fas fa-user"></i> Assigned To (Optional)
                </label>
                <input type="text" id="edit-client-name" placeholder="Enter client name..." style="width: 100%; padding: 12px; background: var(--medium-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px;">
                <p style="font-size: 12px; color: var(--text-grey); margin-top: 8px; margin-bottom: 0;">Track which client this property is assigned to</p>
            </div>
            
            <!-- Property Details -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                    <i class="fas fa-home"></i> Property Name
                </label>
                <input type="text" id="edit-property-name" required style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                    <i class="fas fa-map-marker-alt"></i> Address
                </label>
                <input type="text" id="edit-property-address" required style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                        <i class="fas fa-city"></i> Borough
                    </label>
                    <input type="text" id="edit-property-borough" required style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                        <i class="fas fa-pound-sign"></i> Monthly Rent
                    </label>
                    <input type="number" id="edit-property-rent" required style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px;">
                </div>
            </div>
            
            <!-- Date Added (Read-only) -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                    <i class="fas fa-calendar-plus"></i> Date Added
                </label>
                <input type="date" id="edit-property-date" style="width: 100%; padding: 12px; background: white; border: 2px solid var(--border-grey); border-radius: 8px; font-size: 14px;">
                <p style="font-size: 12px; color: var(--text-grey); margin-top: 6px; margin-bottom: 0;">Change this to update urgency indicators</p>
            </div>
            
            <!-- Notes -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 700;">
                    <i class="fas fa-comment"></i> Notes (Optional)
                </label>
                <textarea id="edit-property-notes" rows="3" placeholder="Any additional notes..." style="width: 100%; padding: 12px; background: var(--dark-bg); border: 2px solid var(--border-grey); border-radius: 8px; color: white; font-size: 14px; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="closeEditModal()" style="flex: 1; padding: 14px; background: var(--text-grey); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    Cancel
                </button>
                <button type="submit" style="flex: 2; padding: 14px; background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red) 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Show/hide client assignment based on status
document.querySelectorAll('input[name="property-status"]').forEach(radio => {
    radio?.addEventListener('change', function() {
        const clientSection = document.getElementById('client-assignment-section');
        if (clientSection) {
            clientSection.style.display = this.value === 'taken' ? 'block' : 'none';
        }
    });
});

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('edit-property-form').reset();
}

function savePropertyEdit(event) {
    event.preventDefault();
    
    const id = parseInt(document.getElementById('edit-property-id').value);
    const status = document.querySelector('input[name="property-status"]:checked').value;
    const clientName = document.getElementById('edit-client-name').value.trim();
    const name = document.getElementById('edit-property-name').value.trim();
    const address = document.getElementById('edit-property-address').value.trim();
    const borough = document.getElementById('edit-property-borough').value.trim();
    const rent = parseFloat(document.getElementById('edit-property-rent').value);
    const notes = document.getElementById('edit-property-notes').value.trim();
    
    // Find and update the property
    const propIndex = properties.findIndex(p => p.id === id);
    if (propIndex !== -1) {
        properties[propIndex].name = name;
        properties[propIndex].address = address;
        properties[propIndex].borough = borough;
        properties[propIndex].rent = rent;
        if (notes) properties[propIndex].notes = notes;
        if (clientName) properties[propIndex].assignedTo = clientName;
    }
    
    // Update taken status
    if (status === 'taken') {
        takenProperties.add(id);
    } else {
        takenProperties.delete(id);
    }
    
    // Save to localStorage
    if (typeof savePropertiesToStorage === 'function') {
        savePropertiesToStorage();
    }
    
    // Update UI
    if (typeof renderPropertyList === 'function') {
        renderPropertyList();
    }
    if (typeof updateMarkers === 'function') {
        updateMarkers();
    }
    
    // Show success message
    if (typeof showToast === 'function') {
        showToast('Success', 'Property updated successfully!', false);
    }
    
    closeEditModal();
}

// Close modal when clicking outside
document.getElementById('edit-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

// ==================== PIPELINE TRACKER ====================
let pipelineData = [];

// Load pipeline data
function loadPipelineData() {
    const stored = localStorage.getItem('pipelineData');
    if (stored) return JSON.parse(stored);
    
    // Default initial data from Nov 5-14, 2025 - 40 Real viewings
    return [
    {"date": "2025-11-05", "time": "12:30", "property": "70 Salisbury Road, HA1 1NZ", "visitor": "Abdullah", "phone": "07405964257", "type": "In-Person", "status": "Signed Up", "notes": ""},
    {"date": "2025-11-05", "time": "12:45", "property": "70 Salisbury Road, HA1 1NZ", "visitor": "Stephen", "phone": "07575376472", "type": "In-Person", "status": "Signed Up", "notes": ""},
    {"date": "2025-11-05", "time": "13:00", "property": "70 Salisbury Road, HA1 1NZ", "visitor": "Zackeris", "phone": "07932342881", "type": "In-Person", "status": "Ineligible", "notes": "Under 35 - no exemption"},
    {"date": "2025-11-05", "time": "15:30", "property": "13 Foxholt Gardens, NW10 0TA", "visitor": "Mark Keys", "phone": "07812527839", "type": "In-Person", "status": "No Show", "notes": ""},
    {"date": "2025-11-06", "time": "13:30", "property": "75 Howson Road, SE4 2AT", "visitor": "Stacey", "phone": "07428206004", "type": "In-Person", "status": "No Show", "notes": ""},
    {"date": "2025-11-06", "time": "13:00", "property": "38 Parkfield Way, BR2 8AF", "visitor": "Daniel", "phone": "07307562144", "type": "In-Person", "status": "No Show", "notes": ""},
    {"date": "2025-11-06", "time": "13:30", "property": "40 Forbes Close, EN6 5NG", "visitor": "Glenn", "phone": "+44 7404 585616", "type": "In-Person", "status": "Declined", "notes": "Did not like it"},
    {"date": "2025-11-06", "time": "13:45", "property": "44 Forbes Close, EN6 5NG", "visitor": "Zahra", "phone": "+44 7784 709617", "type": "In-Person", "status": "Declined", "notes": "Did not like it"},
    {"date": "2025-11-06", "time": "13:30", "property": "75 Howson Road, SE4 2AT", "visitor": "Beverley", "phone": "07393616852", "type": "In-Person", "status": "Cancelled", "notes": ""},
    {"date": "2025-11-06", "time": "15:00", "property": "13 Foxholt Gardens, NW10 0TA", "visitor": "Abdi", "phone": "07914100078", "type": "In-Person", "status": "No Show", "notes": ""},
    {"date": "2025-11-06", "time": "11:30", "property": "4 Cumberland Rd, W3 6EY", "visitor": "Ahmed", "phone": "07863832085", "type": "In-Person", "status": "Cancelled", "notes": "We missed the viewing"},
    {"date": "2025-11-06", "time": "14:00", "property": "44 Forbes Close, EN6 5NG", "visitor": "Kyai", "phone": "07777121480", "type": "In-Person", "status": "Signed Up", "notes": ""},
    {"date": "2025-11-07", "time": "15:00", "property": "13 Foxholt, NW10 0TA and 29 Bridge Road NW10 9DG", "visitor": "Adrian Williams", "phone": "+44 7388 098981", "type": "In-Person", "status": "Pending", "notes": "Will sign-up on Monday. Email: Wadrian220@hotmail.com"},
    {"date": "2025-11-07", "time": "11:30", "property": "29 Bridge Road NW10 9DG", "visitor": "Joshua", "phone": "07884358801", "type": "In-Person", "status": "Cancelled", "notes": "Rescheduled for Monday"},
    {"date": "2025-11-07", "time": "14:30", "property": "13 Foxholt, NW10 0TA and 29 Bridge Road, NW10 9DG", "visitor": "Ahmed", "phone": "+44 7898 649759", "type": "In-Person", "status": "Cancelled", "notes": "Wasn't contacted for the sign up"},
    {"date": "2025-11-07", "time": "12:30", "property": "70 Salisbury Road HA1 1NZ", "visitor": "José Ignacio Aguilar Cano", "phone": "07459511586", "type": "In-Person", "status": "Declined", "notes": "Didn't like first one and was stood up for Cumberland viewing"},
    {"date": "2025-11-07", "time": "13:00", "property": "2a Corkran Rd, KT6 6PN", "visitor": "Martin Ellis", "phone": "07550011872", "type": "In-Person", "status": "Signed Up", "notes": "Alt phone: 07712599272"},
    {"date": "2025-11-07", "time": "11:30", "property": "4 Cumberland Road, LONDON, W7 2EA", "visitor": "Ahmed", "phone": "+44 7572 428307", "type": "In-Person", "status": "No Show", "notes": "Was stood up for the Cumberland viewing"},
    {"date": "2025-11-10", "time": "13:30", "property": "53 Harley Crescent, HA1 4XH", "visitor": "Soorya", "phone": "07453541135", "type": "In-Person", "status": "Declined", "notes": "Didn't want it"},
    {"date": "2025-11-10", "time": "14:00", "property": "53 Harley Crescent, HA1 4XH", "visitor": "Josephine", "phone": "07782761542", "type": "In-Person", "status": "Pending", "notes": "Will sign up tomorrow"},
    {"date": "2025-11-10", "time": "11:30", "property": "29 Bridge Road NW10 9DG", "visitor": "Joshua", "phone": "07884358801", "type": "In-Person", "status": "Declined", "notes": "Didn't want anything shared"},
    {"date": "2025-11-10", "time": "13:45", "property": "40 Forbes Close, EN6 5NG", "visitor": "David Lewis", "phone": "07301322576", "type": "In-Person", "status": "No Show", "notes": "Failed to turn up"},
    {"date": "2025-11-11", "time": "15:00", "property": "21 Mansell Road W3 7QH", "visitor": "Phillip Champion", "phone": "07923557242", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-11", "time": "14:30", "property": "21 Mansell Road W3 7QH", "visitor": "Tomasz", "phone": "07587777288", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-11", "time": "14:00", "property": "21 Mansell Road W3 7QH", "visitor": "Jack Lee", "phone": "07491045821", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-11", "time": "16:45", "property": "24 St. Francis Close EN6 2RH", "visitor": "Kobina", "phone": "07463729087", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-11", "time": "14:45", "property": "4 Cumberland Road, W7 2EA", "visitor": "Fatima", "phone": "07383497409", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-12", "time": "11:30", "property": "85 Clarence Road, Grays, RM17 6RA", "visitor": "Dylan Matchett", "phone": "+44 7984 354578", "type": "In-Person", "status": "Signed Up", "notes": ""},
    {"date": "2025-11-12", "time": "13:00", "property": "56 Ardossan Gardens, KT4 7AX", "visitor": "martin", "phone": "+44 7828 619311", "type": "In-Person", "status": "Declined", "notes": "Wanted to sign up but too expensive"},
    {"date": "2025-11-12", "time": "15:00", "property": "29 Bridge Road, NW10 9DG", "visitor": "Abdullahi", "phone": "07761982873", "type": "In-Person", "status": "Cancelled", "notes": ""},
    {"date": "2025-11-13", "time": "16:00", "property": "2a Corkran Rd, KT6 6PN", "visitor": "Alfred Osei Kwaku", "phone": "+44 7494 433794", "type": "In-Person", "status": "Declined", "notes": ""},
    {"date": "2025-11-13", "time": "12:45", "property": "53 Harley Crescent, HA1 4XH", "visitor": "Maria Josefina Pereira", "phone": "07378611149", "type": "In-Person", "status": "No Show", "notes": ""},
    {"date": "2025-11-13", "time": "13:00", "property": "29 Bridge Road, NW10 9DG", "visitor": "Leon", "phone": "07561432231", "type": "Virtual", "status": "Cancelled", "notes": "Agent missed the viewing"},
    {"date": "2025-11-13", "time": "13:30", "property": "53 Harley Crescent, HA1 4XH", "visitor": "Yasheena Louis", "phone": "+44 7908 076664", "type": "In-Person", "status": "Declined", "notes": ""},
    {"date": "2025-11-13", "time": "14:00", "property": "2 Dawlish Avenue, UB6 8AF", "visitor": "Leon", "phone": "07561432231", "type": "Virtual", "status": "Cancelled", "notes": "Agent missed the viewing"},
    {"date": "2025-11-13", "time": "11:45", "property": "536 Streatham High Road, SW16 3QF", "visitor": "Daniel Clark", "phone": "+44 7307 562144", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-14", "time": "12:00", "property": "262 Eastcote Lane, HA2 9AQ", "visitor": "Roman", "phone": "07424109276", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-14", "time": "15:00", "property": "262 Eastcote Lane, HA2 9AQ", "visitor": "Yogesh Kerai", "phone": "07873706312", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-14", "time": "15:30", "property": "262 Eastcote Lane, HA2 9AQ", "visitor": "Roger Lee", "phone": "07463292493", "type": "In-Person", "status": "Pending", "notes": ""},
    {"date": "2025-11-14", "time": "15:45", "property": "262 Eastcote Lane, HA2 9AQ", "visitor": "Suren Kugathasan", "phone": "07869503652", "type": "In-Person", "status": "Pending", "notes": ""}
];
}

// Save pipeline data
function savePipelineData() {
    localStorage.setItem('pipelineData', JSON.stringify(pipelineData));
    updatePipelineMetrics();
}

// Render pipeline table
window.renderPipelineTable = function() {
    pipelineData = loadPipelineData();
    const tbody = document.getElementById('pipeline-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    pipelineData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e9ecef';
        tr.innerHTML = `
            <td style="padding: 12px;"><input type="date" value="${row.date || ''}" onchange="updatePipelineRow(${index}, 'date', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="time" value="${row.time || ''}" onchange="updatePipelineRow(${index}, 'time', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="text" value="${row.property || ''}" onchange="updatePipelineRow(${index}, 'property', this.value)" placeholder="Property address" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="text" value="${row.visitor || ''}" onchange="updatePipelineRow(${index}, 'visitor', this.value)" placeholder="Name" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="tel" value="${row.phone || ''}" onchange="updatePipelineRow(${index}, 'phone', this.value)" placeholder="Phone" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;">
                <select onchange="updatePipelineRow(${index}, 'type', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="In-Person" ${row.type === 'In-Person' ? 'selected' : ''}>In-Person</option>
                    <option value="Virtual" ${row.type === 'Virtual' ? 'selected' : ''}>Virtual</option>
                    <option value="Phone" ${row.type === 'Phone' ? 'selected' : ''}>Phone</option>
                </select>
            </td>
            <td style="padding: 12px;">
                <select onchange="updatePipelineRow(${index}, 'status', this.value)" style="width: 100%; padding: 6px; border: 2px solid; border-radius: 4px; font-weight: 600; ${getStatusStyle(row.status)}">
                    <option value="Pending" ${row.status === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Signed Up" ${row.status === 'Signed Up' ? 'selected' : ''}>Signed Up</option>
                    <option value="No Show" ${row.status === 'No Show' ? 'selected' : ''}>No Show</option>
                    <option value="Cancelled" ${row.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                    <option value="Declined" ${row.status === 'Declined' ? 'selected' : ''}>Declined</option>
                    <option value="Ineligible" ${row.status === 'Ineligible' ? 'selected' : ''}>Ineligible</option>
                </select>
            </td>
            <td style="padding: 12px;"><textarea onchange="updatePipelineRow(${index}, 'notes', this.value)" placeholder="Notes" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; min-height: 35px; resize: vertical;">${row.notes || ''}</textarea></td>
            <td style="padding: 12px; text-align: center;">
                <button onclick="deletePipelineRow(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
};

// Get status styling
function getStatusStyle(status) {
    const styles = {
        'Signed Up': 'background: #d4edda; color: #155724; border-color: #c3e6cb;',
        'No Show': 'background: #f8d7da; color: #721c24; border-color: #f5c6cb;',
        'Cancelled': 'background: #fff3cd; color: #856404; border-color: #ffeaa7;',
        'Declined': 'background: #e2e3e5; color: #383d41; border-color: #d6d8db;',
        'Ineligible': 'background: #e2e3e5; color: #383d41; border-color: #d6d8db;',
        'Pending': 'background: #cce5ff; color: #004085; border-color: #b8daff;'
    };
    return styles[status] || styles['Pending'];
}

// Update pipeline row
window.updatePipelineRow = function(index, field, value) {
    if (!pipelineData[index]) return;
    pipelineData[index][field] = value;
    savePipelineData();
    renderPipelineTable();
};

// Add new pipeline row
window.addPipelineRow = function() {
    pipelineData.unshift({
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().split(' ')[0].slice(0,5),
        property: '',
        visitor: '',
        phone: '',
        type: 'In-Person',
        status: 'Pending',
        notes: ''
    });
    savePipelineData();
    renderPipelineTable();
};

// Delete pipeline row
window.deletePipelineRow = function(index) {
    if (confirm('Delete this viewing entry?')) {
        pipelineData.splice(index, 1);
        savePipelineData();
        renderPipelineTable();
    }
};

// Update metrics
window.updatePipelineMetrics = function() {
    const data = loadPipelineData();
    const total = data.length;
    const signedUp = data.filter(r => r.status === 'Signed Up').length;
    const noShows = data.filter(r => r.status === 'No Show').length;
    const conversion = total > 0 ? Math.round((signedUp / total) * 100) : 0;
    
    document.getElementById('pipeline-total').textContent = total;
    document.getElementById('pipeline-signed').textContent = signedUp;
    document.getElementById('pipeline-noshow').textContent = noShows;
    document.getElementById('pipeline-conversion').textContent = conversion + '%';
};

// Export to CSV
window.exportPipelineCSV = function() {
    const data = loadPipelineData();
    if (data.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['Date', 'Time', 'Property', 'Visitor', 'Phone', 'Type', 'Status', 'Notes'];
    const rows = data.map(r => [
        r.date || '',
        r.time || '',
        r.property || '',
        r.visitor || '',
        r.phone || '',
        r.type || '',
        r.status || '',
        r.notes || ''
    ]);
    
    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(cell => '"' + (cell || '').replace(/"/g, '""') + '"').join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'viewing-pipeline-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
};

// Toggle right panel expansion
window.toggleRightPanelExpand = function() {
    document.body.classList.toggle('right-expanded');
    const expandText = document.getElementById('expand-text');
    if (document.body.classList.contains('right-expanded')) {
        expandText.textContent = 'Collapse';
    } else {
        expandText.textContent = 'Expand';
    }
};

// Toggle fullscreen mode for Client Management
window.toggleFullscreen = function() {
    document.body.classList.toggle('fullscreen-mode');
    const btn = document.getElementById('fullscreen-btn');
    if (document.body.classList.contains('fullscreen-mode')) {
        btn.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
    } else {
        btn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
    }
};

// Toggle fullscreen mode for Dashboard Overview (Left Panel)
window.toggleLeftFullscreen = function() {
    document.body.classList.toggle('left-fullscreen-mode');
    const btn = document.getElementById('left-fullscreen-btn');
    if (document.body.classList.contains('left-fullscreen-mode')) {
        btn.innerHTML = '<i class="fas fa-compress"></i> Exit';
    } else {
        btn.innerHTML = '<i class="fas fa-expand"></i> Full';
    }
};

// Initialize pipeline on load
pipelineData = loadPipelineData();
// ==================== END PIPELINE TRACKER ====================

// ==================== REFERRALS TRACKER ====================
let referralsData = [];

// Load referrals data
function loadReferralsData() {
    const stored = localStorage.getItem('referralsData');
    if (stored) return JSON.parse(stored);
    
    // Default referrals data from Nov 5-12, 2025 viewings - YOUR VALUABLE DATA!
    return [{"name":"Abdullah","phone":"07405964257","propertiesViewed":"70 Salisbury Road, HA1 1NZ","interestedIn":"70 Salisbury Road, HA1 1NZ","lastContact":"2025-11-05","status":"Converted","notes":""},{"name":"Stephen","phone":"07575376472","propertiesViewed":"70 Salisbury Road, HA1 1NZ","interestedIn":"70 Salisbury Road, HA1 1NZ","lastContact":"2025-11-05","status":"Converted","notes":""},{"name":"Zackeris","phone":"07932342881","propertiesViewed":"70 Salisbury Road, HA1 1NZ","interestedIn":"70 Salisbury Road, HA1 1NZ","lastContact":"2025-11-05","status":"Not Interested","notes":"Under 35 - no exemption"},{"name":"Mark Keys","phone":"07812527839","propertiesViewed":"13 Foxholt Gardens, NW10 0TA","interestedIn":"13 Foxholt Gardens, NW10 0TA","lastContact":"2025-11-05","status":"Cold","notes":""},{"name":"Stacey","phone":"07428206004","propertiesViewed":"75 Howson Road, SE4 2AT","interestedIn":"75 Howson Road, SE4 2AT","lastContact":"2025-11-06","status":"Cold","notes":""},{"name":"Daniel","phone":"07307562144","propertiesViewed":"38 Parkfield Way, BR2 8AF","interestedIn":"38 Parkfield Way, BR2 8AF","lastContact":"2025-11-06","status":"Cold","notes":""},{"name":"Glenn","phone":"+44 7404 585616","propertiesViewed":"40 Forbes Close, EN6 5NG","interestedIn":"40 Forbes Close, EN6 5NG","lastContact":"2025-11-06","status":"Not Interested","notes":"Did not like it"},{"name":"Zahra","phone":"+44 7784 709617","propertiesViewed":"44 Forbes Close, EN6 5NG","interestedIn":"44 Forbes Close, EN6 5NG","lastContact":"2025-11-06","status":"Not Interested","notes":"Did not like it"},{"name":"Beverley","phone":"07393616852","propertiesViewed":"75 Howson Road, SE4 2AT","interestedIn":"75 Howson Road, SE4 2AT","lastContact":"2025-11-06","status":"Active","notes":""},{"name":"Abdi","phone":"07914100078","propertiesViewed":"13 Foxholt Gardens, NW10 0TA","interestedIn":"13 Foxholt Gardens, NW10 0TA","lastContact":"2025-11-06","status":"Cold","notes":""},{"name":"Ahmed","phone":"07863832085","propertiesViewed":"4 Cumberland Rd, W3 6EY","interestedIn":"4 Cumberland Rd, W3 6EY","lastContact":"2025-11-06","status":"Active","notes":"We missed the viewing"},{"name":"Kyai","phone":"07777121480","propertiesViewed":"44 Forbes Close, EN6 5NG","interestedIn":"44 Forbes Close, EN6 5NG","lastContact":"2025-11-06","status":"Converted","notes":""},{"name":"Adrian Williams","phone":"+44 7388 098981","propertiesViewed":"13 Foxholt, NW10 0TA and 29 Bridge Road NW10 9DG","interestedIn":"13 Foxholt, NW10 0TA and 29 Bridge Road NW10 9DG","lastContact":"2025-11-07","status":"Active","notes":"Will sign-up on Monday. Email: Wadrian220@hotmail.com"},{"name":"Joshua","phone":"07884358801","propertiesViewed":"29 Bridge Road NW10 9DG","interestedIn":"29 Bridge Road NW10 9DG","lastContact":"2025-11-07","status":"Active","notes":"Rescheduled for Monday"},{"name":"Ahmed","phone":"+44 7898 649759","propertiesViewed":"13 Foxholt, NW10 0TA and 29 Bridge Road, NW10 9DG","interestedIn":"13 Foxholt, NW10 0TA and 29 Bridge Road, NW10 9DG","lastContact":"2025-11-07","status":"Active","notes":"Wasn't contacted for the sign up"},{"name":"José Ignacio Aguilar Cano","phone":"07459511586","propertiesViewed":"70 Salisbury Road HA1 1NZ","interestedIn":"70 Salisbury Road HA1 1NZ","lastContact":"2025-11-07","status":"Not Interested","notes":"Didn't like first one and was stood up for Cumberland viewing"},{"name":"Martin Ellis","phone":"07550011872","propertiesViewed":"2a Corkran Rd, KT6 6PN","interestedIn":"2a Corkran Rd, KT6 6PN","lastContact":"2025-11-07","status":"Converted","notes":"Alt phone: 07712599272"},{"name":"Ahmed","phone":"+44 7572 428307","propertiesViewed":"4 Cumberland Road, LONDON, W7 2EA","interestedIn":"4 Cumberland Road, LONDON, W7 2EA","lastContact":"2025-11-07","status":"Cold","notes":"Was stood up for the Cumberland viewing"},{"name":"Soorya","phone":"07453541135","propertiesViewed":"53 Harley Crescent, HA1 4XH","interestedIn":"53 Harley Crescent, HA1 4XH","lastContact":"2025-11-10","status":"Not Interested","notes":"Didn't want it"},{"name":"Josephine","phone":"07782761542","propertiesViewed":"53 Harley Crescent, HA1 4XH","interestedIn":"53 Harley Crescent, HA1 4XH","lastContact":"2025-11-10","status":"Active","notes":"Will sign up tomorrow"},{"name":"David Lewis","phone":"07301322576","propertiesViewed":"40 Forbes Close, EN6 5NG","interestedIn":"40 Forbes Close, EN6 5NG","lastContact":"2025-11-10","status":"Cold","notes":"Failed to turn up"},{"name":"Phillip Champion","phone":"07923557242","propertiesViewed":"21 Mansell Road W3 7QH","interestedIn":"21 Mansell Road W3 7QH","lastContact":"2025-11-11","status":"Active","notes":""},{"name":"Tomasz","phone":"07587777288","propertiesViewed":"21 Mansell Road W3 7QH","interestedIn":"21 Mansell Road W3 7QH","lastContact":"2025-11-11","status":"Active","notes":""},{"name":"Jack Lee","phone":"07491045821","propertiesViewed":"21 Mansell Road W3 7QH","interestedIn":"21 Mansell Road W3 7QH","lastContact":"2025-11-11","status":"Active","notes":""},{"name":"Kobina","phone":"07463729087","propertiesViewed":"24 St. Francis Close EN6 2RH","interestedIn":"24 St. Francis Close EN6 2RH","lastContact":"2025-11-11","status":"Active","notes":""},{"name":"Fatima","phone":"07383497409","propertiesViewed":"4 Cumberland Road, W7 2EA","interestedIn":"4 Cumberland Road, W7 2EA","lastContact":"2025-11-11","status":"Active","notes":""},{"name":"Dylan Matchett","phone":"+44 7984 354578","propertiesViewed":"85 Clarence Road, Grays, RM17 6RA","interestedIn":"85 Clarence Road, Grays, RM17 6RA","lastContact":"2025-11-12","status":"Converted","notes":""},{"name":"martin","phone":"+44 7828 619311","propertiesViewed":"56 Ardossan Gardens, KT4 7AX","interestedIn":"56 Ardossan Gardens, KT4 7AX","lastContact":"2025-11-12","status":"Not Interested","notes":"Wanted to sign up but too expensive"},{"name":"Abdullahi","phone":"07761982873","propertiesViewed":"29 Bridge Road, NW10 9DG","interestedIn":"29 Bridge Road, NW10 9DG","lastContact":"2025-11-12","status":"Active","notes":""}];
}

// Save referrals data
function saveReferralsData() {
    localStorage.setItem('referralsData', JSON.stringify(referralsData));
    updateReferralsMetrics();
}

// Get status styling for referrals
function getReferralStatusStyle(status) {
    const styles = {
        'Converted': 'background: #d4edda; color: #155724; border-color: #c3e6cb;',
        'Active': 'background: #cce5ff; color: #004085; border-color: #b8daff;',
        'Cold': 'background: #e2e3e5; color: #383d41; border-color: #d6d8db;',
        'Not Interested': 'background: #f8d7da; color: #721c24; border-color: #f5c6cb;'
    };
    return styles[status] || styles['Active'];
}

// Render referrals table
window.renderReferralsTable = function() {
    referralsData = loadReferralsData();
    const tbody = document.getElementById('referrals-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    referralsData.forEach((ref, index) => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e9ecef';
        tr.innerHTML = `
            <td style="padding: 12px;"><input type="text" value="${ref.name || ''}" onchange="updateReferralRow(${index}, 'name', this.value)" placeholder="Client name" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="tel" value="${ref.phone || ''}" onchange="updateReferralRow(${index}, 'phone', this.value)" placeholder="Phone" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;"><input type="text" value="${ref.propertiesViewed || ''}" onchange="updateReferralRow(${index}, 'propertiesViewed', this.value)" placeholder="Properties they viewed" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;"></td>
            <td style="padding: 12px;"><input type="text" value="${ref.interestedIn || ''}" onchange="updateReferralRow(${index}, 'interestedIn', this.value)" placeholder="Most interested" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;"></td>
            <td style="padding: 12px;"><input type="date" value="${ref.lastContact || ''}" onchange="updateReferralRow(${index}, 'lastContact', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"></td>
            <td style="padding: 12px;">
                <select onchange="updateReferralRow(${index}, 'status', this.value)" style="width: 100%; padding: 6px; border: 2px solid; border-radius: 4px; font-weight: 600; ${getReferralStatusStyle(ref.status)}">
                    <option value="Active" ${ref.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Converted" ${ref.status === 'Converted' ? 'selected' : ''}>Converted</option>
                    <option value="Cold" ${ref.status === 'Cold' ? 'selected' : ''}>Cold</option>
                    <option value="Not Interested" ${ref.status === 'Not Interested' ? 'selected' : ''}>Not Interested</option>
                </select>
            </td>
            <td style="padding: 12px;"><textarea onchange="updateReferralRow(${index}, 'notes', this.value)" placeholder="Follow-up notes" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; min-height: 35px; resize: vertical; font-size: 11px;">${ref.notes || ''}</textarea></td>
            <td style="padding: 12px; text-align: center;">
                <button onclick="deleteReferral(${index})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
};

// Update referral row
window.updateReferralRow = function(index, field, value) {
    if (!referralsData[index]) return;
    referralsData[index][field] = value;
    saveReferralsData();
    renderReferralsTable();
};

// Add new referral
window.addNewReferral = function() {
    referralsData.unshift({
        name: '',
        phone: '',
        propertiesViewed: '',
        interestedIn: '',
        lastContact: new Date().toISOString().split('T')[0],
        status: 'Active',
        notes: ''
    });
    saveReferralsData();
    renderReferralsTable();
};

// Import from pipeline - pull viewing data into referrals
window.addReferralFromPipeline = function() {
    const pipeline = loadPipelineData();
    const signedUp = pipeline.filter(v => v.status === 'Signed Up' || v.status === 'Pending');
    
    if (signedUp.length === 0) {
        alert('No signed up or pending viewings to import');
        return;
    }
    
    signedUp.forEach(viewing => {
        // Check if already exists
        const exists = referralsData.some(r => r.phone === viewing.phone);
        if (!exists) {
            referralsData.push({
                name: viewing.visitor || '',
                phone: viewing.phone || '',
                propertiesViewed: viewing.property || '',
                interestedIn: viewing.property || '',
                lastContact: viewing.date || new Date().toISOString().split('T')[0],
                status: viewing.status === 'Signed Up' ? 'Converted' : 'Active',
                notes: viewing.notes || ''
            });
        }
    });
    
    saveReferralsData();
    renderReferralsTable();
    showToast('Imported!', `Added ${signedUp.length} referrals from pipeline`);
};

// Delete referral
window.deleteReferral = function(index) {
    if (confirm('Delete this referral?')) {
        referralsData.splice(index, 1);
        saveReferralsData();
        renderReferralsTable();
    }
};

// Update metrics
window.updateReferralsMetrics = function() {
    const data = loadReferralsData();
    const total = data.length;
    const converted = data.filter(r => r.status === 'Converted').length;
    const active = data.filter(r => r.status === 'Active').length;
    const uniqueProperties = new Set(data.map(r => r.propertiesViewed).filter(p => p)).size;
    
    document.getElementById('referrals-total').textContent = total;
    document.getElementById('referrals-converted').textContent = converted;
    document.getElementById('referrals-active').textContent = active;
    document.getElementById('referrals-properties').textContent = uniqueProperties;
};

// Export to CSV
window.exportReferralsCSV = function() {
    const data = loadReferralsData();
    if (data.length === 0) {
        alert('No referrals to export');
        return;
    }
    
    const headers = ['Name', 'Phone', 'Properties Viewed', 'Interested In', 'Last Contact', 'Status', 'Notes'];
    const rows = data.map(r => [
        r.name || '',
        r.phone || '',
        r.propertiesViewed || '',
        r.interestedIn || '',
        r.lastContact || '',
        r.status || '',
        r.notes || ''
    ]);
    
    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(cell => '"' + (cell || '').replace(/"/g, '""') + '"').join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'referrals-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
};

// Initialize referrals on load
referralsData = loadReferralsData();
// ==================== END REFERRALS TRACKER ====================

// ==================== GLOBAL SEARCH FUNCTION ====================
function handleGlobalSearch() {
    const searchInput = document.getElementById('global-search');
    if (!searchInput) return;
    
    const query = searchInput.value.toLowerCase().trim();
    
    // If empty, show all properties
    if (!query) {
        if (typeof renderProperties === 'function') renderProperties(properties);
        if (typeof renderPropertiesList === 'function') renderPropertiesList();
        if (typeof renderPropertiesBrowseList === 'function') renderPropertiesBrowseList();
        updateMapMarkers(properties);
        return;
    }
    
    // Search through properties
    const filtered = properties.filter(property => {
        return (
            property.address.toLowerCase().includes(query) ||
            property.borough.toLowerCase().includes(query) ||
            property.postcode && property.postcode.toLowerCase().includes(query) ||
            (property.bedrooms && property.bedrooms.toString().includes(query)) ||
            (property.name && property.name.toLowerCase().includes(query))
        );
    });
    
    if (typeof renderProperties === 'function') renderProperties(filtered);
    if (typeof renderPropertiesList === 'function') renderPropertiesList(filtered);
    if (typeof renderPropertiesBrowseList === 'function') renderPropertiesBrowseList(filtered);
    updateMapMarkers(filtered);
    
    // Show toast with results
    if (filtered.length === 0) {
        showToast('No Results', 'No properties match your search');
    } else {
        showToast('Search Results', `Found ${filtered.length} properties`);
    }
}

// Add event listener for search input
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('global-search');
    if (searchInput) {
        searchInput.addEventListener('input', handleGlobalSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleGlobalSearch();
            }
        });
    }
});
// ==================== END GLOBAL SEARCH ====================

// ==================== BOROUGH ZOOM FUNCTION ====================
function zoomToBorough(borough) {
    if (!map) return;
    
    // Filter properties for this borough
    const boroughProperties = properties.filter(p => p.borough === borough);
    
    if (boroughProperties.length === 0) {
        showToast('No Properties', `No properties found in ${borough}`);
        return;
    }
    
    // Get all coordinates for this borough
    const coords = boroughProperties
        .filter(p => p.lat && p.lng)
        .map(p => [p.lat, p.lng]);
    
    if (coords.length === 0) return;
    
    // Fit map to show all properties in borough
    const bounds = L.latLngBounds(coords);
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
    
    // Highlight markers for this borough
    updateMapMarkers(boroughProperties);
    
    showToast('Borough View', `Showing ${boroughProperties.length} properties in ${borough}`);
}
// ==================== END BOROUGH ZOOM ====================

// ==================== UPDATE MAP MARKERS FUNCTION ====================
// DISABLED - Using main renderMarkers() instead to avoid conflicts
function updateMapMarkers(propertiesToShow = null) {
    // This function disabled to prevent t.addLayer errors
    // The main renderMarkers() function handles all map updates
    console.log('[MAP] updateMapMarkers called but disabled - using renderMarkers instead');
    if (typeof renderMarkers === 'function') {
        renderMarkers();
    }
}
// ==================== END UPDATE MAP MARKERS ====================

// ==================== ESC KEY HANDLER ====================
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Close all modals
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.style.display = 'none';
            modal.classList.remove('show');
        });
    }
});
// ==================== END ESC KEY HANDLER ====================

// ==================== MODAL BACKDROP CLICK HANDLERS ====================
window.addEventListener('DOMContentLoaded', function() {
    // Property modal backdrop
    const propertyModal = document.getElementById('property-modal');
    if (propertyModal) {
        propertyModal.addEventListener('click', function(e) {
            if (e.target === propertyModal) {
                closePropertyModal();
            }
        });
    }
    
    // Staff modal backdrop
    const staffModal = document.getElementById('staff-modal');
    if (staffModal) {
        staffModal.addEventListener('click', function(e) {
            if (e.target === staffModal) {
                closeStaffModal();
            }
        });
    }
    
    // Edit modal backdrop
    const editModal = document.getElementById('edit-modal');
    if (editModal) {
        editModal.addEventListener('click', function(e) {
            if (e.target === editModal) {
                closeEditModal();
            }
        });
    }
});
// ==================== END MODAL BACKDROP CLICK HANDLERS ====================

// ==================== SLIDE PANEL MODAL SYSTEM ====================
// Clone sidebar content into modal panels on page load
let menuPanelInitialized = false;
let clientsPanelInitialized = false;

function initializeModalPanels() {
    // Clone left sidebar content to menu panel
    const leftSidebar = document.getElementById('left-sidebar');
    const menuPanelContent = document.getElementById('menu-panel-content');
    
    if (leftSidebar && menuPanelContent && !menuPanelInitialized) {
        // Clone inner content (skip resize handle)
        const sidebarTabs = leftSidebar.querySelector('.sidebar-tabs');
        const sidebarContent = leftSidebar.querySelector('.sidebar-content');
        
        if (sidebarTabs) {
            menuPanelContent.appendChild(sidebarTabs.cloneNode(true));
        }
        if (sidebarContent) {
            menuPanelContent.appendChild(sidebarContent.cloneNode(true));
        }
        menuPanelInitialized = true;
        console.log('[MODAL] Menu panel initialized');
    }
    
    // Clone right sidebar content to clients panel
    const rightSidebar = document.getElementById('right-sidebar');
    const clientsPanelContent = document.getElementById('clients-panel-content');
    
    if (rightSidebar && clientsPanelContent && !clientsPanelInitialized) {
        // Clone inner content (skip resize handle and resize toggle)
        const sidebarHeader = rightSidebar.querySelector('.sidebar-header');
        const allTabContents = rightSidebar.querySelectorAll('.tab-content');
        
        if (sidebarHeader) {
            // Clone header but remove the h2 (we have our own)
            const headerClone = sidebarHeader.cloneNode(true);
            const h2 = headerClone.querySelector('h2');
            if (h2) h2.remove();
            // Remove padding-top style
            headerClone.style.paddingTop = '15px';
            clientsPanelContent.appendChild(headerClone);
        }
        
        allTabContents.forEach(tab => {
            clientsPanelContent.appendChild(tab.cloneNode(true));
        });
        clientsPanelInitialized = true;
        console.log('[MODAL] Clients panel initialized');
    }
}

// Toggle panel expanded size
window.togglePanelSize = function(panelId) {
    const panel = document.getElementById(panelId);
    const icon = document.getElementById(panelId + '-expand-icon');
    
    if (panel) {
        panel.classList.toggle('expanded');
        
        if (icon) {
            if (panel.classList.contains('expanded')) {
                icon.className = 'fas fa-compress-alt';
            } else {
                icon.className = 'fas fa-expand-alt';
            }
        }
    }
};

// Open Menu Panel
window.openMenuPanel = function() {
    initializeModalPanels();
    
    const overlay = document.getElementById('panel-overlay');
    const menuPanel = document.getElementById('menu-panel');
    
    overlay.classList.add('active');
    menuPanel.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Re-bind event handlers for cloned content
    rebindMenuPanelEvents();
};

// Close Menu Panel
window.closeMenuPanel = function() {
    const overlay = document.getElementById('panel-overlay');
    const menuPanel = document.getElementById('menu-panel');
    
    overlay.classList.remove('active');
    menuPanel.classList.remove('active');
    document.body.style.overflow = '';
};

// Open Clients Panel
window.openClientsPanel = function() {
    initializeModalPanels();
    
    const overlay = document.getElementById('panel-overlay');
    const clientsPanel = document.getElementById('clients-panel');
    
    overlay.classList.add('active');
    clientsPanel.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Re-bind event handlers for cloned content
    rebindClientsPanelEvents();
};

// Close Clients Panel
window.closeClientsPanel = function() {
    const overlay = document.getElementById('panel-overlay');
    const clientsPanel = document.getElementById('clients-panel');
    
    overlay.classList.remove('active');
    clientsPanel.classList.remove('active');
    document.body.style.overflow = '';
};

// Close All Panels
window.closeAllPanels = function() {
    closeMenuPanel();
    closeClientsPanel();
};

// Re-bind event handlers for Menu Panel (cloned content)
function rebindMenuPanelEvents() {
    const menuPanel = document.getElementById('menu-panel-content');
    if (!menuPanel) return;
    
    // Re-bind sidebar tab buttons
    const tabBtns = menuPanel.querySelectorAll('.sidebar-tab');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            if (tab) {
                // Update active states within modal
                menuPanel.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                menuPanel.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                const targetPane = menuPanel.querySelector(`#tab-${tab}`);
                if (targetPane) targetPane.classList.add('active');
            }
        });
    });
}

// Re-bind event handlers for Clients Panel (cloned content)
function rebindClientsPanelEvents() {
    const clientsPanel = document.getElementById('clients-panel-content');
    if (!clientsPanel) return;
    
    // Re-bind tab buttons
    const tabBtns = clientsPanel.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Get the tab name from onclick attribute or inner text
            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {
                const match = onclickAttr.match(/switchTab\(['"](\w+)['"]\)/);
                if (match) {
                    const tabName = match[1];
                    
                    // Update active states within modal
                    clientsPanel.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    clientsPanel.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    const targetContent = clientsPanel.querySelector(`#${tabName}-tab`);
                    if (targetContent) targetContent.classList.add('active');
                }
            }
        });
    });
}

// Update ESC key handler to close panels
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAllPanels();
    }
});

// Initialize panels on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Pre-initialize after a short delay to ensure content is ready
    setTimeout(initializeModalPanels, 500);
});
// ==================== END SLIDE PANEL MODAL SYSTEM ====================

</script>
</div> <!-- Close main-container -->
</body>
</html>
